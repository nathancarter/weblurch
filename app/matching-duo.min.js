(function(){var n,e,t,r,i,u,s,o,a,l,c,f,p,h,d,g,y,v,x,b,m,w,q,S,I,k,N,E,A,O,F,M,V,J,W,C,D,P,j,R,B,T,L,U,$=[].slice,z=[].indexOf||function(n){for(var e=0,t=this.length;t>e;e++)if(e in this&&this[e]===n)return e;return-1};("undefined"==typeof y||null===y)&&(y=null!=(L="undefined"!=typeof module&&null!==module?module.exports:void 0)?L:window),"undefined"!=typeof require&&null!==require&&(U=require("./openmath-duo"),u=U.OM,s=U.OMNode),O=u.symbol("metavariable","lurch"),T=u.string("true"),y.setMetavariable=j=function(n){var e;if(n instanceof s&&("v"===(e=n.type)||"sy"===e))return n.setAttribute(O,T.copy())},y.clearMetavariable=f=function(n){return n.removeAttribute(O)},y.isMetavariable=I=function(n){var e,t;return n instanceof s&&("v"===(e=n.type)||"sy"===e)&&(null!=(t=n.getAttribute(O))?t.equals(T):void 0)},x=u.symbol("EF","lurch"),b=u.symbol("EFA","lurch"),y.makeExpressionFunction=k=function(n){return function(n,e){if("v"!==n.type)throw"When creating an expression function, its parameter must be a variable";return u.bin(x,n,e)}}(this),y.isExpressionFunction=q=function(n){return function(n){return"bi"===n.type&&1===n.variables.length&&n.symbol.equals(x)}}(this),y.makeExpressionFunctionApplication=N=function(n){return function(n,e){return u.app(b,n,e)}}(this),y.isExpressionFunctionApplication=S=function(n){return function(n){return"a"===n.type&&3===n.children.length&&n.children[0].equals(b)}}(this),y.applyExpressionFunction=a=function(n,e){var t;return t=n.body.copy(),t.replaceFree(n.variables[0],e),t},y.alphaEquivalent=o=function(n,e){var t,r,i,s,o,l;for(i=0,o=function(){return u["var"]("v"+i)},s=function(n){return n.equals(o())},l=u.app(n,e);l.hasDescendantSatisfying(s);)i++;return t=a(n,o()),r=a(e,o()),q(n)&&q(e)&&t.equals(r)},y.consistentPatterns=d=function(){var n,e,t,r,i,u,s,o,a,l,c,f,p,h;for(i=1<=arguments.length?$.call(arguments,0):[],t=[],e=[],u=0,o=i.length;o>u;u++)for(r=i[u],l=r.descendantsSatisfying(I),s=0,a=l.length;a>s;s++)if(n=l[s],S(n.parent)&&"c1"===n.findInParent()){if(c=n.name,z.call(t,c)>=0)return!1;f=n.name,z.call(e,f)<0&&e.push(n.name)}else{if(p=n.name,z.call(e,p)>=0)return!1;h=n.name,z.call(t,h)<0&&t.push(n.name)}return!0},y.Constraint=r=function(){function n(n,e){this.pattern=n,this.expression=e}return n.prototype.copy=function(){return new r(this.pattern.copy(),this.expression.copy())},n.prototype.equals=function(n){return this.pattern.equals(n.pattern,!1)&&this.expression.equals(n.expression,!1)},n}(),y.ConstraintList=i=function(){function n(){var n,e,t,r,i,u,s,o,a,l,c,f,p,h;for(t=1<=arguments.length?$.call(arguments,0):[],this.contents=t,this.nextNewVariableIndex=0,n=function(n){return function(e){return/^v[0-9]+$/.test(e.name)?n.nextNewVariableIndex=Math.max(n.nextNewVariableIndex,parseInt(e.name.slice(1))+1):void 0}}(this),i=function(n){return n.descendantsSatisfying(function(n){return"v"===n.type})},f=this.contents,u=0,a=f.length;a>u;u++){for(e=f[u],p=i(e.pattern),s=0,l=p.length;l>s;s++)r=p[s],n(r);for(h=i(e.expression),o=0,c=h.length;c>o;o++)r=h[o],n(r)}}return n.prototype.nextNewVariable=function(){return u.simple("v"+this.nextNewVariableIndex++)},n.prototype.length=function(){return this.contents.length},n.prototype.copy=function(){var n,e;return e=function(n,e,t){t.prototype=n.prototype;var r=new t,i=n.apply(r,e);return Object(i)===i?i:r}(i,function(){var e,t,r,i;for(r=this.contents,i=[],e=0,t=r.length;t>e;e++)n=r[e],i.push(n.copy());return i}.call(this),function(){}),e.nextNewVariableIndex=this.nextNewVariableIndex,e},n.prototype.indexAtWhich=function(n){var e,t,r,i,u;for(u=this.contents,t=r=0,i=u.length;i>r;t=++r)if(e=u[t],n(e))return t;return-1},n.prototype.plus=function(){var n,e,t,r,i,u;for(e=1<=arguments.length?$.call(arguments,0):[],r=this.copy(),i=0,u=e.length;u>i;i++)n=e[i],t=r.indexAtWhich(function(e){return e.equals(n,!1)}),-1===t&&r.contents.push(n);return r},n.prototype.minus=function(){var n,e,t,r,i,u;for(e=1<=arguments.length?$.call(arguments,0):[],r=this.copy(),i=0,u=e.length;u>i;i++)n=e[i],t=r.indexAtWhich(function(e){return e.equals(n,!1)}),t>-1&&r.contents.splice(t,1);return r},n.prototype.firstSatisfying=function(n){var e;return null!=(e=this.contents[this.indexAtWhich(n)])?e:null},n.prototype.firstPairSatisfying=function(n){var e,t,r,i,u,s,o,a,l,c;for(l=this.contents,r=u=0,o=l.length;o>u;r=++u)for(e=l[r],c=this.contents,i=s=0,a=c.length;a>s;i=++s)if(t=c[i],r!==i&&n(e,t))return[e,t];return null},n.prototype.isFunction=function(){var n,e,t,r,i,u;for(e=[],i=this.contents,t=0,r=i.length;r>t;t++){if(n=i[t],!I(n.pattern))return!1;if(u=n.pattern.name,z.call(e,u)>=0)return!1;e.push(n.pattern.name)}return!0},n.prototype.lookup=function(n){var e,t,r,i;for(n instanceof u||(n=u["var"](n)),j(n),i=this.contents,t=0,r=i.length;r>t;t++)if(e=i[t],e.pattern.equals(n,!1))return e.expression;return null},n.prototype.apply=function(n){var e,t,r,i,u,s;for(r=n.copy(),t=r.descendantsSatisfying(I),u=0,s=t.length;s>u;u++)e=t[u],null!=(i=this.lookup(e))&&e.replaceWith(i);return r},n.prototype.equals=function(n){var e,t,r,i,u,s,o;for(s=this.contents,t=0,i=s.length;i>t;t++)if(e=s[t],!n.firstSatisfying(function(n){return n.equals(e)}))return!1;for(o=n.contents,r=0,u=o.length;u>r;r++)if(e=o[r],!this.firstSatisfying(function(n){return n.equals(e)}))return!1;return!0},n}(),y.findDifferencesBetween=w=function(n,e){var t,r;return t=[],r=function(e,i){var u,s,o,a,l,c,f;if(e.type!==i.type)return t.push(e.address(n));if("bi"===e.type?(u=[e.symbol].concat($.call(e.variables),[e.body]),s=[i.symbol].concat($.call(i.variables),[i.body])):(u=e.children,s=i.children),u.length!==s.length||u.length+s.length===0&&!e.equals(i,!1))return t.push(e.address(n));for(f=[],a=l=0,c=u.length;c>l;a=++l)o=u[a],f.push(r(o,s[a]));return f},r(n,e),t},y.parentAddresses=V=function(n){var e,t,r,i,u,s,o,a;for(t=[],i=0,s=n.length;s>i;i++)e=n[i],0!==e.length&&(r=JSON.stringify(e.slice(0,-1)),z.call(t,r)<0&&t.push(r));if(0===t.length)return null;for(a=[],u=0,o=t.length;o>u;u++)e=t[u],a.push(JSON.parse(e));return a},y.partitionedAddresses=J=function(n){var e,t;return e=[],t=function(r){var i,u,s,o,a,l,c,f,p;for(u=!1,o=0,l=e.length;l>o;o++)if(s=e[o],r.equals(s.subexpression,!1)){s.addresses.push(r.address(n)),u=!0;break}for(u||e.push({subexpression:r,addresses:[r.address(n)]}),f=r.children,p=[],a=0,c=f.length;c>a;a++)i=f[a],p.push(t(i));return p},t(n),e},y.expressionDepth=v=function(n){var e,t;return t=$.call(n.children).concat($.call(n.variables)),n.body&&t.push(n.body),n.symbol&&t.push(n.symbol),1+Math.max.apply(Math,[0].concat($.call(function(){var n,r,i;for(i=[],n=0,r=t.length;r>n;n++)e=t[n],i.push(v(e));return i}())))},y.sameDepthAncestors=C=function(n,e){var t,r,i,u,s,o,a,l,c,f,p,h,d,g,y,x,b,m,w,q,S,I;for(l=h=0,x=e.length;x>h;l=++h)for(r=e[l],s=v(n.index(r)),c=d=0,b=e.length;b>d;c=++d)if(i=e[c],o=v(n.index(i)),s!==o)return s>o&&(q=[i,r],r=q[0],i=q[1],S=[c,l],l=S[0],c=S[1]),u=r.slice(0,-1),a=e.slice(0),a[l]=r.slice(0,-1),C(n,a);for(f=[],g=0,m=e.length;m>g;g++)t=e[g],p=JSON.stringify(t),z.call(f,p)<0&&f.push(p);for(I=[],y=0,w=f.length;w>y;y++)p=f[y],I.push(JSON.parse(p));return I},y.differenceIterator=g=function(n,e){var t,r;return r=C(n,w(n,e)),t=function(t){var r,i,u,s,o,a;for(u=0,o=t.length;o>u;u++)for(r=t[u],s=0,a=t.length;a>s;s++){if(i=t[s],!n.index(r).equals(n.index(i),!1))return!1;if(!e.index(r).equals(e.index(i),!1))return!1}return!0},function(){for(var e,i;null!=r&&!t(r);)e=V(r),r=e&&C(n,e);return i=r,null!==i&&(e=V(r),r=e&&C(n,e)),i}},y.subexpressionIterator=R=function(n){var e,t,r;return t=J(n),r={next:t.shift(),rest:t,subsetIndex:1},e=function(){var t,i,u;return E("		subexpression iterator for",n.simpleEncode(),"next:",JSON.stringify(r.next.addresses),"rest:",JSON.stringify(function(){var n,e,t,i;for(t=r.rest,i=[],n=0,e=t.length;e>n;n++)u=t[n],i.push(u.addresses);return i}()),"subsetIndex:",r.subsetIndex),r.subsetIndex<Math.pow(2,r.next.addresses.length)?(i=function(){var n,e,i;for(i=[],t=n=0,e=r.next.addresses.length;e>=0?e>n:n>e;t=e>=0?++n:--n)0<(r.subsetIndex&Math.pow(2,t))&&i.push(r.next.addresses[t]);return i}(),r.subsetIndex++,i):r.rest.length>0?(r.next=r.rest.shift(),r.subsetIndex=1,e()):null}},y.prefixIterator=W=function(n,e){var t;return t=!1,function(){return t?e():(t=!0,n)}},y.suffixIterator=B=function(n,e){var t;return t=!1,function(){var r;return r=n(),null!==r||t||(r=e,t=!0),r}},y.composeIterator=p=function(n,e){return function(){var t;return(t=n())?e(t):null}},y.filterIterator=m=function(n,e){return function(){var t;for(t=n();t&&!e(t);)t=n();return t}},y.concatenateIterators=h=function(n,e){return function(){return n()||e()}},y.multiReplace=F=function(n,e,t){var r,i,u,s,o;for(i=n.copy(),u=0,s=e.length;s>u;u++)r=e[u],null!=(o=i.index(r))&&o.replaceWith(t.copy());return i},y.bindingConstraints1=l=function(n){var e,t,u,s,o,a,l,c,f,p,h,d,g,y,v,x;for(a=new i,u=function(n){return"bi"===n.type},y=n.descendantsSatisfying(u),c=0,h=y.length;h>c;c++)for(t=y[c],v=t.descendantsSatisfying(I),f=0,d=v.length;d>f;f++)if(s=v[f],s.isFree(t))for(x=t.variables,p=0,g=x.length;g>p;p++)l=x[p],I(l)&&(o=new r(l,s),e=function(n){return n.equals(o)},a.firstSatisfying(e)||a.contents.push(o));return a},y.satisfiesBindingConstraints1=D=function(n,e){var t,r,i,u,s,o;for(o=e.contents,u=0,s=o.length;s>u;u++)if(t=o[u],i=n.lookup(t.pattern),r=n.lookup(t.expression).copy(),r.occursFree(i))return!1;return!0},y.bindingConstraints2=c=function(n){var e,t,u,s,o,a;for(u=new i,a=n.descendantsSatisfying(S),s=0,o=a.length;o>s;s++)e=a[s],I(e.children[1])&&(t=function(n,e,t){t.prototype=n.prototype;var r=new t,i=n.apply(r,e);return Object(i)===i?i:r}(r,e.children.slice(1,3),function(){}),u.firstSatisfying(function(n){return n.equals(t)})||u.contents.push(t));return u},y.satisfiesBindingConstraints2=P=function(n,t){var r,i,u,s,o,a,l,c,f,p,h;for(p=t.contents,a=0,c=p.length;c>a;a++)for(u=p[a],s=n.lookup(u.pattern),null==s&&E(e(n),e(t)),r=n.apply(u.expression),i=function(n){return n.equals(s.variables[0])},h=s.body.descendantsSatisfying(i),l=0,f=h.length;f>l;l++)if(o=h[l],!r.isFreeToReplace(o,s.body))return!1;return!0},t=function(n){return"("+n.pattern.simpleEncode()+","+n.expression.simpleEncode()+")"},e=function(n){var e;return null===n?null:"{ "+function(){var r,i,u,s;for(u=n.contents,s=[],r=0,i=u.length;i>r;r++)e=u[r],s.push(t(e));return s}().join(", ")+" }"},n=function(n){var t;return null===n?null:"[\n"+function(){var r,i,u;for(u=[],r=0,i=n.length;i>r;r++)t=n[r],u.push("	"+e(t));return u}().join("\n")+"\n]"},A=!1,y.setMatchDebug=function(n){return A=n},E=function(){var n;return n=1<=arguments.length?$.call(arguments,0):[],A?console.log.apply(console,n):void 0},y.nextMatch=M=function(n,u,s){var l,c,f,d,y,v,x,b,w,q,N,A,O,V,J,W,C,D,P,j,T,L,U,z,G,H,K,Q,X,Y,Z;if(null==u&&(u=new i),null==s&&(s=null),n instanceof r&&(n=new i(n)),!(n instanceof i))throw"Invalid first parameter, not a constraint list";if(E("\nmatchDebug",e(n),e(u),null!=s?"  ...ITERATOR...":""),null==s){if(0===n.length())return E("	base case, returning:",e(u)),[u,null];if(b=n.firstSatisfying(function(n){return 0===n.pattern.children.length&&0===n.pattern.variables.length&&!I(n.pattern)}),null!=b)return b.pattern.equals(b.expression,!1)?(E("	atomic case, recur:",t(b)),M(n.minus(b),u,s)):(E("	atomic case, return null for",t(b)),[null,null]);if(z=function(n){return"bi"===n.type?[n.symbol].concat($.call(n.variables),[n.body]):n.children},b=n.firstSatisfying(function(n){return z(n.pattern).length>0&&!S(n.pattern)}),null!=b)return l=b.pattern,c=b.expression,l.type!==c.type?(E("	non-atomic case, type fail:",t(b)),[null,null]):(O=z(l),G=z(c),O.length!==G.length?(E("	non-atomic case, #children fail:",t(b)),[null,null]):(n=(Y=n.minus(b)).plus.apply(Y,function(){var n,e,t;for(t=[],A=n=0,e=O.length;e>n;A=++n)x=O[A],t.push(new r(x,G[A]));return t}()),E("	non-atomic case, recur:",t(b)),M(n,u,s)));if(b=n.firstSatisfying(function(n){return I(n.pattern)}),null!=b){if(f=u.lookup(b.pattern)){if(!b.expression.equals(f,!1))return E("	metavariable case, mismatch:",t(b)),[null,null];E("	metavariable case, already set:",t(b))}else E("	metavariable case, assigning:",t(b)),u=u.plus(b.copy());return M(n.minus(b),u,s)}if(U=n.firstPairSatisfying(function(n,e){return S(n.pattern)&&S(e.pattern)&&n.pattern.children[1].equals(e.pattern.children[1],!1)&&!n.expression.equals(e.expression,!1)}),null!=U)return y=U[0],v=U[1],H=n.minus(y,v),W=y.pattern.children[1],Q=y.pattern.children[2],X=v.pattern.children[2],q=y.expression,N=v.expression,J=function(e){var t;return t=n.nextNewVariable(),k(t,F(q,e,t))},s=g(q,N),s=m(s,function(n){var e;return e=u.lookup(W),null==e||o(e,J(n))}),s=p(s,function(n){var e;return e=u.lookup(W)?u.copy():u.plus(new r(W,J(n))),[H.plus(new r(Q,q.index(n[0])),new r(X,N.index(n[0]))),e,null]}),E("	efa case 1 of 2, iterating:",t(y),t(v)),M(H,u,s);if(U=n.firstPairSatisfying(function(n,e){return S(n.pattern)&&S(e.pattern)&&n.pattern.children[1].equals(e.pattern.children[1],!1)&&n.expression.equals(e.expression,!1)}),null!=U)return y=U[0],v=U[1],H=n.minus(y,v),W=y.pattern.children[1],Q=y.pattern.children[2],X=v.pattern.children[2],w=y.expression,J=function(e){var t;return t=n.nextNewVariable(),k(t,F(w,e,t))},s=R(w),s=m(s,function(n){var e;return e=u.lookup(W),null==e||o(e,J(n))}),s=B(s,[]),s=p(s,function(n){var e,t,i,s;if(i=J(n),s=u.lookup(W)){if(!o(s,i))return null;e=u.copy()}else e=u.plus(new r(W,i));return t=H,0!==n.length&&(t=t.plus(new r(Q,w.index(n[0])),new r(X,w.index(n[0])))),[t,e,null]}),E("	efa case 2 of 2, iterating:",t(y),t(v)),M(H,u,s);if(b=n.contents[0],!S(b.pattern))throw Error("Invalid assumption in final case of matching");return H=n.minus(b),W=b.pattern.children[1],K=b.pattern.children[2],w=b.expression,(V=u.lookup(W))?(d=a(V,K),E("	final case, applying known metavariable:",t(b)),M(H.plus(new r(V,w)),u,s)):(J=function(e){var t;return t=n.nextNewVariable(),k(t,F(w,e,t))},s=R(w),s=m(s,function(n){return V=u.lookup(W),null==V||o(V,J(n))}),s=B(s,[]),s=p(s,function(n){var t,i,s,a;if(E("		next subexpression, with subset",JSON.stringify(n),"solution",e(u),"constraints",e(H),"t",K.simpleEncode(),"e",w.simpleEncode(),"metavariable",W.simpleEncode()),s=J(n),a=u.lookup(W)){if(!o(a,s))return null;t=u.copy()}else t=u.plus(new r(W,s));return i=H,0!==n.length&&(i=i.plus(new r(K,w.index(n[0])))),[i,t,null]}),E("	final case, iterating:",t(b)),M(H,u,s))}return C=s(),null===C?(E("	iterator case, next is null, done!"),[null,null]):(P=C[0],L=C[1],j=C[2],E("	iterator case, using iterator.next():",e(P),e(L),null!=j,"\n--->"),Z=M(P,L,j),T=Z[0],D=Z[1],null==T?(E("\n<---\n	after iterator recursion, no result; keep iterating..."),M(n,u,s)):null==D?(E("\n<---\n	after iterator recursion, got a unique solution:",e(T)),[T,[n,u,s]]):(E("\n<---\n	after iterator recursion, got a(nother?) solution:",e(T),"PLUS nextArguments",e(D[0]),e(D[1]),null!=D[2]),D[2]=h(D[2],s),[T,D]))}}).call(this);
//# sourceMappingURL=matching-duo.min.js.map