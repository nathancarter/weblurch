(function(){var BackgroundFunction,CLSetToString,CLToString,CToString,Constraint,ConstraintList,Grammar,Match,OM,OMNode,Tokenizer,addToCache,allBinaryFunctions,alphaEquivalent,applyExpressionFunction,bindingConstraints1,bindingConstraints2,cacheLookup,clearMetavariable,composeIterator,concatenateIterators,consistentPatterns,copyState,debugNestedArrays,debugState,differenceIterator,drawHTMLCache,equalArrays,exports,expressionDepth,expressionFunction,expressionFunctionApplication,filterIterator,findDifferencesBetween,getNext,isExpressionFunction,isExpressionFunctionApplication,isMetavariable,makeExpressionFunction,makeExpressionFunctionApplication,markUsed,matchDebug,matchDebugOn,merge,metavariableSymbol,multiReplace,newVariableNotIn,nextMatch,parentAddresses,partitionedAddresses,prefixIterator,pruneCache,sameDepthAncestors,satisfiesBindingConstraints1,satisfiesBindingConstraints2,setMetavariable,subexpressionIterator,suffixIterator,trueValue,udebug,unify,violatesCaptureConstraints,_ref,_ref1,_ref2,_ref3,_ref4,_ref5,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__slice=[].slice,__indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};JSON.equals=function(e,t){var n,r,i,s,o;if(e instanceof Object!=t instanceof Object)return!1;if(e instanceof Array!=t instanceof Array)return!1;if(!(e instanceof Object))return e===t;if(r=Object.keys(e).sort(),i=Object.keys(t).sort(),JSON.stringify(r)!==JSON.stringify(i))return!1;for(s=0,o=r.length;o>s;s++)if(n=r[s],!JSON.equals(e[n],t[n]))return!1;return!0},("undefined"==typeof exports||null===exports)&&(exports=null!=(_ref="undefined"!=typeof module&&null!==module?module.exports:void 0)?_ref:window),exports.OMNode=exports.OM=OM=OMNode=function(){function e(t){this.tree=t,this.hasDescendantSatisfying=__bind(this.hasDescendantSatisfying,this),this.descendantsSatisfying=__bind(this.descendantsSatisfying,this),this.childrenSatisfying=__bind(this.childrenSatisfying,this),this.replaceFree=__bind(this.replaceFree,this),this.isFreeToReplace=__bind(this.isFreeToReplace,this),this.occursFree=__bind(this.occursFree,this),this.isFree=__bind(this.isFree,this),this.freeVariables=__bind(this.freeVariables,this),this.setAttribute=__bind(this.setAttribute,this),this.removeAttribute=__bind(this.removeAttribute,this),this.getAttribute=__bind(this.getAttribute,this),this.replaceWith=__bind(this.replaceWith,this),this.remove=__bind(this.remove,this),this.index=__bind(this.index,this),this.address=__bind(this.address,this),this.findChild=__bind(this.findChild,this),this.findInParent=__bind(this.findInParent,this),this.simpleEncode=__bind(this.simpleEncode,this),this.copy=__bind(this.copy,this),this.sameObjectAs=__bind(this.sameObjectAs,this),this.equals=__bind(this.equals,this),this.encode=__bind(this.encode,this),Object.defineProperty(this,"parent",{get:function(){return this.tree.p?new e(this.tree.p):void 0}}),Object.defineProperty(this,"type",{get:function(){return this.tree.t}}),Object.defineProperty(this,"value",{get:function(){return"bi"!==this.tree.t?this.tree.v:void 0}}),Object.defineProperty(this,"name",{get:function(){return this.tree.n}}),Object.defineProperty(this,"cd",{get:function(){return this.tree.cd}}),Object.defineProperty(this,"uri",{get:function(){return this.tree.uri}}),Object.defineProperty(this,"symbol",{get:function(){return this.tree.s?new e(this.tree.s):void 0}}),Object.defineProperty(this,"body",{get:function(){return this.tree.b?new e(this.tree.b):void 0}}),Object.defineProperty(this,"children",{get:function(){var t,n,r,i,s,o;for(s=null!=(i=this.tree.c)?i:[],o=[],n=0,r=s.length;r>n;n++)t=s[n],o.push(new e(t));return o}}),Object.defineProperty(this,"variables",{get:function(){var t,n,r,i,s;if("bi"===this.tree.t){for(i=this.tree.v,s=[],n=0,r=i.length;r>n;n++)t=i[n],s.push(new e(t));return s}return[]}})}var t;return e.checkJSON=function(e){var t,n,r,i,s,o,a,u,l,c,p,h,f,d,g,b,m,y,v;if(!(e instanceof Object))return"Expected an object, found "+typeof e;if(e.hasOwnProperty("a")){b=e.a;for(s in b)if(__hasProp.call(b,s)){u=b[s];try{a=JSON.parse(s)}catch(x){return r=x,"Key "+s+" invalid JSON"}if("sy"!==a.t)return"Key "+s+" is not a symbol";if(o=this.checkJSON(a))return o;if(o=this.checkJSON(u))return o}}switch(t=function(){var t,n,r,i;for(t=1<=arguments.length?__slice.call(arguments,0):[],i=Object.keys(e),n=0,r=i.length;r>n;n++)if(s=i[n],__indexOf.call(t,s)<0&&"t"!==s&&"a"!==s)return"Key "+s+" not valid in object of type "+e.t;return null},i=/^[:A-Za-z_\u0374-\u03FF][:A-Za-z_\u0374-\u03FF.0-9-]*$/,e.t){case"i":if(o=t("v"))return o;if(!/^[+-]?[0-9]+$/.test(""+e.v))return"Not an integer: "+e.v;break;case"f":if(o=t("v"))return o;if("number"!=typeof e.v)return"Not a number: "+e.v+" of type "+typeof e.v;if(isNaN(e.v))return"OpenMath floats cannot be NaN";if(!isFinite(e.v))return"OpenMath floats must be finite";break;case"st":if(o=t("v"))return o;if("string"!=typeof e.v)return"Value for st type was "+typeof e.v+", not string";break;case"ba":if(o=t("v"))return o;if(!(e.v instanceof Uint8Array))return"Value for ba type was not an instance of Uint8Array";break;case"sy":if(o=t("n","cd","uri"))return o;if("string"!=typeof e.n)return"Name for sy type was "+typeof e.n+", not string";if("string"!=typeof e.cd)return"CD for sy type was "+typeof e.cd+", not string";if(null!=e.uri&&"string"!=typeof e.uri)return"URI for sy type was "+typeof e.uri+", not string";if(!i.test(e.n))return"Invalid identifier as symbol name: "+e.n;if(!i.test(e.cd))return"Invalid identifier as symbol CD: "+e.cd;break;case"v":if(o=t("n"))return o;if("string"!=typeof e.n)return"Name for v type was "+typeof e.n+", not string";if(!i.test(e.n))return"Invalid identifier as variable name: "+e.n;break;case"a":if(o=t("c"))return o;if(!(e.c instanceof Array))return"Children of application object was not an array";if(0===e.c.length)return"Application object must have at least one child";for(m=e.c,c=0,f=m.length;f>c;c++)if(n=m[c],o=this.checkJSON(n))return o;break;case"bi":if(o=t("s","v","b"))return o;if(o=this.checkJSON(e.s))return o;if("sy"!==e.s.t)return"Head of a binding must be a symbol";if(!(e.v instanceof Array))return"In a binding, the v value must be an array";for(y=e.v,p=0,d=y.length;d>p;p++){if(l=y[p],o=this.checkJSON(l))return o;if("v"!==l.t)return"In a binding, all values in the v array must have type v"}if(o=this.checkJSON(e.b))return o;break;case"e":if(o=t("s","c"))return o;if(o=this.checkJSON(e.s))return o;if("sy"!==e.s.t)return"Head of an error must be a symbol";if(!(e.c instanceof Array))return"In an error, the c key must be an array";for(v=e.c,h=0,g=v.length;g>h;h++)if(n=v[h],o=this.checkJSON(n))return o;break;default:return"Invalid type: "+e.t}return null},e.decode=function(t){var n,r,i;if("string"==typeof t)try{t=JSON.parse(t)}catch(s){return n=s,n.message}return(r=this.checkJSON(t))?r:(i=function(e){var t,n,r,s,o,a,u,l,c,p,h,f,d;for(c=null!=(l=e.c)?l:[],s=0,a=c.length;a>s;s++)t=c[s],t.p=e,i(t);for(h=null!=(p=e.v)?p:[],o=0,u=h.length;u>o;o++)r=h[o],r.p=e,i(r);d=null!=(f=e.a)?f:{};for(n in d)__hasProp.call(d,n)&&(r=d[n],r.p=e,i(r));return null!=e.s&&(e.s.p=e,i(e.s)),null!=e.b?(e.b.p=e,i(e.b)):void 0},i(t),t.p=null,new e(t))},e.prototype.encode=function(){return JSON.stringify(this.tree,function(e,t){return"p"===e?void 0:t})},e.prototype.equals=function(e,t){var n;return null==t&&(t=!0),(n=function(e,r){var i,s,o,a,u,l;if(e===r)return!0;if(e instanceof Array||e instanceof Uint8Array){if(e instanceof Array&&!(r instanceof Array))return!1;if(e instanceof Uint8Array&&!(r instanceof Uint8Array))return!1;if(e.length!==r.length)return!1;for(s=u=0,l=e.length;l>u;s=++u)if(i=e[s],!n(i,r[s]))return!1;return!0}if(!(e instanceof Object))return!1;if(!(r instanceof Object))return!1;for(o in e)if(__hasProp.call(e,o)&&(a=e[o],"p"!==o&&(t||"a"!==o))){if(!r.hasOwnProperty(o))return!1;if(!n(a,r[o]))return!1}for(o in r)if(__hasProp.call(r,o)&&(a=r[o],"p"!==o&&(t||"a"!==o)&&!e.hasOwnProperty(o)))return!1;return!0})(this.tree,e.tree)},e.prototype.sameObjectAs=function(e){return this.tree===(null!=e?e.tree:void 0)},e.prototype.copy=function(){var t;return t=function(e){var n,r,i,s,o,a,u;i=function(){switch(e.t){case"i":case"f":case"st":return{t:e.t,v:e.v};case"v":return{t:"v",n:e.n};case"sy":return i={t:"sy",n:e.n,cd:e.cd},e.hasOwnProperty("uri")&&(i.uri=e.uri),i;case"ba":return{t:"ba",v:new Uint8Array(e.v)};case"e":case"a":return i={t:e.t,c:function(){var r,i,s,o;for(s=e.c,o=[],r=0,i=s.length;i>r;r++)n=s[r],o.push(t(n));return o}()},"e"===e.t&&(i.s=t(e.s)),i;case"bi":return{t:"bi",s:t(e.s),v:function(){var n,r,i,s;for(i=e.v,s=[],n=0,r=i.length;r>n;n++)o=i[n],s.push(t(o));return s}(),b:t(e.b)}}}(),u=null!=(a=e.a)?a:{};for(r in u)__hasProp.call(u,r)&&(s=u[r],(null!=i.a?i.a:i.a={})[r]=t(s));return i},e.decode(t(this.tree))},e.integer=function(t){return e.decode({t:"i",v:t})},e["float"]=function(t){return e.decode({t:"f",v:t})},e.string=function(t){return e.decode({t:"st",v:t})},e.bytearray=function(t){return e.decode({t:"ba",v:t})},e.symbol=function(t,n,r){return e.decode(null!=r?{t:"sy",n:t,cd:n,uri:r}:{t:"sy",n:t,cd:n})},e.variable=function(t){return e.decode({t:"v",n:t})},e.application=function(){var t,n,r,i,s;for(n=1<=arguments.length?__slice.call(arguments,0):[],r={t:"a",c:[]},i=0,s=n.length;s>i;i++)t=n[i],r.c.push(t instanceof e?JSON.parse(t.encode()):t);return e.decode(r)},e.attribution=function(){var t,n,r,i;if(r=arguments[0],t=2<=arguments.length?__slice.call(arguments,1):[],!(r instanceof Object))return"Invalid first parameter to attribution";if(t.length%2!==0)return"Incomplete key-value pair in attribution";for(r instanceof e&&(r=JSON.parse(r.encode()));t.length>0;)null==r.a&&(r.a={}),n=t.shift(),n=n instanceof e?n.encode():JSON.stringify(n),i=t.shift(),r.a[n]=i instanceof e?JSON.parse(i.encode()):i;return e.decode(r)},e.binding=function(){var t,n,r,i,s,o,a,u;if(n=arguments[0],s=3<=arguments.length?__slice.call(arguments,1,o=arguments.length-1):(o=1,[]),t=arguments[o++],!(n instanceof Object))return"Invalid first parameter to binding";if(!(t instanceof Object))return"Invalid last parameter to binding";for(r={t:"bi",s:n instanceof e?JSON.parse(n.encode()):n,v:[],b:t instanceof e?JSON.parse(t.encode()):t},a=0,u=s.length;u>a;a++)i=s[a],r.v.push(i instanceof e?JSON.parse(i.encode()):i);return e.decode(r)},e.error=function(){var t,n,r,i,s,o;if(t=arguments[0],r=2<=arguments.length?__slice.call(arguments,1):[],!(t instanceof Object))return"Invalid first parameter to binding";for(i={t:"e",s:t instanceof e?JSON.parse(t.encode()):t,c:[]},s=0,o=r.length;o>s;s++)n=r[s],i.c.push(n instanceof e?JSON.parse(n.encode()):n);return e.decode(i)},t=[{name:"symbol",pattern:/[:A-Za-z_][:A-Za-z_0-9-]*\.[:A-Za-z_][:A-Za-z_0-9-]*/},{name:"variable",pattern:/[:A-Za-z_][:A-Za-z_0-9-]*/},{name:"float",pattern:/[+-]?(?:[0-9]+\.[0-9]*|[0-9]*\.[0-9]+)/},{name:"integer",pattern:/[+-]?[0-9]+/},{name:"string",pattern:/"(?:[^"\\]|\\"|\\\\)*"|'(?:[^'\\]|\\'|\\\\)*'/},{name:"comma",pattern:/,/},{name:"openParen",pattern:/\(/},{name:"closeParen",pattern:/\)/},{name:"openBracket",pattern:/\[/},{name:"closeBracket",pattern:/\]/}],e.simpleDecode=function(n){var r,i,s,o,a,u,l,c,p,h,f,d,g,b,m,y,v,x,w,_,O,k,C;if("string"!=typeof n)return"Input was not a string";for(g=[];n.length>0;){for(p=n.length,m=0,w=t.length;w>m;m++)d=t[m],l=d.pattern.exec(n),null!=l&&0===l.index&&(g.push({type:d.name,text:l[0]}),n=n.slice(l[0].length));if(n.length===p)return"Could not understand from here: "+n.slice(0,11)}for(f="expression about to start",h=[];g.length>0;){switch(c=g.shift(),f){case"expression about to start":switch(c.type){case"symbol":s=c.text.split("."),h.unshift({node:e.symbol(s[1],s[0])});break;case"variable":h.unshift({node:e.variable(c.text)});break;case"integer":u=parseInt(c.text),/\./.test(u)&&(u=c.text),h.unshift({node:e.integer(u)});break;case"float":h.unshift({node:e["float"](parseFloat(c.text))});break;case"string":b=c.text[0],c=c.text.slice(1,-1).replace(RegExp("\\\\"+b,"g"),b),h.unshift({node:e.string(c)});break;default:return"Unexpected "+c.text}f="expression ended";break;case"expression ended":switch(c.type){case"comma":f="expression about to start";break;case"openParen":h[0].head="application","closeParen"===(null!=g&&null!=(C=g[0])?C.type:void 0)?(g.shift(),h.unshift({node:e.application(h.shift().node)}),f="expression ended"):f="expression about to start";break;case"openBracket":h[0].head="binding",f="expression about to start";break;case"closeParen":for(a=y=0,_=h.length;_>y&&(i=h[a],"application"!==i.head);a=++y)if("binding"===i.head)return"Mismatch: [ closed by )";if(a===h.length)return"Unexpected )";for(r=[],o=v=0;a>=0?a>=v:v>=a;o=a>=0?++v:--v)r.unshift(h.shift().node);h.unshift({node:e.application.apply(null,r)});break;case"closeBracket":for(a=x=0,O=h.length;O>x&&(i=h[a],"binding"!==i.head);a=++x)if("application"===i.head)return"Mismatch: ( closed by ]";if(a===h.length)return"Unexpected ]";for(r=[],o=k=0;a>=0?a>=k:k>=a;o=a>=0?++k:--k)r.unshift(h.shift().node);h.unshift({node:e.binding.apply(null,r)});break;default:return"Unexpected "+c.text}}if("string"==typeof(null!=h?h[0].node:void 0))return h[0].node}return h.length>1?"Unexpected end of input":h[0].node},e.prototype.simpleEncode=function(){var e;return(e=function(t){var n,r,i,s,o,a;switch(null!=t?t.t:void 0){case"i":case"f":return""+t.v;case"v":return t.n;case"st":return"'"+t.v.replace(/'/g,"\\'")+"'";case"sy":return""+t.cd+"."+t.n;case"ba":return"'byte array'";case"e":return"'error'";case"a":return i=function(){var n,i,s,o;for(s=t.c,o=[],n=0,i=s.length;i>n;n++)r=s[n],o.push(e(r));return o}(),s=i.shift(),""+s+"("+i.join(",")+")";case"bi":return a=function(){var n,r,i,s;for(i=t.v,s=[],n=0,r=i.length;r>n;n++)o=i[n],s.push(e(o));return s}(),s=e(t.s),n=e(t.b),""+s+"["+a.join(",")+","+n+"]";default:return"Error: Invalid OpenMath type "+(null!=t?t.t:void 0)}})(this.tree)},e.prototype.findInParent=function(){var e,t,n,r,i,s,o,a,u,l,c,p,h;if(!this.parent)return void 0;for(l=this.parent.children,t=s=0,a=l.length;a>s;t=++s)if(e=l[t],this.sameObjectAs(e))return"c"+t;if("v"===this.type)for(c=this.parent.variables,t=o=0,u=c.length;u>o;t=++o)if(i=c[t],this.sameObjectAs(i))return"v"+t;if(this.sameObjectAs(this.parent.symbol))return"s";if(this.sameObjectAs(this.parent.body))return"b";h=null!=(p=this.parent.tree.a)?p:{};for(n in h)if(__hasProp.call(h,n)&&(r=h[n],this.tree===r))return n;return void 0},e.prototype.findChild=function(t){switch(t[0]){case"c":return this.children[parseInt(t.slice(1))];case"v":return this.variables[parseInt(t.slice(1))];case"s":return this.symbol;case"b":return this.body;case"{":return this.getAttribute(e.decode(t))}},e.prototype.address=function(e){return!this.parent||this.sameObjectAs(e)?[]:this.parent.address(e).concat([this.findInParent()])},e.prototype.index=function(e){var t;return e instanceof Array?0===e.length?this:null!=(t=this.findChild(e[0]))?t.index(e.slice(1)):void 0:void 0},e.prototype.remove=function(){var e;if(e=this.findInParent()){switch(e[0]){case"c":this.parent.tree.c.splice(parseInt(e.slice(1)),1);break;case"v":this.parent.tree.v.splice(parseInt(e.slice(1)),1);break;case"b":delete this.parent.tree.b;break;case"s":delete this.parent.tree.s;break;case"{":delete this.parent.tree.a[e]}return delete this.tree.p}},e.prototype.replaceWith=function(t){var n,r;if(!(this.sameObjectAs(t)||(n=this.findInParent(),"s"===n&&"sy"!==t.type||"v"===(null!=n?n[0]:void 0)&&"v"!==t.type))){switch(t.remove(),r=new e(this.tree),this.tree=t.tree,null!=n?n[0]:void 0){case"c":r.parent.tree.c[parseInt(n.slice(1))]=this.tree;break;case"v":r.parent.tree.v[parseInt(n.slice(1))]=this.tree;break;case"b":r.parent.tree.b=this.tree;break;case"s":r.parent.tree.s=this.tree;break;case"{":r.parent.tree.a[n]=this.tree;break;default:return}return this.tree.p=r.tree.p,delete r.tree.p,r}},e.prototype.getAttribute=function(t){var n,r,i,s,o,a;if(!(t instanceof e))return void 0;if("sy"!==t.type)return void 0;i=RegExp('"n":"'+t.name+'"'),n=RegExp('"cd":"'+t.cd+'"'),a=null!=(o=this.tree.a)?o:{};for(r in a)if(__hasProp.call(a,r)&&(s=a[r],i.test(r)&&n.test(r)))return new e(s)},e.prototype.removeAttribute=function(t){var n,r,i,s,o,a;if(t instanceof e&&"sy"===t.type){i=RegExp('"n":"'+t.name+'"'),n=RegExp('"cd":"'+t.cd+'"'),a=null!=(o=this.tree.a)?o:{};for(r in a)if(__hasProp.call(a,r)&&(s=a[r],i.test(r)&&n.test(r)))return new e(s).remove(),void delete this.tree.a[r]}},e.prototype.setAttribute=function(t,n){var r;if(t instanceof e&&n instanceof e&&"sy"===t.type)return this.removeAttribute(t),n.remove(),(null!=(r=this.tree).a?r.a:r.a={})[t.encode()]=n.tree,n.tree.p=this.tree},e.prototype.freeVariables=function(){var e,t,n,r,i,s,o,a,u,l,c,p,h,f,d,g;switch(this.type){case"v":return[this.name];case"a":case"c":for(r=[],h=this.children,o=0,l=h.length;l>o;o++)for(t=h[o],f=t.freeVariables(),a=0,c=f.length;c>a;a++)n=f[a],__indexOf.call(r,n)<0&&r.push(n);return r;case"bi":for(e=function(){var e,t,n,r;for(n=this.variables,r=[],e=0,t=n.length;t>e;e++)i=n[e],r.push(i.name);return r}.call(this),d=this.body.freeVariables(),g=[],u=0,p=d.length;p>u;u++)s=d[u],__indexOf.call(e,s)<0&&g.push(s);return g;default:return[]}},e.prototype.isFree=function(e){var t,n,r,i,s,o,a;for(n=this.freeVariables(),s=this;s;){if("bi"===s.type)for(t=function(){var e,t,n,i;for(n=s.variables,i=[],e=0,t=n.length;t>e;e++)r=n[e],i.push(r.name);return i}(),o=0,a=n.length;a>o;o++)if(i=n[o],__indexOf.call(t,i)>=0)return!1;if(s.sameObjectAs(e))break;s=s.parent}return!0},e.prototype.occursFree=function(e){var t,n,r,i,s,o;if(this.equals(e)&&this.isFree())return!0;if(null!=(i=this.symbol)?i.equals(e):void 0)return!0;if(null!=(s=this.body)?s.occursFree(e):void 0)return!0;for(o=this.children,n=0,r=o.length;r>n;n++)if(t=o[n],t.occursFree(e))return!0;return!1},e.prototype.isFreeToReplace=function(t,n){var r,i,s;if(this.sameObjectAs(t))return!0;if(null==t.parent)return!0;for(r=t;r.parent;)r=r.parent;return s=new e(t.tree),t.replaceWith(this.copy())?(i=t.isFree(n),t.replaceWith(s),i):!1},e.prototype.replaceFree=function(t,n,r){var i,s,o,a,u,l,c,p,h,f,d,g;if(null==r&&(r=this),this.isFree(r)&&this.equals(t))return s=new e(this.tree),this.replaceWith(n.copy()),void(this.isFree(r)||this.replaceWith(s));for(null!=(p=this.symbol)&&p.replaceFree(t,n,r),null!=(h=this.body)&&h.replaceFree(t,n,r),f=this.variables,a=0,l=f.length;l>a;a++)o=f[a],o.replaceFree(t,n,r);for(d=this.children,g=[],u=0,c=d.length;c>u;u++)i=d[u],g.push(i.replaceFree(t,n,r));return g},e.prototype.childrenSatisfying=function(e){var t,n,r,i,s;for(null==e&&(e=function(){return!0}),n=this.children,null!=this.symbol&&n.push(this.symbol),n=n.concat(this.variables),null!=this.body&&n.push(this.body),s=[],r=0,i=n.length;i>r;r++)t=n[r],e(t)&&s.push(t);return s},e.prototype.descendantsSatisfying=function(e){var t,n,r,i,s;for(null==e&&(e=function(){return!0}),n=[],e(this)&&n.push(this),s=this.childrenSatisfying(),r=0,i=s.length;i>r;r++)t=s[r],n=n.concat(t.descendantsSatisfying(e));return n},e.prototype.hasDescendantSatisfying=function(e){var t,n,r,i;if(null==e&&(e=function(){return!0}),e(this))return!0;for(i=this.childrenSatisfying(),n=0,r=i.length;r>n;n++)if(t=i[n],t.hasDescendantSatisfying(e))return!0;return!1},e}(),OM["int"]=OM.integer,OM.flo=OM["float"],OM.str=OM.string,OM.byt=OM.bytearray,OM.sym=OM.symbol,OM["var"]=OM.variable,OM.app=OM.application,OM.att=OM.attribution,OM.bin=OM.binding,OM.err=OM.error,OM.simple=OM.simpleDecode,OM.encodeAsIdentifier=function(e){var t,n,r,i,s;for(t=function(t){return("000"+e.charCodeAt(t).toString(16)).slice(-4)},r="id_",n=i=0,s=e.length;s>=0?s>i:i>s;n=s>=0?++i:--i)r+=t(n);return r},OM.decodeIdentifier=function(e){var t;if(t="","id_"!==e.slice(0,3))return t;for(e=e.slice(3);e.length>0;)t+=String.fromCharCode(parseInt(e.slice(0,4),16)),e=e.slice(4);return t},null==exports&&(exports=null!=(_ref1="undefined"!=typeof module&&null!==module?module.exports:void 0)?_ref1:window),"undefined"!=typeof require&&null!==require&&(_ref2=require("./openmath-duo"),OM=_ref2.OM,OMNode=_ref2.OMNode),metavariableSymbol=OM.symbol("metavariable","lurch"),trueValue=OM.string("true"),exports.setMetavariable=setMetavariable=function(e){var t;if(e instanceof OMNode&&("v"===(t=e.type)||"sy"===t))return e.setAttribute(metavariableSymbol,trueValue.copy())},exports.clearMetavariable=clearMetavariable=function(e){return e.removeAttribute(metavariableSymbol)},exports.isMetavariable=isMetavariable=function(e){var t,n;return e instanceof OMNode&&("v"===(t=e.type)||"sy"===t)&&(null!=(n=e.getAttribute(metavariableSymbol))?n.equals(trueValue):void 0)},expressionFunction=OM.symbol("EF","lurch"),expressionFunctionApplication=OM.symbol("EFA","lurch"),exports.makeExpressionFunction=makeExpressionFunction=function(e){return function(e,t){if("v"!==e.type)throw"When creating an expression function, its parameter must be a variable";return OM.bin(expressionFunction,e,t)}}(this),exports.isExpressionFunction=isExpressionFunction=function(e){return function(e){return"bi"===e.type&&1===e.variables.length&&e.symbol.equals(expressionFunction)}}(this),exports.makeExpressionFunctionApplication=makeExpressionFunctionApplication=function(e){return function(e,t){return OM.app(expressionFunctionApplication,e,t)}}(this),exports.isExpressionFunctionApplication=isExpressionFunctionApplication=function(e){return function(e){return"a"===e.type&&3===e.children.length&&e.children[0].equals(expressionFunctionApplication)}}(this),exports.applyExpressionFunction=applyExpressionFunction=function(e,t){var n;return n=e.body.copy(),n.replaceFree(e.variables[0],t),n},exports.alphaEquivalent=alphaEquivalent=function(e,t){var n,r,i,s,o,a;for(i=0,o=function(){return OM["var"]("v"+i)},s=function(e){return e.equals(o())},a=OM.app(e,t);a.hasDescendantSatisfying(s);)i++;return n=applyExpressionFunction(e,o()),r=applyExpressionFunction(t,o()),isExpressionFunction(e)&&isExpressionFunction(t)&&n.equals(r)},exports.consistentPatterns=consistentPatterns=function(){var e,t,n,r,i,s,o,a,u,l,c,p,h,f;for(i=1<=arguments.length?__slice.call(arguments,0):[],n=[],t=[],s=0,a=i.length;a>s;s++)for(r=i[s],l=r.descendantsSatisfying(isMetavariable),o=0,u=l.length;u>o;o++)if(e=l[o],isExpressionFunctionApplication(e.parent)&&"c1"===e.findInParent()){if(c=e.name,__indexOf.call(n,c)>=0)return!1;p=e.name,__indexOf.call(t,p)<0&&t.push(e.name)}else{if(h=e.name,__indexOf.call(t,h)>=0)return!1;f=e.name,__indexOf.call(n,f)<0&&n.push(e.name)}return!0},exports.Constraint=Constraint=function(){function e(e,t){this.pattern=e,this.expression=t}return e.prototype.copy=function(){return new Constraint(this.pattern.copy(),this.expression.copy())},e.prototype.equals=function(e){return this.pattern.equals(e.pattern,!1)&&this.expression.equals(e.expression,!1)},e}(),exports.ConstraintList=ConstraintList=function(){function e(){var e,t,n,r,i,s,o,a,u,l,c,p,h,f;for(n=1<=arguments.length?__slice.call(arguments,0):[],this.contents=n,this.nextNewVariableIndex=0,e=function(e){return function(t){return/^v[0-9]+$/.test(t.name)?e.nextNewVariableIndex=Math.max(e.nextNewVariableIndex,parseInt(t.name.slice(1))+1):void 0}}(this),i=function(e){return e.descendantsSatisfying(function(e){return"v"===e.type})},p=this.contents,s=0,u=p.length;u>s;s++){for(t=p[s],h=i(t.pattern),o=0,l=h.length;l>o;o++)r=h[o],e(r);for(f=i(t.expression),a=0,c=f.length;c>a;a++)r=f[a],e(r)}}return e.prototype.nextNewVariable=function(){return OM.simple("v"+this.nextNewVariableIndex++)},e.prototype.length=function(){return this.contents.length},e.prototype.copy=function(){var e,t;return t=function(e,t,n){n.prototype=e.prototype;var r=new n,i=e.apply(r,t);return Object(i)===i?i:r}(ConstraintList,function(){var t,n,r,i;for(r=this.contents,i=[],t=0,n=r.length;n>t;t++)e=r[t],i.push(e.copy());return i}.call(this),function(){}),t.nextNewVariableIndex=this.nextNewVariableIndex,t},e.prototype.indexAtWhich=function(e){var t,n,r,i,s;for(s=this.contents,n=r=0,i=s.length;i>r;n=++r)if(t=s[n],e(t))return n;return-1},e.prototype.plus=function(){var e,t,n,r,i,s;for(t=1<=arguments.length?__slice.call(arguments,0):[],r=this.copy(),i=0,s=t.length;s>i;i++)e=t[i],n=r.indexAtWhich(function(t){return t.equals(e,!1)}),-1===n&&r.contents.push(e);return r},e.prototype.minus=function(){var e,t,n,r,i,s;for(t=1<=arguments.length?__slice.call(arguments,0):[],r=this.copy(),i=0,s=t.length;s>i;i++)e=t[i],n=r.indexAtWhich(function(t){return t.equals(e,!1)}),n>-1&&r.contents.splice(n,1);return r},e.prototype.firstSatisfying=function(e){var t;return null!=(t=this.contents[this.indexAtWhich(e)])?t:null},e.prototype.firstPairSatisfying=function(e){var t,n,r,i,s,o,a,u,l,c;for(l=this.contents,r=s=0,a=l.length;a>s;r=++s)for(t=l[r],c=this.contents,i=o=0,u=c.length;u>o;i=++o)if(n=c[i],r!==i&&e(t,n))return[t,n];return null},e.prototype.isFunction=function(){var e,t,n,r,i,s;for(t=[],i=this.contents,n=0,r=i.length;r>n;n++){if(e=i[n],!isMetavariable(e.pattern))return!1;if(s=e.pattern.name,__indexOf.call(t,s)>=0)return!1;t.push(e.pattern.name)}return!0},e.prototype.lookup=function(e){var t,n,r,i;for(e instanceof OM||(e=OM["var"](e)),setMetavariable(e),i=this.contents,n=0,r=i.length;r>n;n++)if(t=i[n],t.pattern.equals(e,!1))return t.expression;return null},e.prototype.apply=function(e){var t,n,r,i,s,o;for(r=e.copy(),n=r.descendantsSatisfying(isMetavariable),s=0,o=n.length;o>s;s++)t=n[s],null!=(i=this.lookup(t))&&t.replaceWith(i);return r},e.prototype.equals=function(e){var t,n,r,i,s,o,a;for(o=this.contents,n=0,i=o.length;i>n;n++)if(t=o[n],!e.firstSatisfying(function(e){return e.equals(t)}))return!1;for(a=e.contents,r=0,s=a.length;s>r;r++)if(t=a[r],!this.firstSatisfying(function(e){return e.equals(t)}))return!1;return!0},e}(),exports.findDifferencesBetween=findDifferencesBetween=function(e,t){var n,r;return n=[],r=function(t,i){var s,o,a,u,l,c,p;if(t.type!==i.type)return n.push(t.address(e));if("bi"===t.type?(s=[t.symbol].concat(__slice.call(t.variables),[t.body]),o=[i.symbol].concat(__slice.call(i.variables),[i.body])):(s=t.children,o=i.children),s.length!==o.length||s.length+o.length===0&&!t.equals(i,!1))return n.push(t.address(e));for(p=[],u=l=0,c=s.length;c>l;u=++l)a=s[u],p.push(r(a,o[u]));return p},r(e,t),n},exports.parentAddresses=parentAddresses=function(e){var t,n,r,i,s,o,a,u;for(n=[],i=0,o=e.length;o>i;i++)t=e[i],0!==t.length&&(r=JSON.stringify(t.slice(0,-1)),__indexOf.call(n,r)<0&&n.push(r));if(0===n.length)return null;for(u=[],s=0,a=n.length;a>s;s++)t=n[s],u.push(JSON.parse(t));return u},exports.partitionedAddresses=partitionedAddresses=function(e){var t,n;return t=[],n=function(r){var i,s,o,a,u,l,c,p,h;for(s=!1,a=0,l=t.length;l>a;a++)if(o=t[a],r.equals(o.subexpression,!1)){o.addresses.push(r.address(e)),s=!0;break}for(s||t.push({subexpression:r,addresses:[r.address(e)]}),p=r.children,h=[],u=0,c=p.length;c>u;u++)i=p[u],h.push(n(i));return h},n(e),t},exports.expressionDepth=expressionDepth=function(e){var t,n;return n=__slice.call(e.children).concat(__slice.call(e.variables)),e.body&&n.push(e.body),e.symbol&&n.push(e.symbol),1+Math.max.apply(Math,[0].concat(__slice.call(function(){var e,r,i;for(i=[],e=0,r=n.length;r>e;e++)t=n[e],i.push(expressionDepth(t));return i}())))},exports.sameDepthAncestors=sameDepthAncestors=function(e,t){var n,r,i,s,o,a,u,l,c,p,h,f,d,g,b,m,y,v,x,w,_,O;for(l=f=0,m=t.length;m>f;l=++f)for(r=t[l],o=expressionDepth(e.index(r)),c=d=0,y=t.length;y>d;c=++d)if(i=t[c],a=expressionDepth(e.index(i)),o!==a)return o>a&&(w=[i,r],r=w[0],i=w[1],_=[c,l],l=_[0],c=_[1]),s=r.slice(0,-1),u=t.slice(0),u[l]=r.slice(0,-1),sameDepthAncestors(e,u);for(p=[],g=0,v=t.length;v>g;g++)n=t[g],h=JSON.stringify(n),__indexOf.call(p,h)<0&&p.push(h);for(O=[],b=0,x=p.length;x>b;b++)h=p[b],O.push(JSON.parse(h));return O},exports.differenceIterator=differenceIterator=function(e,t){var n,r;return r=sameDepthAncestors(e,findDifferencesBetween(e,t)),n=function(n){var r,i,s,o,a,u;for(s=0,a=n.length;a>s;s++)for(r=n[s],o=0,u=n.length;u>o;o++){if(i=n[o],!e.index(r).equals(e.index(i),!1))return!1;if(!t.index(r).equals(t.index(i),!1))return!1}return!0},function(){for(var t,i;null!=r&&!n(r);)t=parentAddresses(r),r=t&&sameDepthAncestors(e,t);return i=r,null!==i&&(t=parentAddresses(r),r=t&&sameDepthAncestors(e,t)),i}},exports.subexpressionIterator=subexpressionIterator=function(e){var t,n,r;return n=partitionedAddresses(e),r={next:n.shift(),rest:n,subsetIndex:1},t=function(){var n,i,s;return matchDebug("		subexpression iterator for",e.simpleEncode(),"next:",JSON.stringify(r.next.addresses),"rest:",JSON.stringify(function(){var e,t,n,i;for(n=r.rest,i=[],e=0,t=n.length;t>e;e++)s=n[e],i.push(s.addresses);return i}()),"subsetIndex:",r.subsetIndex),r.subsetIndex<Math.pow(2,r.next.addresses.length)?(i=function(){var e,t,i;for(i=[],n=e=0,t=r.next.addresses.length;t>=0?t>e:e>t;n=t>=0?++e:--e)0<(r.subsetIndex&Math.pow(2,n))&&i.push(r.next.addresses[n]);return i}(),r.subsetIndex++,i):r.rest.length>0?(r.next=r.rest.shift(),r.subsetIndex=1,t()):null}},exports.prefixIterator=prefixIterator=function(e,t){var n;return n=!1,function(){return n?t():(n=!0,e)}},exports.suffixIterator=suffixIterator=function(e,t){var n;return n=!1,function(){var r;return r=e(),null!==r||n||(r=t,n=!0),r}},exports.composeIterator=composeIterator=function(e,t){return function(){var n;return(n=e())?t(n):null}},exports.filterIterator=filterIterator=function(e,t){return function(){var n;for(n=e();n&&!t(n);)n=e();return n}},exports.concatenateIterators=concatenateIterators=function(e,t){return function(){return e()||t()}},exports.multiReplace=multiReplace=function(e,t,n){var r,i,s,o,a;for(i=e.copy(),s=0,o=t.length;o>s;s++)r=t[s],null!=(a=i.index(r))&&a.replaceWith(n.copy());return i},exports.bindingConstraints1=bindingConstraints1=function(e){var t,n,r,i,s,o,a,u,l,c,p,h,f,d,g,b;for(o=new ConstraintList,r=function(e){return"bi"===e.type},d=e.descendantsSatisfying(r),u=0,p=d.length;p>u;u++)for(n=d[u],g=n.descendantsSatisfying(isMetavariable),l=0,h=g.length;h>l;l++)if(i=g[l],i.isFree(n))for(b=n.variables,c=0,f=b.length;f>c;c++)a=b[c],isMetavariable(a)&&(s=new Constraint(a,i),t=function(e){return e.equals(s)},o.firstSatisfying(t)||o.contents.push(s));return o},exports.satisfiesBindingConstraints1=satisfiesBindingConstraints1=function(e,t){var n,r,i,s,o,a;for(a=t.contents,s=0,o=a.length;o>s;s++)if(n=a[s],i=e.lookup(n.pattern),r=e.lookup(n.expression).copy(),r.occursFree(i))return!1;return!0},exports.bindingConstraints2=bindingConstraints2=function(e){var t,n,r,i,s,o;for(r=new ConstraintList,o=e.descendantsSatisfying(isExpressionFunctionApplication),i=0,s=o.length;s>i;i++)t=o[i],isMetavariable(t.children[1])&&(n=function(e,t,n){n.prototype=e.prototype;var r=new n,i=e.apply(r,t);return Object(i)===i?i:r}(Constraint,t.children.slice(1,3),function(){}),r.firstSatisfying(function(e){return e.equals(n)})||r.contents.push(n));return r},exports.satisfiesBindingConstraints2=satisfiesBindingConstraints2=function(e,t){var n,r,i,s,o,a,u,l,c,p,h;for(p=t.contents,a=0,l=p.length;l>a;a++)for(i=p[a],s=e.lookup(i.pattern),null==s&&matchDebug(CLToString(e),CLToString(t)),n=e.apply(i.expression),r=function(e){return e.equals(s.variables[0])},h=s.body.descendantsSatisfying(r),u=0,c=h.length;c>u;u++)if(o=h[u],!n.isFreeToReplace(o,s.body))return!1;return!0},CToString=function(e){return"("+e.pattern.simpleEncode()+","+e.expression.simpleEncode()+")"},CLToString=function(e){var t;return null===e?null:"{ "+function(){var n,r,i,s;for(i=e.contents,s=[],n=0,r=i.length;r>n;n++)t=i[n],s.push(CToString(t));return s}().join(", ")+" }"},CLSetToString=function(e){var t;return null===e?null:"[\n"+function(){var n,r,i;for(i=[],n=0,r=e.length;r>n;n++)t=e[n],i.push("	"+CLToString(t));return i}().join("\n")+"\n]"},matchDebugOn=!1,exports.setMatchDebug=function(e){return matchDebugOn=e},matchDebug=function(){var e;return e=1<=arguments.length?__slice.call(arguments,0):[],matchDebugOn?console.log.apply(console,e):void 0},exports.nextMatch=nextMatch=function(e,t,n){var r,i,s,o,a,u,l,c,p,h,f,d,g,b,m,y,v,x,w,_,O,k,C,M,S,E,N,A,T,F,I;
if(null==t&&(t=new ConstraintList),null==n&&(n=null),e instanceof Constraint&&(e=new ConstraintList(e)),!(e instanceof ConstraintList))throw"Invalid first parameter, not a constraint list";if(matchDebug("\nmatchDebug",CLToString(e),CLToString(t),null!=n?"  ...ITERATOR...":""),null==n){if(0===e.length())return matchDebug("	base case, returning:",CLToString(t)),[t,null];if(c=e.firstSatisfying(function(e){return 0===e.pattern.children.length&&0===e.pattern.variables.length&&!isMetavariable(e.pattern)}),null!=c)return c.pattern.equals(c.expression,!1)?(matchDebug("	atomic case, recur:",CToString(c)),nextMatch(e.minus(c),t,n)):(matchDebug("	atomic case, return null for",CToString(c)),[null,null]);if(M=function(e){return"bi"===e.type?[e.symbol].concat(__slice.call(e.variables),[e.body]):e.children},c=e.firstSatisfying(function(e){return M(e.pattern).length>0&&!isExpressionFunctionApplication(e.pattern)}),null!=c)return r=c.pattern,i=c.expression,r.type!==i.type?(matchDebug("	non-atomic case, type fail:",CToString(c)),[null,null]):(g=M(r),S=M(i),g.length!==S.length?(matchDebug("	non-atomic case, #children fail:",CToString(c)),[null,null]):(e=(F=e.minus(c)).plus.apply(F,function(){var e,t,n;for(n=[],d=e=0,t=g.length;t>e;d=++e)l=g[d],n.push(new Constraint(l,S[d]));return n}()),matchDebug("	non-atomic case, recur:",CToString(c)),nextMatch(e,t,n)));if(c=e.firstSatisfying(function(e){return isMetavariable(e.pattern)}),null!=c){if(s=t.lookup(c.pattern)){if(!c.expression.equals(s,!1))return matchDebug("	metavariable case, mismatch:",CToString(c)),[null,null];matchDebug("	metavariable case, already set:",CToString(c))}else matchDebug("	metavariable case, assigning:",CToString(c)),t=t.plus(c.copy());return nextMatch(e.minus(c),t,n)}if(C=e.firstPairSatisfying(function(e,t){return isExpressionFunctionApplication(e.pattern)&&isExpressionFunctionApplication(t.pattern)&&e.pattern.children[1].equals(t.pattern.children[1],!1)&&!e.expression.equals(t.expression,!1)}),null!=C)return a=C[0],u=C[1],E=e.minus(a,u),y=a.pattern.children[1],A=a.pattern.children[2],T=u.pattern.children[2],h=a.expression,f=u.expression,m=function(t){var n;return n=e.nextNewVariable(),makeExpressionFunction(n,multiReplace(h,t,n))},n=differenceIterator(h,f),n=filterIterator(n,function(e){var n;return n=t.lookup(y),null==n||alphaEquivalent(n,m(e))}),n=composeIterator(n,function(e){var n;return n=t.lookup(y)?t.copy():t.plus(new Constraint(y,m(e))),[E.plus(new Constraint(A,h.index(e[0])),new Constraint(T,f.index(e[0]))),n,null]}),matchDebug("	efa case 1 of 2, iterating:",CToString(a),CToString(u)),nextMatch(E,t,n);if(C=e.firstPairSatisfying(function(e,t){return isExpressionFunctionApplication(e.pattern)&&isExpressionFunctionApplication(t.pattern)&&e.pattern.children[1].equals(t.pattern.children[1],!1)&&e.expression.equals(t.expression,!1)}),null!=C)return a=C[0],u=C[1],E=e.minus(a,u),y=a.pattern.children[1],A=a.pattern.children[2],T=u.pattern.children[2],p=a.expression,m=function(t){var n;return n=e.nextNewVariable(),makeExpressionFunction(n,multiReplace(p,t,n))},n=subexpressionIterator(p),n=filterIterator(n,function(e){var n;return n=t.lookup(y),null==n||alphaEquivalent(n,m(e))}),n=suffixIterator(n,[]),n=composeIterator(n,function(e){var n,r,i,s;if(i=m(e),s=t.lookup(y)){if(!alphaEquivalent(s,i))return null;n=t.copy()}else n=t.plus(new Constraint(y,i));return r=E,0!==e.length&&(r=r.plus(new Constraint(A,p.index(e[0])),new Constraint(T,p.index(e[0])))),[r,n,null]}),matchDebug("	efa case 2 of 2, iterating:",CToString(a),CToString(u)),nextMatch(E,t,n);if(c=e.contents[0],!isExpressionFunctionApplication(c.pattern))throw Error("Invalid assumption in final case of matching");return E=e.minus(c),y=c.pattern.children[1],N=c.pattern.children[2],p=c.expression,(b=t.lookup(y))?(o=applyExpressionFunction(b,N),matchDebug("	final case, applying known metavariable:",CToString(c)),nextMatch(E.plus(new Constraint(b,p)),t,n)):(m=function(t){var n;return n=e.nextNewVariable(),makeExpressionFunction(n,multiReplace(p,t,n))},n=subexpressionIterator(p),n=filterIterator(n,function(e){return b=t.lookup(y),null==b||alphaEquivalent(b,m(e))}),n=suffixIterator(n,[]),n=composeIterator(n,function(e){var n,r,i,s;if(matchDebug("		next subexpression, with subset",JSON.stringify(e),"solution",CLToString(t),"constraints",CLToString(E),"t",N.simpleEncode(),"e",p.simpleEncode(),"metavariable",y.simpleEncode()),i=m(e),s=t.lookup(y)){if(!alphaEquivalent(s,i))return null;n=t.copy()}else n=t.plus(new Constraint(y,i));return r=E,0!==e.length&&(r=r.plus(new Constraint(N,p.index(e[0])))),[r,n,null]}),matchDebug("	final case, iterating:",CToString(c)),nextMatch(E,t,n))}return v=n(),null===v?(matchDebug("	iterator case, next is null, done!"),[null,null]):(w=v[0],k=v[1],_=v[2],matchDebug("	iterator case, using iterator.next():",CLToString(w),CLToString(k),null!=_,"\n--->"),I=nextMatch(w,k,_),O=I[0],x=I[1],null==O?(matchDebug("\n<---\n	after iterator recursion, no result; keep iterating..."),nextMatch(e,t,n)):null==x?(matchDebug("\n<---\n	after iterator recursion, got a unique solution:",CLToString(O)),[O,[e,t,n]]):(matchDebug("\n<---\n	after iterator recursion, got a(nother?) solution:",CLToString(O),"PLUS nextArguments",CLToString(x[0]),CLToString(x[1]),null!=x[2]),x[2]=concatenateIterators(x[2],n),[O,x]))},window.Background={functions:{},registerFunction:function(e,t,n,r){return null==n&&(n={}),null==r&&(r=[]),window.Background.functions[e]={"function":t,globals:n,scripts:r}},runningTasks:[],waitingTasks:[],addTask:function(e,t,n){var r,i,s,o,a,u,l,c,p,h,f,d;for(s={name:e,inputs:t,callback:n,id:""+e+","+function(){var e,n,i;for(i=[],e=0,n=t.length;n>e;e++)r=t[e],i.push(r.id());return i}()},p=window.Background.waitingTasks,i=a=0,l=p.length;l>a;i=++a)if(o=p[i],o.id===s.id){window.Background.waitingTasks.splice(i,1);break}for(h=window.Background.runningTasks,i=u=0,c=h.length;c>u;i=++u)if(o=h[i],o.id===s.id){null!=(f=o.runner)&&null!=(d=f.worker)&&"function"==typeof d.terminate&&d.terminate(),window.Background.runningTasks.splice(i,1);break}return window.Background.waitingTasks.push(s),window.Background.update()},addCodeTask:function(e,t,n,r,i){return null==r&&(r={}),null==i&&(i=[]),window.Background.registerFunction(""+e,e,r,i),window.Background.addTask(""+e,t,n)},available:{},update:function(){var e,t,n,r,i;for(e=window.Background;e.runningTasks.length<e.concurrency();){if(null==(r=e.waitingTasks.shift()))return;if(n=null!=(i=e.available[r.name])?i.pop():void 0,null==n){if(t=e.functions[r.name],null==t)continue;n=new BackgroundFunction(t["function"],t.globals,t.scripts)}r.runner=n,e.runningTasks.push(r),function(t){var r;return r=function(){var r,i,s;return r=e.runningTasks.indexOf(t),e.runningTasks.splice(r,1),(null!=(i=e.available)[s=t.name]?i[s]:i[s]=[]).push(n),window.Background.update()},n.call.apply(n,t.inputs).sendTo(function(e){return r(),"function"==typeof t.callback?t.callback(e):void 0}).orElse(r)}(r)}}},navigator.getHardwareConcurrency(function(){}),window.Background.concurrency=function(){var e;return Math.max(1,(null!=(e=navigator.hardwareConcurrency)?e:1)-1)},BackgroundFunction=function(){function _Class(e,t,n){var r,i,s;if(this["function"]=e,this.globals=t,this.scripts=n,this.call=__bind(this.call,this),this.promise={sendTo:function(e){return function(t){return e.promise.resultCallback=t,e.promise.hasOwnProperty("result")&&e.promise.resultCallback(e.promise.result),e.promise}}(this),orElse:function(e){return function(t){return e.promise.errorCallback=t,e.promise.hasOwnProperty("error")&&e.promise.errorCallback(e.promise.error),e.promise}}(this)},window.Worker){this.worker=new window.Worker("worker-solo.js"),this.worker.addEventListener("message",function(e){return function(t){var n;return e.promise.result=t.data,null!=(n=e.promise)&&"function"==typeof n.resultCallback?n.resultCallback(t.data):void 0}}(this),!1),this.worker.addEventListener("error",function(e){return function(t){var n;return e.promise.error=t,null!=(n=e.promise)&&"function"==typeof n.errorCallback?n.errorCallback(t):void 0}}(this),!1),this.worker.postMessage({setFunction:""+this["function"]}),s=this.globals;for(i in s)__hasProp.call(s,i)&&(r=s[i],this.globals[i]=""+r);this.worker.postMessage({install:this.globals}),this.worker.postMessage({"import":this.scripts})}}return _Class.prototype.call=function(){var args,group,groups,_i,_len;for(args=1<=arguments.length?__slice.call(arguments,0):[],delete this.promise.result,delete this.promise.resultCallback,delete this.promise.error,delete this.promise.errorCallback,_i=0,_len=arguments.length;_len>_i;_i++)if(group=arguments[_i],group.deleted)return;return groups=function(){var e,t,n;for(n=[],e=0,t=args.length;t>e;e++)group=args[e],n.push(group.toJSON());return n}(),null!=this.worker?this.worker.postMessage({runOn:groups}):setTimeout(function(_this){return function(){var e,_base,_base1;try{with(this.globals)_this.promise.result=_this["function"].apply(_this,groups)}catch(_error){return e=_error,_this.promise.error=e,void("function"==typeof(_base=_this.promise).errorCallback&&_base.errorCallback(_this.promise.error))}return"function"==typeof(_base1=_this.promise).resultCallback?_base1.resultCallback(_this.promise.result):void 0}}(this),0),this.promise},_Class}(),CanvasRenderingContext2D.prototype.bezierArrow=function(e,t,n,r,i,s,o,a,u){var l,c,p,h,f;return null==u&&(u=10),f=function(e,t){var n;return n=Math.sqrt(e*e+t*t)||1,{x:e/n,y:t/n}},this.beginPath(),this.moveTo(e,t),this.bezierCurveTo(n,r,i,s,o,a),p={x:this.applyBezier(e,n,i,o,.9),y:this.applyBezier(t,r,s,a,.9)},h={x:o-p.x,y:a-p.y},c=f(h.x,h.y),c.x*=.7*u,c.y*=u,l={x:c.y,y:-c.x},this.moveTo(o-l.x-c.x,a-l.y-c.y),this.lineTo(o,a),this.lineTo(o+l.x-c.x,a+l.y-c.y)},CanvasRenderingContext2D.prototype.applyBezier=function(e,t,n,r,i){return Math.pow(1-i,3)*e+3*Math.pow(1-i,2)*i*t+3*(1-i)*Math.pow(i,2)*n+Math.pow(i,3)*r},CanvasRenderingContext2D.prototype.roundedRect=function(e,t,n,r,i){return this.beginPath(),this.moveTo(e+i,t),this.lineTo(n-i,t),this.arcTo(n,t,n,t+i,i),this.lineTo(n,r-i),this.arcTo(n,r,n-i,r,i),this.lineTo(e+i,r),this.arcTo(e,r,e,r-i,i),this.lineTo(e,t+i),this.arcTo(e,t,e+i,t,i),this.closePath()},CanvasRenderingContext2D.prototype.roundedZone=function(e,t,n,r,i,s,o,a,u){return this.beginPath(),this.moveTo(e+u,t),this.lineTo(this.canvas.width-a,t),this.lineTo(this.canvas.width-a,s),this.lineTo(n,s),this.lineTo(n,r-u),this.arcTo(n,r,n-u,r,u),this.lineTo(o,r),this.lineTo(o,i),this.lineTo(e,i),this.lineTo(e,t+u),this.arcTo(e,t,e+u,t,u),this.closePath()},window.rectanglesCollide=function(e,t,n,r,i,s,o,a){return!(i>=n||e>=o||s>=r||t>=a)},window.svgBlobForHTML=function(e,t){var n,r,i;return null==t&&(t="font-size:12px"),r=document.createElement("span"),r.setAttribute("style",t),r.innerHTML=e,document.body.appendChild(r),r=$(r),i=r.width()+2,n=r.height()+2,r.remove(),window.makeBlob("<svg xmlns='http://www.w3.org/2000/svg' width='"+i+"' height='"+n+"'><foreignObject width='100%' height='100%'><div xmlns='http://www.w3.org/1999/xhtml' style='"+t+"'>"+e+"</div></foreignObject></svg>","image/svg+xml;charset=utf-8")},window.makeBlob=function(e,t){var n,r,i,s,o;try{return new Blob([e],{type:t})}catch(a){if(r=a,window.BlobBuilder=null!=(i=null!=(s=null!=(o=window.BlobBuilder)?o:window.WebKitBlobBuilder)?s:window.MozBlobBuilder)?i:window.MSBlobBuilder,"TypeError"===r.name&&null!=window.BlobBuilder)return n=new BlobBuilder,n.append(e.buffer),n.getBlob(t);if("InvalidStateError"===r.name)return new Blob([e.buffer],{type:t})}},drawHTMLCache={order:[],maxSize:100},cacheLookup=function(e,t){var n;return n=JSON.stringify([e,t]),drawHTMLCache.hasOwnProperty(n)?drawHTMLCache[n]:null},addToCache=function(e,t,n){var r;return r=JSON.stringify([e,t]),drawHTMLCache[r]=n,markUsed(e,t)},markUsed=function(e,t){var n,r;return r=JSON.stringify([e,t]),(n=drawHTMLCache.order.indexOf(r))>-1&&drawHTMLCache.order.splice(n,1),drawHTMLCache.order.unshift(r),pruneCache()},pruneCache=function(){var e;for(e=[];drawHTMLCache.order.length>drawHTMLCache.maxSize;)e.push(delete drawHTMLCache[drawHTMLCache.order.pop()]);return e},CanvasRenderingContext2D.prototype.drawHTML=function(e,t,n,r){var i,s;return null==r&&(r="font-size:12px"),(i=cacheLookup(e,r))?(this.drawImage(i,t,n),markUsed(e,r),!0):(s=objectURLForBlob(svgBlobForHTML(e,r)),i=new Image,i.onload=function(){var t,n;return addToCache(e,r,i),(null!=(t=null!=(n=window.URL)?n:window.webkitURL)?t:window).revokeObjectURL(s)},i.onerror=function(t){return addToCache(e,r,new Image),console.log("Failed to load SVG with this <foreignObject> div content:",e)},i.src=s,!1)},CanvasRenderingContext2D.prototype.measureHTML=function(e,t){var n;return null==t&&(t="font-size:12px"),(n=cacheLookup(e,t))?(markUsed(e,t),{width:n.width,height:n.height}):(this.drawHTML(e,0,0,t),null)},window.objectURLForBlob=function(e){var t,n;return(null!=(t=null!=(n=window.URL)?n:window.webkitURL)?t:window).createObjectURL(e)},window.base64URLForBlob=function(e,t){var n;return n=new FileReader,n.onload=function(e){return t(e.target.result)},n.readAsDataURL(e)},window.installDOMUtilitiesIn=function(e){return e.Node.prototype.address=function(e){var t;return null==e&&(e=null),this===e?[]:this.parentNode?(t=this.parentNode.address(e),null===t?null:t.concat([this.indexInParent()])):e?null:[]},e.Node.prototype.indexInParent=function(){return this.parentNode?Array.prototype.slice.apply(this.parentNode.childNodes).indexOf(this):-1},e.Node.prototype.index=function(e){var t;if(!(e instanceof Array))throw Error("Node address function requires an array");return 0===e.length?this:"number"!=typeof e[0]?void 0:null!=(t=this.childNodes[e[0]])?t.index(e.slice(1)):void 0},e.Node.prototype.toJSON=function(t){var n,r,i,s,o,a;if(null==t&&(t=!0),this instanceof e.Text)return this.textContent;if(this instanceof e.Comment)return t?{comment:!0,content:this.textContent}:{m:!0,n:this.textContent};if(!(this instanceof e.Element))throw Error("Cannot serialize this node: "+this);if(i={tagName:this.tagName},this.attributes.length)for(i.attributes={},a=this.attributes,s=0,o=a.length;o>s;s++)n=a[s],i.attributes[n.name]=n.value;return this.childNodes.length&&(i.children=function(){var e,n,i,s;for(i=this.childNodes,s=[],e=0,n=i.length;n>e;e++)r=i[e],s.push(r.toJSON(t));return s}.call(this)),t||(i.t=i.tagName,delete i.tagName,i.a=i.attributes,delete i.attributes,i.c=i.children,delete i.children),i},e.Node.fromJSON=function(t){var n,r,i,s,o,a,u,l;if("string"==typeof t)return e.document.createTextNode(t);if("comment"in t&&t.comment)return e.document.createComment(t.content);if("m"in t&&t.m)return e.document.createComment(t.n);if(!1 in t&&!1 in t)throw Error("Object has no t[agName]: "+this);if(o=e.document.createElement(t.tagName||t.t),n=t.attributes||t.a)for(s in n)__hasProp.call(n,s)&&(a=n[s],o.setAttribute(s,a));if(i=t.children||t.c)for(u=0,l=i.length;l>u;u++)r=i[u],o.appendChild(Node.fromJSON(r));return o},e.Node.prototype.nextLeaf=function(e){var t;for(null==e&&(e=null),t=this;t&&t!==e&&!t.nextSibling;)t=t.parentNode;if(t=null!=t?t.nextSibling:void 0,!t)return null;for(;t.childNodes.length>0;)t=t.childNodes[0];return t},e.Node.prototype.previousLeaf=function(e){var t;for(null==e&&(e=null),t=this;t&&t!==e&&!t.previousSibling;)t=t.parentNode;if(t=null!=t?t.previousSibling:void 0,!t)return null;for(;t.childNodes.length>0;)t=t.childNodes[t.childNodes.length-1];return t},e.Node.prototype.remove=function(){var e;return null!=(e=this.parentNode)?e.removeChild(this):void 0},e.Element.prototype.hasClass=function(e){var t,n;return t=null!=(n=this.getAttribute("class"))?n.split(/\s+/):void 0,t&&__indexOf.call(t,e)>=0},e.Element.prototype.addClass=function(e){var t,n;return t=(null!=(n=this.getAttribute("class"))?n.split(/\s+/):void 0)||[],__indexOf.call(t,e)<0&&t.push(e),this.setAttribute("class",t.join(" "))},e.Element.prototype.removeClass=function(e){var t,n,r;return n=(null!=(r=this.getAttribute("class"))?r.split(/\s+/):void 0)||[],n=function(){var r,i,s;for(s=[],r=0,i=n.length;i>r;r++)t=n[r],t!==e&&s.push(t);return s}(),n.length>0?this.setAttribute("class",n.join(" ")):this.removeAttribute("class")},e.document.nodeFromPoint=function(t,n){var r,i,s,o,a,u,l,c,p,h;for(r=e.document.elementFromPoint(t,n),p=r.childNodes,a=0,l=p.length;l>a;a++)if(i=p[a],i instanceof e.Text)for(s=e.document.createRange(),s.selectNode(i),h=s.getClientRects(),u=0,c=h.length;c>u;u++)if(o=h[u],o.left<t&&t<o.right&&o.top<n&&n<o.bottom)return i;return r},e.strictNodeOrder=function(e,t){var n;return n=e.compareDocumentPosition(t),Node.DOCUMENT_POSITION_FOLLOWING&n&&!(Node.DOCUMENT_POSITION_CONTAINED_BY&n)},e.strictNodeComparator=function(e,t){return e===t?0:strictNodeOrder(e,t)?-1:1}},installDOMUtilitiesIn(window),null==exports&&(exports=null!=(_ref3="undefined"!=typeof module&&null!==module?module.exports:void 0)?_ref3:window),"undefined"!=typeof require&&null!==require&&require("./utils"),getNext=function(e){return e.pos<e.rhs.length?e.rhs[e.pos]:null},copyState=function(e){return{lhs:e.lhs,rhs:e.rhs,pos:e.pos,ori:e.ori,got:e.got.slice(0)}},equalArrays=function(e,t){var n,r,i,s,o;if(e.length!==t.length)return!1;for(i=s=0,o=e.length;o>s;i=++s)if(n=e[i],r=t[i],n instanceof RegExp){if(!(r instanceof RegExp)||n.source!==r.source)return!1}else if(n!==r)return!1;return!0},exports.Grammar=Grammar=function(){function e(e){this.START=e,this.parse=__bind(this.parse,this),this.addRule=__bind(this.addRule,this),this.setOption=__bind(this.setOption,this),this.rules={},this.defaults={addCategories:!0,collapseBranches:!1,showDebuggingOutput:!1,expressionBuilder:null,tokenizer:null,comparator:JSON.equals,maxIterations:-1}}return e.prototype.setOption=function(e,t){return this.defaults[e]=t},e.prototype.addRule=function(){var e,t,n,r,i,s,o,a,u,l,c;for(e=arguments[0],i=2<=arguments.length?__slice.call(arguments,1):[],c=[],o=0,u=i.length;u>o;o++){for(r=i[o],r instanceof RegExp&&(r=[r]),r instanceof Array||(r=(""+r).split(" ")),n=a=0,l=r.length;l>a;n=++a)t=r[n],t instanceof RegExp&&(r[n]=new RegExp("^"+t.source+"$"));c.push((null!=(s=this.rules)[e]?s[e]:s[e]=[]).push(r))}return c},e.prototype.parse=function(e,t){var n,r,i,s,o,a,u,l,c,p,h,f,d,g,b,m,y,v,x,w,_,O,k,C,M,S,E,N,A,T,F,I,D,B,q,j,L,P,R,J,z,U,V,W,H,Z,G;for(null==t&&(t={}),null==t.addCategories&&(t.addCategories=this.defaults.addCategories),null==t.collapseBranches&&(t.collapseBranches=this.defaults.collapseBranches),null==t.showDebuggingOutput&&(t.showDebuggingOutput=this.defaults.showDebuggingOutput),null==t.expressionBuilder&&(t.expressionBuilder=this.defaults.expressionBuilder),i={},null==t.tokenizer&&(t.tokenizer=this.defaults.tokenizer),null==t.comparator&&(t.comparator=this.defaults.comparator),null==t.maxIterations&&(t.maxIterations=this.defaults.maxIterations),r=t.showDebuggingOutput?function(){return console.log.apply(console,arguments)}:function(){},r("\n\n"),null!=t.tokenizer&&"string"==typeof e&&(e=t.tokenizer.tokenize(e)),w=function(){var t,n,r;for(r=[],a=t=0,n=e.length;n>=0?n>=t:t>=n;a=n>=0?++t:--t)r.push([]);return r}(),w[0].push({lhs:"",rhs:[this.START],pos:0,ori:0,got:[]}),p=0,a=C=0,N=w.length;N>C;a=++C){for(_=w[a],r("processing stateSet "+a+" in this stateGrid (with input "+e+"):"),r("----------------------"),O=M=0,U=w.length;U>=0?U>M:M>U;O=U>=0?++M:--M){for(r("|    state set "+O+":"),v=0,k=S=0,V=w[O].length;V>=0?V>S:S>V;k=V>=0?++S:--S)w[O].length<15||w[O][k].pos>0?r("|        entry "+k+": "+debugState(w[O][k])):v++;v>0&&r("|    (plus "+v+" at pos 0 not shown)")}for(r("----------------------"),u=0;u<_.length;)if(x=_[u],r("entry "+u+":",debugState(x)),c=getNext(x),r("next:",c),null!==c)if(a>=e.length)u++;else if(r("is it a terminal?",c instanceof RegExp),c instanceof RegExp)c.test(e[a])&&(n=copyState(x),n.pos++,n.got.push(e[a]),w[a+1].push(n),r("scanner added this to "+(a+1)+":",debugState(n))),u++;else{if(!this.rules.hasOwnProperty(c))throw"Unknown non-terminal in grammar rule: "+c;for(m=this.rules[c],r("rhss: ["+m.join("],[")+"]"),l=B=0,T=m.length;T>B;l=++B){for(b=m[l],s=!1,q=0,F=_.length;F>q;q++)if(y=_[q],y.lhs===c&&equalArrays(y.rhs,b)&&0===y.pos){s=!0;break}s||(_.push({lhs:c,rhs:b,pos:0,ori:a,got:[]}),r("adding this state:",debugState(_[_.length-1])))}if(u++,p++>(Z=t.maxIterations)&&Z>0)throw"Maximum number of iterations reached."}else{for(r("considering if this completion matters to state set",x.ori),W=w[x.ori],l=E=0,A=W.length;A>E;l=++E)if(y=W[l],getNext(y)===x.lhs&&(y=copyState(y),y.pos++,o=x.got.slice(0),t.addCategories&&o.unshift(x.lhs),null!=t.expressionBuilder&&o.unshift(i),t.collapseBranches&&1===o.length&&(o=o[0]),y.got.push(o),w[a].push(y),r("completer added this to "+a+":",debugState(y)),p++>(H=t.maxIterations)&&H>0))throw"Maximum number of iterations reached.";u++}}for(r("finished processing this stateGrid (with input "+e+"):"),r("----------------------"),O=j=0,G=w.length;G>=0?G>j:j>G;O=G>=0?++j:--j){for(r("|    state set "+O+":"),v=0,k=L=0,J=w[O].length;J>=0?J>L:L>J;k=J>=0?++L:--L)w[O].length<15||w[O][k].pos>0?r("|        entry "+k+": "+debugState(w[O][k])):v++;v>0&&r("|    (plus "+v+" at pos 0 not shown)")}for(r("----------------------"),g=[],z=w[w.length-1],P=0,I=z.length;I>P;P++)if(_=z[P],""===_.lhs&&null===getNext(_)){if(d=_.got[0],null!=t.expressionBuilder&&(f=function(e){var n,r;return e instanceof Array&&e[0]===i?(n=function(){var t,n,i,s;for(i=e.slice(1),s=[],n=0,t=i.length;t>n;n++)r=i[n],s.push(f(r));return s}(),1===n.length&&t.collapseBranches&&(n=n[0]),n.indexOf(void 0)>-1?void 0:t.expressionBuilder(n)):e},d=f(d),null==d))continue;for(s=!1,R=0,D=g.length;D>R;R++)if(h=g[R],t.comparator(h,d)){s=!0;break}s||g.push(d)}return g},e}(),exports.Tokenizer=Tokenizer=function(){function e(){this.tokenize=__bind(this.tokenize,this),this.addType=__bind(this.addType,this),this.tokenTypes=[]}return e.prototype.addType=function(e,t){return null==t&&(t=function(e){return e}),"^"!==e.source[0]&&(e=new RegExp("^(?:"+e.source+")")),this.tokenTypes.push({regexp:e,formatter:t})},e.prototype.tokenize=function(e){var t,n,r,i,s,o,a,u,l,c;for(s=[];e.length>0;){for(i=e.length,c=this.tokenTypes,u=0,l=c.length;l>u;u++)if(a=c[u],n=a.regexp.exec(e)){if(e=e.slice(n[0].length),a.formatter instanceof Function)r=a.formatter(n[0],n),null!=r&&s.push(r);else{for(t=""+a.formatter,o="";r=/\%([0-9]+)/.exec(t);)o+=t.slice(0,r.index)+n[r[1]],t=t.slice(r.index+r[0].length);s.push(o+t)}break}if(e.length===i)return null}return s},e}(),debugNestedArrays=function(e){return e instanceof Array?("{}"===JSON.stringify(e[0])&&(e=e.slice(1)),"["+e.map(debugNestedArrays).join(",")+"]"):e},debugState=function(e){return"("+e.lhs+" -> "+e.pos+"in["+e.rhs+"], "+e.ori+") got "+debugNestedArrays(e.got)},null==exports&&(exports=null!=(_ref4="undefined"!=typeof module&&null!==module?module.exports:void 0)?_ref4:window),"undefined"!=typeof require&&null!==require&&(_ref5=require("./openmath-duo"),OM=_ref5.OM,OMNode=_ref5.OMNode),metavariableSymbol=OM.symbol("metavariable","lurch"),trueValue=OM.string("true"),exports.setMetavariable=setMetavariable=function(e){var t;if(e instanceof OMNode&&("v"===(t=e.type)||"sy"===t))return e.setAttribute(metavariableSymbol,trueValue.copy())},exports.clearMetavariable=clearMetavariable=function(e){return e.removeAttribute(metavariableSymbol)},exports.isMetavariable=isMetavariable=function(e){var t,n;return e instanceof OMNode&&("v"===(t=e.type)||"sy"===t)&&(null!=(n=e.getAttribute(metavariableSymbol))?n.equals(trueValue):void 0)},exports.Match=Match=function(){function e(){this.toString=__bind(this.toString,this),this.copy=__bind(this.copy,this),this.applyTo=__bind(this.applyTo,this),this.keys=__bind(this.keys,this),this.has=__bind(this.has,this),this.clear=__bind(this.clear,this),this.get=__bind(this.get,this),this.set=__bind(this.set,this),this.map={}}return e.prototype.set=function(e,t){return null!=e.simpleEncode&&(e=e.simpleEncode()),this.map[e]=t.copy()},e.prototype.get=function(e){var t;return this.map[null!=(t="function"==typeof e.simpleEncode?e.simpleEncode():void 0)?t:e]},e.prototype.clear=function(e){var t;return e=null!=(t="function"==typeof e.simpleEncode?e.simpleEncode():void 0)?t:e,delete this.map[e]},e.prototype.has=function(e){var t;return this.map.hasOwnProperty(null!=(t="function"==typeof e.simpleEncode?e.simpleEncode():void 0)?t:e)},e.prototype.keys=function(){return Object.keys(this.map)},e.prototype.applyTo=function(e){var t,n,r,i,s;for(n=e.copy(),s=n.descendantsSatisfying(isMetavariable),r=0,i=s.length;i>r;r++)t=s[r],this.has(t)&&t.replaceWith(this.get(t).copy());return n},e.expressionFunction=OM.symbol("EF","lurch"),e.expressionFunctionApplication=OM.symbol("EFA","lurch"),e.makeExpressionFunction=function(t,n){if("v"!==t.type)throw"When creating an expression function, its parameter must be a variable";return OM.bin(e.expressionFunction,t,n)},e.isExpressionFunction=function(t){return"bi"===t.type&&1===t.variables.length&&t.symbol.equals(e.expressionFunction)},e.makeExpressionFunctionApplication=function(t,n){return OM.app(e.expressionFunctionApplication,t,n)},e.isExpressionFunctionApplication=function(t){var n;return n=t.children,"a"===t.type&&3===n.length&&n[0].equals(e.expressionFunctionApplication)},e.prototype.copy=function(){var e,t,n,r;t=new Match,r=this.map;for(e in r)__hasProp.call(r,e)&&(n=r[e],t.map[e]=n.copy());return t},e.prototype.toString=function(){var e,t,n,r,i;t="{",i=null!=(r=this.map)?r:{};for(e in i)__hasProp.call(i,e)&&(n=i[e],t.length>1&&(t+=","),t+=""+e+":"+n.simpleEncode());return t+"}"},e}(),newVariableNotIn=function(){var e,t,n,r;for(e=1<=arguments.length?__slice.call(arguments,0):[],t=0,n=function(){return OM["var"]("v"+t)},r=function(){var t,r,i,s,o;for(t=n(),i=function(e){return e.equals(t,!1)},s=0,o=e.length;o>s;s++)if(r=e[s],r.hasDescendantSatisfying(i))return!1;return!0};!r();)t++;return n()},exports.debugOn=!1,udebug=function(){var e;return e=1<=arguments.length?__slice.call(arguments,0):[],exports.debugOn?console.log.apply(console,e):void 0},exports.unify=unify=function(e,t,n){var r,i,s,o,a,u,l,c,p,h,f,d,g,b,m,y,v,x,w,_,O,k,C,M,S,E,N,A,T,F,I,D,B,q,j,L,P,R,J,z,U,V;if(null==n&&(n=new Match),udebug("\nunify",e.simpleEncode(),t.simpleEncode()),t.hasDescendantSatisfying(isMetavariable))throw"Unifier rejects expressions containing metavariables";for(O=function(){return newVariableNotIn(e,t)},E=[{constraints:[{pattern:e,expression:t}],solution:n}];;){for(y=0;y<E.length&&0===E[y].constraints.length;)y++;if(udebug("	loop",y,"in",function(){var e,t,n,r;for(r=[],e=0,t=E.length;t>e;e++)u=E[e],r.push(""+function(){var e,t,n,r,i,s;for(n=u.constraints,s=[],e=0,t=n.length;t>e;e++)d=n[e],s.push("("+(null!=(r=d.pattern)?r.simpleEncode():void 0)+","+(null!=(i=d.expression)?i.simpleEncode():void 0)+")");return s}()+(null!=(n=u.solution)?n.toString():void 0));return r}().join(" ; ")),y>=E.length){for(udebug("	about to check constraints and return solutions"),I=0,j=E.length;j>I;I++)M=E[I],udebug("		would",e.simpleEncode(),"and",null!=(J=M.solution)?J.toString():void 0,"violate capture constraints?",M.solution?violatesCaptureConstraints(e,M.solution):"N/A");return function(){var t,n,r;for(r=[],t=0,n=E.length;n>t;t++)M=E[t],null===M.solution||violatesCaptureConstraints(e,M.solution)||r.push(M.solution);return r}()}if(l=E[y],m=l.constraints.shift(),u=m.pattern,r=m.expression,c=l.solution,p=function(e,t,n){var r,i,s,o;if("push"===e||"unshift"===e){for(o=l.constraints,i=0,s=o.length;s>i;i++)if(r=o[i],r.pattern.equals(t)&&r.expression.equals(n))return;return l.constraints[e]({pattern:t,expression:n})}},"a"===(z=u.type)||"bi"===z||"e"===z||isMetavariable(u))if(isMetavariable(u))c.has(u)?p("push",c.get(u),r):c.set(u,r);else if("bi"===u.type?(S=[u.symbol].concat(__slice.call(u.variables),[u.body]),b=[r.symbol].concat(__slice.call(r.variables),[r.body])):(S=u.children,b=r.children),Match.isExpressionFunctionApplication(u)){if(s=S[1],A=S[2],!isMetavariable(s))throw"First argument to an expression function must be a metavariable";if(C=function(){var e,t,n,r;for(n=l.constraints,r=[],e=0,t=n.length;t>e;e++)d=n[e],Match.isExpressionFunctionApplication(d.pattern)||r.push(d);return r}(),C.length>0)udebug("		delaying substitution forms..."),p("push",u,r);else if(c.has(s))udebug("		the ef is in the solution set"),f=c.get(s).body.copy(),f.replaceFree(c.get(s).variables[0],A),p("unshift",f,r);else{for(V=l.constraints,B=0,L=V.length;L>B;B++)if(g=V[B],w=function(e){return e.equals(A)},x=function(e){return e.equals(s)},g.pattern.hasDescendantSatisfying(w)&&!g.pattern.hasDescendantSatisfying(x))throw"Parameter of one function application appears in another function application; this level of complexity is not supported by this unification algorithm.";for(h=-1,R=l.constraints,v=q=0,P=R.length;P>q;v=++q)if(g=R[v],Match.isExpressionFunctionApplication(g.pattern)&&g.pattern.children[1].equals(s)){h=v;break}-1!==h?(F=l.constraints[h].pattern.children[2],i=l.constraints[h].expression,l.constraints.splice(h,1),_=merge(s,r,i,A,F,c),E.splice.apply(E,[y,1].concat(__slice.call(function(){var e,t,n;for(n=[],t=0,e=_.length;e>t;t++)o=_[t],n.push({constraints:l.constraints.slice(0),solution:o.copy()});return n}()))),udebug("		merging with index",h)):(a=O(),c.has(A)?(T=c.get(A),udebug("		exponential explosion w/v",T.simpleEncode(),"and E",r.simpleEncode()),k=allBinaryFunctions(r,T,a,c,s),E.splice.apply(E,[y,1].concat(__slice.call(function(){var e,t,n;for(n=[],t=0,e=k.length;e>t;t++)N=k[t],n.push({constraints:l.constraints.slice(0),solution:N});return n}())))):(c.set(s,Match.makeExpressionFunction(a,a)),c.set(A,r),udebug("		1 constraint w/this func, v known")))}}else if(u.type!==r.type||S.length!==b.length)l.constraints=[],l.solution=null;else for(v=D=U=S.length-1;0>=U?0>=D:D>=0;v=0>=U?++D:--D)p("unshift",S[v],b[v]);else u.equals(r,!1)||(l.constraints=[],l.solution=null)}},merge=function(e,t,n,r,i,s){var o,a,u,l,c,p,h,f,d,g,b,m,y,v,x,w,_,O,k,C,M,S,E,N,A,T,F,I,D,B,q,j,L,P,R,J,z,U,V,W;if(udebug("\nmerge F:",e.simpleEncode(),", E:",t.simpleEncode(),", E':",n.simpleEncode(),", v:",r.simpleEncode(),", v':",i.simpleEncode(),", S:",s.toString()),x=function(){return newVariableNotIn(e,t,n,r,i)},t.hasDescendantSatisfying(Match.isExpressionFunctionApplication)||n.hasDescendantSatisfying(Match.isExpressionFunctionApplication))throw"The merge algorithm does not support expressions containing applications of expression functions.";if(d=[],findDifferencesBetween=function(e,r){var i,s,o,a,u,l,c,p;if(udebug("			diff",e.simpleEncode(),e.address(t),r.simpleEncode(),r.address(n)),e.type!==r.type)return udebug("			types diff;",e.address(t)),void d.push(e.address(t));if("bi"===e.type?(i=[e.symbol].concat(__slice.call(e.variables),[e.body]),s=[r.symbol].concat(__slice.call(r.variables),[r.body])):(i=e.children,s=r.children),udebug("			children:",function(){var e,t,n;for(n=[],e=0,t=i.length;t>e;e++)o=i[e],n.push(o.simpleEncode());return n}().join(","),";",function(){var e,t,n;for(n=[],e=0,t=s.length;t>e;e++)o=s[e],n.push(o.simpleEncode());return n}().join(",")),i.length!==s.length||i.length+s.length===0&&!e.equals(r,!1))return udebug("			non-recursive difference;",e.address(t)),d.push(e.address(t));for(p=[],u=l=0,c=i.length;c>l;u=++l)a=i[u],p.push(findDifferencesBetween(a,s[u]));return p},findDifferencesBetween(t,n),0===d.length){if(udebug("	no differences!"),b=function(e){return!isMetavariable(e)||s.has(e)},A=function(e){return isMetavariable(e)?s.get(e):e},udebug("		v known?",b(r),"value",null!=(z=A(r))?z.simpleEncode():void 0,"v' known?",b(i),"value",null!=(U=A(i))?U.simpleEncode():void 0),u=x(),b(r)&&b(i))return A(r).equals(A(i))?allBinaryFunctions(t,A(r),u,s,e):(s.set(e,Match.makeExpressionFunction(u,t)),[s]);if(b(r)){for(w=allBinaryFunctions(t,A(r),u,s,e),V=w.slice(1),T=0,B=V.length;B>T;T++)M=V[T],M.set(i,A(r));return udebug("		known/unknown result:",function(){var e,t,n;for(n=[],e=0,t=w.length;t>e;e++)k=w[e],n.push(k.toString());return n}().join(" ; ")),w}if(b(i)){for(w=allBinaryFunctions(t,A(i),u,s,e),W=w.slice(1),F=0,q=W.length;q>F;F++)M=W[F],M.set(r,A(i));
return udebug("		unknown/known result:",function(){var e,t,n;for(n=[],e=0,t=w.length;t>e;e++)k=w[e],n.push(k.toString());return n}().join(" ; ")),w}return s.set(e,Match.makeExpressionFunction(u,t)),[s]}for(E=[];;){for(udebug("	differences: [",function(){var e,t,n;for(n=[],e=0,t=d.length;t>e;e++)h=d[e],n.push("["+h+"]");return n}().join(" ; "),"]"),udebug("		recursively calling unify..."),_=x(),p=t.copy(),I=0,j=d.length;j>I;I++)l=d[I],p.index(l).replaceWith(_.copy());for(g=Match.makeExpressionFunction(_,p),o=p.copy(),o.replaceFree(_,r),a=p.copy(),a.replaceFree(_,i),m=OM.app(o,a),O=OM.app(t,n),udebug("			func",g.simpleEncode()),udebug("			F(v)",o.simpleEncode(),"F(v')",a.simpleEncode()),udebug("			E",t.simpleEncode(),"E'",n.simpleEncode()),J=unify(m,O,s.copy()),D=0,L=J.length;L>D;D++)S=J[D],S.set(e,g),E.push(S);for(udebug("		after recursion, extended solutions:"),udebug("		",function(){var e,t,n;for(n=[],t=0,e=E.length;e>t;t++)k=E[t],n.push(k.toString());return n}().join(" ; ")),y=[],v=[],N=!1,R=0,P=d.length;P>R;R++){if(f=d[R],0===f.length){N=!0;break}C=f.slice(0,-1),c=""+C,__indexOf.call(v,c)<0&&(y.push(C),v.push(c))}if(N)break;d=y}return udebug("	finishing merge with these solutions:"),udebug("		",function(){var e,t,n;for(n=[],t=0,e=E.length;e>t;t++)k=E[t],n.push(k.toString());return n}().join(" ; ")),E},violatesCaptureConstraints=function(e,t,n){var r,i,s,o,a,u,l,c,p,h;if(null==n&&(n=[]),isMetavariable(e)){for(p=t.get(e).freeVariables(),a=0,l=p.length;l>a;a++)if(i=p[a],__indexOf.call(n,i)>=0)return!0;return!1}if("bi"===e.type)return s=function(){var n,r,i,s;for(i=e.variables,s=[],n=0,r=i.length;r>n;n++)o=i[n],s.push(isMetavariable(o)?t.get(o).name:o.name);return s}(),violatesCaptureConstraints(e.body,t,n.concat(s));if(Match.isExpressionFunctionApplication(e))return violatesCaptureConstraints(e.children[1],t,n);for(h=e.children,u=0,c=h.length;c>u;u++)if(r=h[u],violatesCaptureConstraints(r,t,n))return!0;return!1},allBinaryFunctions=function(e,t,n,r,i){var s,o,a,u,l,c,p,h,f,d,g;if(s=function(){var n,r,i,s;for(i=e.descendantsSatisfying(function(e){return e.equals(t)}),s=[],n=0,r=i.length;r>n;n++)c=i[n],s.push(c.address(e));return s}(),s.length>4)throw"Problem size growing too large for the unification algorithm";for(g=[],o=p=0,f=1<<s.length;f>=0?f>p:p>f;o=f>=0?++p:--p){for(a=e.copy(),l=r.copy(),u=h=0,d=s.length;d>=0?d>h:h>d;u=d>=0?++h:--h)o&1<<u&&a.index(s[u]).replaceWith(n.copy());l.set(i,Match.makeExpressionFunction(n,a)),g.push(l)}return g}}).call(this);
//# sourceMappingURL=weblurch.min.js.map