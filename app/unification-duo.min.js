(function(){var n,e,t,i,o,r,s,l,u,a,c,p,f,h,d,g,y,m=function(n,e){return function(){return n.apply(e,arguments)}},v={}.hasOwnProperty,E=[].slice,b=[].indexOf||function(n){for(var e=0,t=this.length;t>e;e++)if(e in this&&this[e]===n)return e;return-1};("undefined"==typeof r||null===r)&&(r=null!=(g="undefined"!=typeof module&&null!==module?module.exports:void 0)?g:window),"undefined"!=typeof require&&null!==require&&(y=require("./openmath-duo"),e=y.OM,t=y.OMNode),u=e.symbol("metavariable","lurch"),p=e.string("true"),r.setMetavariable=c=function(n){var e;if(n instanceof t&&("v"===(e=n.type)||"sy"===e))return n.setAttribute(u,p.copy())},r.clearMetavariable=o=function(n){return n.removeAttribute(u)},r.isMetavariable=s=function(n){var e,i;return n instanceof t&&("v"===(e=n.type)||"sy"===e)&&(null!=(i=n.getAttribute(u))?i.equals(p):void 0)},r.Match=n=function(){function t(){this.toString=m(this.toString,this),this.copy=m(this.copy,this),this.applyTo=m(this.applyTo,this),this.keys=m(this.keys,this),this.has=m(this.has,this),this.clear=m(this.clear,this),this.get=m(this.get,this),this.set=m(this.set,this),this.map={}}return t.prototype.set=function(n,e){return null!=n.simpleEncode&&(n=n.simpleEncode()),this.map[n]=e.copy()},t.prototype.get=function(n){var e;return this.map[null!=(e="function"==typeof n.simpleEncode?n.simpleEncode():void 0)?e:n]},t.prototype.clear=function(n){var e;return n=null!=(e="function"==typeof n.simpleEncode?n.simpleEncode():void 0)?e:n,delete this.map[n]},t.prototype.has=function(n){var e;return this.map.hasOwnProperty(null!=(e="function"==typeof n.simpleEncode?n.simpleEncode():void 0)?e:n)},t.prototype.keys=function(){return Object.keys(this.map)},t.prototype.applyTo=function(n){var e,t,i,o,r;for(t=n.copy(),r=t.descendantsSatisfying(s),i=0,o=r.length;o>i;i++)e=r[i],this.has(e)&&e.replaceWith(this.get(e).copy());return t},t.expressionFunction=e.symbol("EF","lurch"),t.expressionFunctionApplication=e.symbol("EFA","lurch"),t.makeExpressionFunction=function(n,i){if("v"!==n.type)throw"When creating an expression function, its parameter must be a variable";return e.bin(t.expressionFunction,n,i)},t.isExpressionFunction=function(n){return"bi"===n.type&&1===n.variables.length&&n.symbol.equals(t.expressionFunction)},t.makeExpressionFunctionApplication=function(n,i){return e.app(t.expressionFunctionApplication,n,i)},t.isExpressionFunctionApplication=function(n){var e;return e=n.children,"a"===n.type&&3===e.length&&e[0].equals(t.expressionFunctionApplication)},t.prototype.copy=function(){var e,t,i,o;t=new n,o=this.map;for(e in o)v.call(o,e)&&(i=o[e],t.map[e]=i.copy());return t},t.prototype.toString=function(){var n,e,t,i,o;e="{",o=null!=(i=this.map)?i:{};for(n in o)v.call(o,n)&&(t=o[n],e.length>1&&(e+=","),e+=""+n+":"+t.simpleEncode());return e+"}"},t}(),a=function(){var n,t,i,o;for(n=1<=arguments.length?E.call(arguments,0):[],t=0,i=function(){return e["var"]("v"+t)},o=function(){var e,t,o,r,s;for(e=i(),o=function(n){return n.equals(e,!1)},r=0,s=n.length;s>r;r++)if(t=n[r],t.hasDescendantSatisfying(o))return!1;return!0};!o();)t++;return i()},r.debugOn=!1,f=function(){var n;return n=1<=arguments.length?E.call(arguments,0):[],r.debugOn?console.log.apply(console,n):void 0},r.unify=h=function(e,t,o){var r,u,c,p,h,g,y,m,v,b,x,F,w,k,S,q,A,j,O,D,M,P,T,W,N,z,U,V,B,C,G,H,I,J,K,L,Q,R,X,Y,Z,$;if(null==o&&(o=new n),f("\nunify",e.simpleEncode(),t.simpleEncode()),t.hasDescendantSatisfying(s))throw"Unifier rejects expressions containing metavariables";for(M=function(){return a(e,t)},z=[{constraints:[{pattern:e,expression:t}],solution:o}];;){for(q=0;q<z.length&&0===z[q].constraints.length;)q++;if(f("	loop",q,"in",function(){var n,e,t,i;for(i=[],n=0,e=z.length;e>n;n++)g=z[n],i.push(""+function(){var n,e,t,i,o,r;for(t=g.constraints,r=[],n=0,e=t.length;e>n;n++)F=t[n],r.push("("+(null!=(i=F.pattern)?i.simpleEncode():void 0)+","+(null!=(o=F.expression)?o.simpleEncode():void 0)+")");return r}()+(null!=(t=g.solution)?t.toString():void 0));return i}().join(" ; ")),q>=z.length){for(f("	about to check constraints and return solutions"),G=0,K=z.length;K>G;G++)W=z[G],f("		would",e.simpleEncode(),"and",null!=(R=W.solution)?R.toString():void 0,"violate capture constraints?",W.solution?d(e,W.solution):"N/A");return function(){var n,t,i;for(i=[],n=0,t=z.length;t>n;n++)W=z[n],null===W.solution||d(e,W.solution)||i.push(W.solution);return i}()}if(y=z[q],S=y.constraints.shift(),g=S.pattern,r=S.expression,m=y.solution,v=function(n,e,t){var i,o,r,s;if("push"===n||"unshift"===n){for(s=y.constraints,o=0,r=s.length;r>o;o++)if(i=s[o],i.pattern.equals(e)&&i.expression.equals(t))return;return y.constraints[n]({pattern:e,expression:t})}},"a"===(X=g.type)||"bi"===X||"e"===X||s(g))if(s(g))m.has(g)?v("push",m.get(g),r):m.set(g,r);else if("bi"===g.type?(N=[g.symbol].concat(E.call(g.variables),[g.body]),k=[r.symbol].concat(E.call(r.variables),[r.body])):(N=g.children,k=r.children),n.isExpressionFunctionApplication(g)){if(c=N[1],V=N[2],!s(c))throw"First argument to an expression function must be a metavariable";if(T=function(){var e,t,i,o;for(i=y.constraints,o=[],e=0,t=i.length;t>e;e++)F=i[e],n.isExpressionFunctionApplication(F.pattern)||o.push(F);return o}(),T.length>0)f("		delaying substitution forms..."),v("push",g,r);else if(m.has(c))f("		the ef is in the solution set"),x=m.get(c).body.copy(),x.replaceFree(m.get(c).variables[0],V),v("unshift",x,r);else{for(Z=y.constraints,I=0,L=Z.length;L>I;I++)if(w=Z[I],O=function(n){return n.equals(V)},j=function(n){return n.equals(c)},w.pattern.hasDescendantSatisfying(O)&&!w.pattern.hasDescendantSatisfying(j))throw"Parameter of one function application appears in another function application; this level of complexity is not supported by this unification algorithm.";for(b=-1,$=y.constraints,A=J=0,Q=$.length;Q>J;A=++J)if(w=$[A],n.isExpressionFunctionApplication(w.pattern)&&w.pattern.children[1].equals(c)){b=A;break}-1!==b?(C=y.constraints[b].pattern.children[2],u=y.constraints[b].expression,y.constraints.splice(b,1),D=l(c,r,u,V,C,m),z.splice.apply(z,[q,1].concat(E.call(function(){var n,e,t;for(t=[],e=0,n=D.length;n>e;e++)p=D[e],t.push({constraints:y.constraints.slice(0),solution:p.copy()});return t}()))),f("		merging with index",b)):(h=M(),m.has(V)?(B=m.get(V),f("		exponential explosion w/v",B.simpleEncode(),"and E",r.simpleEncode()),P=i(r,B,h,m,c),z.splice.apply(z,[q,1].concat(E.call(function(){var n,e,t;for(t=[],e=0,n=P.length;n>e;e++)U=P[e],t.push({constraints:y.constraints.slice(0),solution:U});return t}())))):(m.set(c,n.makeExpressionFunction(h,h)),m.set(V,r),f("		1 constraint w/this func, v known")))}}else if(g.type!==r.type||N.length!==k.length)y.constraints=[],y.solution=null;else for(A=H=Y=N.length-1;0>=Y?0>=H:H>=0;A=0>=Y?++H:--H)v("unshift",N[A],k[A]);else g.equals(r,!1)||(y.constraints=[],y.solution=null)}},l=function(t,o,r,l,u,c){var p,d,g,y,m,v,x,F,w,k,S,q,A,j,O,D,M,P,T,W,N,z,U,V,B,C,G,H,I,J,K,L,Q,R,X,Y,Z,$,_,nn,en;if(f("\nmerge F:",t.simpleEncode(),", E:",o.simpleEncode(),", E':",r.simpleEncode(),", v:",l.simpleEncode(),", v':",u.simpleEncode(),", S:",c.toString()),D=function(){return a(t,o,r,l,u)},o.hasDescendantSatisfying(n.isExpressionFunctionApplication)||r.hasDescendantSatisfying(n.isExpressionFunctionApplication))throw"The merge algorithm does not support expressions containing applications of expression functions.";if(w=[],k=function(n,e){var t,i,s,l,u,a,c,p;if(f("			diff",n.simpleEncode(),n.address(o),e.simpleEncode(),e.address(r)),n.type!==e.type)return f("			types diff;",n.address(o)),void w.push(n.address(o));if("bi"===n.type?(t=[n.symbol].concat(E.call(n.variables),[n.body]),i=[e.symbol].concat(E.call(e.variables),[e.body])):(t=n.children,i=e.children),f("			children:",function(){var n,e,i;for(i=[],n=0,e=t.length;e>n;n++)s=t[n],i.push(s.simpleEncode());return i}().join(","),";",function(){var n,e,t;for(t=[],n=0,e=i.length;e>n;n++)s=i[n],t.push(s.simpleEncode());return t}().join(",")),t.length!==i.length||t.length+i.length===0&&!n.equals(e,!1))return f("			non-recursive difference;",n.address(o)),w.push(n.address(o));for(p=[],u=a=0,c=t.length;c>a;u=++a)l=t[u],p.push(k(l,i[u]));return p},k(o,r),0===w.length){if(f("	no differences!"),q=function(n){return!s(n)||c.has(n)},C=function(n){return s(n)?c.get(n):n},f("		v known?",q(l),"value",null!=(Z=C(l))?Z.simpleEncode():void 0,"v' known?",q(u),"value",null!=($=C(u))?$.simpleEncode():void 0),g=D(),q(l)&&q(u))return C(l).equals(C(u))?i(o,C(l),g,c,t):(c.set(t,n.makeExpressionFunction(g,o)),[c]);if(q(l)){for(M=i(o,C(l),g,c,t),_=M.slice(1),G=0,K=_.length;K>G;G++)z=_[G],z.set(u,C(l));return f("		known/unknown result:",function(){var n,e,t;for(t=[],n=0,e=M.length;e>n;n++)W=M[n],t.push(W.toString());return t}().join(" ; ")),M}if(q(u)){for(M=i(o,C(u),g,c,t),nn=M.slice(1),H=0,L=nn.length;L>H;H++)z=nn[H],z.set(l,C(u));return f("		unknown/known result:",function(){var n,e,t;for(t=[],n=0,e=M.length;e>n;n++)W=M[n],t.push(W.toString());return t}().join(" ; ")),M}return c.set(t,n.makeExpressionFunction(g,o)),[c]}for(V=[];;){for(f("	differences: [",function(){var n,e,t;for(t=[],n=0,e=w.length;e>n;n++)x=w[n],t.push("["+x+"]");return t}().join(" ; "),"]"),f("		recursively calling unify..."),P=D(),v=o.copy(),I=0,Q=w.length;Q>I;I++)y=w[I],v.index(y).replaceWith(P.copy());for(S=n.makeExpressionFunction(P,v),p=v.copy(),p.replaceFree(P,l),d=v.copy(),d.replaceFree(P,u),A=e.app(p,d),T=e.app(o,r),f("			func",S.simpleEncode()),f("			F(v)",p.simpleEncode(),"F(v')",d.simpleEncode()),f("			E",o.simpleEncode(),"E'",r.simpleEncode()),en=h(A,T,c.copy()),J=0,R=en.length;R>J;J++)U=en[J],U.set(t,S),V.push(U);for(f("		after recursion, extended solutions:"),f("		",function(){var n,e,t;for(t=[],e=0,n=V.length;n>e;e++)W=V[e],t.push(W.toString());return t}().join(" ; ")),j=[],O=[],B=!1,Y=0,X=w.length;X>Y;Y++){if(F=w[Y],0===F.length){B=!0;break}N=F.slice(0,-1),m=""+N,b.call(O,m)<0&&(j.push(N),O.push(m))}if(B)break;w=j}return f("	finishing merge with these solutions:"),f("		",function(){var n,e,t;for(t=[],e=0,n=V.length;n>e;e++)W=V[e],t.push(W.toString());return t}().join(" ; ")),V},d=function(e,t,i){var o,r,l,u,a,c,p,f,h,g;if(null==i&&(i=[]),s(e)){for(h=t.get(e).freeVariables(),a=0,p=h.length;p>a;a++)if(r=h[a],b.call(i,r)>=0)return!0;return!1}if("bi"===e.type)return l=function(){var n,i,o,r;for(o=e.variables,r=[],n=0,i=o.length;i>n;n++)u=o[n],r.push(s(u)?t.get(u).name:u.name);return r}(),d(e.body,t,i.concat(l));if(n.isExpressionFunctionApplication(e))return d(e.children[1],t,i);for(g=e.children,c=0,f=g.length;f>c;c++)if(o=g[c],d(o,t,i))return!0;return!1},i=function(e,t,i,o,r){var s,l,u,a,c,p,f,h,d,g,y;if(s=function(){var n,i,o,r;for(o=e.descendantsSatisfying(function(n){return n.equals(t)}),r=[],n=0,i=o.length;i>n;n++)p=o[n],r.push(p.address(e));return r}(),s.length>4)throw"Problem size growing too large for the unification algorithm";for(y=[],l=f=0,d=1<<s.length;d>=0?d>f:f>d;l=d>=0?++f:--f){for(u=e.copy(),c=o.copy(),a=h=0,g=s.length;g>=0?g>h:h>g;a=g>=0?++h:--h)l&1<<a&&u.index(s[a]).replaceWith(i.copy());c.set(r,n.makeExpressionFunction(i,u)),y.push(c)}return y}}).call(this);
//# sourceMappingURL=unification-duo.min.js.map