(function(){var t,e,n,o,i,r,s,l,u,a,c,d,p,h,f,g,m,y,v,w,b,C,k,x,I,S,M,T,A,N,D,O,L,E,R,U={}.hasOwnProperty,B=function(t,e){return function(){return t.apply(e,arguments)}},F=[].slice,G=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};t=function(){function t(t){this.editor=t,this.length=0}return t.prototype.getFileMetadata=function(t,e){var n;if(null!==e)return null===t&&(t="."),n=new FileSystem(this.editor.LoadSave.fileSystem),n.cd(t),n.read(e)[1]},t.prototype["import"]=function(t){var e,n,o,i,r;for(e=n=0,i=this.length;i>=0?i>n:n>i;e=i>=0?++n:--n)delete this[e];for(e=o=0,r=this.length=t.length;r>=0?r>o:o>r;e=r>=0?++o:--o)this[e]=JSON.parse(JSON.stringify(t[e]));return this.update()},t.prototype["export"]=function(){var t,e,n,o;for(o=[],t=e=0,n=this.length;n>=0?n>e:e>n;t=n>=0?++e:--e)o.push(JSON.parse(JSON.stringify(this[t])));return o},t.prototype.update=function(t){var e,n,o,i,r,s,l;if(null==t)return function(){var t,e,n;for(n=[],i=t=0,e=this.length;e>=0?e>t:t>e;i=e>=0?++t:--t)n.push(this.update(i));return n}.call(this);if(t>=0&&t<this.length)return e=this[t],"file://"!==e.address.slice(0,7)?"wiki://"===e.address.slice(0,7)?(s=e.address.slice(7),this.editor.MediaWiki.getPageTimestamp(s,function(n){return function(o,i){var r,l;if(null!=o&&(l=new Date(o),r=new Date(e.date),l>r))return n.editor.MediaWiki.getPageMetadata(s,function(e){return null!=e&&JSON.stringify(n[t])!==JSON.stringify(e.exports)?(n[t].data=e.exports,n[t].date=l,n.editor.fire("dependenciesChanged")):void 0})}}(this))):this.editor.fire("dependenciesChanged"):(l=e.address.lastIndexOf("/"),n=e.address.slice(l),o=e.address.slice(7,l),r=this.getFileMetadata(o,n).exports,JSON.stringify(r)!==JSON.stringify(this[t])?(this[t].data=r,this[t].date=new Date,this.editor.fire("dependenciesChanged")):void 0)},t.prototype.add=function(t,e){var n,o,i,r,s,l;if("file://"===t.slice(0,7)){l=t.lastIndexOf("/"),o=t.slice(l),i=t.slice(7,l);try{return r=this.getFileMetadata(i,o).exports,this[this.length++]={address:t,data:r,date:new Date},"function"==typeof e&&e(r,null),this.editor.fire("dependenciesChanged")}catch(u){return n=u,"function"==typeof e?e(null,n):void 0}}else if("wiki://"===t.slice(0,7))return s=t.slice(7),this.editor.MediaWiki.getPageTimestamp(s,function(n){return function(o,i){return null==o?"function"==typeof e?e(null,"Could not get wiki page timestamp"):void 0:n.editor.MediaWiki.getPageMetadata(s,function(i){return null==i?"function"==typeof e?e(null,"Could not access wiki page"):void 0:(n[n.length++]={address:t,data:i.exports,date:new Date(o)},"function"==typeof e&&e(i.exports,null),n.editor.fire("dependenciesChanged"))})}}(this))},t.prototype.remove=function(t){var e,n,o;if(t>=0&&t<this.length){for(e=n=t,o=this.length-1;o>=t?o>n:n>o;e=o>=t?++n:--n)this[e]=this[e+1];return delete this[--this.length],this.editor.fire("dependenciesChanged")}},t.prototype.installUI=function(t){var e,n,o,i,r,s,l,u;for(i=[],o=r=0,l=this.length;l>r;o=++r)e=this[o],i.push(this.editor.Settings.UI.generalPair(e.address,this.editor.Settings.UI.button("Remove","dependencyRemove"+o),"dependencyRow"+o,80,"center"));for(0===this.length&&i.push(this.editor.Settings.UI.info("(no dependencies)")),i.push(this.editor.Settings.UI.info(""+this.editor.Settings.UI.button("Add file dependency","dependencyAddFile")+" "+this.editor.Settings.UI.button("Add wiki page dependency","dependencyAddWiki"))),t.innerHTML=i.join("\n"),n=function(e){return t.ownerDocument.getElementById(e)},o=s=0,u=this.length;u>s;o=++s)e=this[o],n("dependencyRemove"+o).addEventListener("click",function(e){return function(n){return function(){return e.remove(n),e.installUI(t)}}}(this)(o));return n("dependencyAddFile").addEventListener("click",function(e){return function(){return e.editor.LoadSave.tryToOpen(function(n,o){return null!=o?(null!=n?n+="/":n="",e.add("file://"+n+o,function(n,o){return null!=o?e.editor.Dialogs.alert({title:"Error adding dependency",message:o}):e.installUI(t)})):void 0})}}(this)),n("dependencyAddWiki").addEventListener("click",function(e){return function(){var n;return(n=prompt("Enter the wiki page name of the dependency to add.","Example Page Name"))?e.add("wiki://"+n,function(n,o){return null!=o?e.editor.Dialogs.alert({title:"Error adding dependency",message:o}):e.installUI(t)}):void 0}}(this))},t}(),tinymce.PluginManager.add("dependencies",function(e,n){return e.Dependencies=new t(e)}),e={},L=function(t){var e;return e=function(){var t,e,n,o,i,r;for(e=function(t,e){var n,o,i,r,s;for(r=document.getElementsByTagName(t),s=[],o=0,i=r.length;i>o;o++)n=r[o],s.push(n.addEventListener(e,function(t){return parent.postMessage({value:t.currentTarget.value,id:t.currentTarget.getAttribute("id")},"*")}));return s},e("a","click"),e("input","click"),e("input","input"),i=document.getElementsByTagName("input"),n=0,o=i.length;o>n;n++)t=i[n],"file"===t.getAttribute("type")&&t.addEventListener("change",function(){var t;return t=new FileReader,t.onload=function(t){return function(e){return parent.postMessage({value:e.target.result,id:t.getAttribute("id")},"*")}}(this),t.readAsDataURL(this.files[0])});return null!=(r=document.getElementsByTagName("input")[0])?r.focus():void 0},window.objectURLForBlob(window.makeBlob(t+("<script>("+e+")()</script>"),"text/html;charset=utf-8"))},S=function(t){var e;return e=function(e){return t(e.data)},window.addEventListener("message",e,!1),tinymce.activeEditor.windowManager.getWindows()[0].on("close",function(){return window.removeEventListener("message",e)})},e.alert=function(t){var e,n,o,i;return e=tinymce.activeEditor.windowManager.open({title:null!=(n=t.title)?n:" ",url:L(t.message),width:null!=(o=t.width)?o:400,height:null!=(i=t.height)?i:300,buttons:[{type:"button",text:"OK",subtype:"primary",onclick:function(n){return e.close(),"function"==typeof t.callback?t.callback(n):void 0}}]}),t.onclick?S(t.onclick):void 0},e.confirm=function(t){var e,n,o,i,r,s;return e=tinymce.activeEditor.windowManager.open({title:null!=(n=t.title)?n:" ",url:L(t.message),width:null!=(o=t.width)?o:400,height:null!=(i=t.height)?i:300,buttons:[{type:"button",text:null!=(r=t.Cancel)?r:"Cancel",subtype:"primary",onclick:function(n){return e.close(),"function"==typeof t.cancelCallback?t.cancelCallback(n):void 0}},{type:"button",text:null!=(s=t.OK)?s:"OK",subtype:"primary",onclick:function(n){return e.close(),"function"==typeof t.okCallback?t.okCallback(n):void 0}}]}),t.onclick?S(t.onclick):void 0},e.prompt=function(t){var e,n,o,i,r,s,l,u,a;return o=t.value?" value='"+t.value+"'":"",t.message+="<p><input type='text' "+o+" id='promptInput' size=40/></p>",n=null!=(i=t.value)?i:"",e=tinymce.activeEditor.windowManager.open({title:null!=(r=t.title)?r:" ",url:L(t.message),width:null!=(s=t.width)?s:300,height:null!=(l=t.height)?l:200,buttons:[{type:"button",text:null!=(u=t.Cancel)?u:"Cancel",subtype:"primary",onclick:function(o){return e.close(),"function"==typeof t.cancelCallback?t.cancelCallback(n):void 0}},{type:"button",text:null!=(a=t.OK)?a:"OK",subtype:"primary",onclick:function(o){return e.close(),"function"==typeof t.okCallback?t.okCallback(n):void 0}}]}),S(function(t){return"promptInput"===t.id?n=t.value:void 0})},e.promptForFile=function(t){var e,n,o,i,r,s,l,u,a;return i=t.value?" value='"+t.value+"'":"",o=t.types?" accept='"+t.types+"'":"",t.message+="<p><input type='file' "+i+" id='promptInput'/></p>",n=null,e=tinymce.activeEditor.windowManager.open({title:null!=(r=t.title)?r:" ",url:L(t.message),width:null!=(s=t.width)?s:400,height:null!=(l=t.height)?l:100,buttons:[{type:"button",text:null!=(u=t.Cancel)?u:"Cancel",subtype:"primary",onclick:function(n){return e.close(),"function"==typeof t.cancelCallback?t.cancelCallback():void 0}},{type:"button",text:null!=(a=t.OK)?a:"OK",subtype:"primary",onclick:function(o){return e.close(),"function"==typeof t.okCallback?t.okCallback(n):void 0}}]}),S(function(t){return"promptInput"===t.id?n=t.value:void 0})},e.codeEditor=function(t){var e,n,o,i,r,s,l,u,a,c,d,p;return i=function(t){var e;return window.codeEditor=CodeMirror.fromTextArea(document.getElementById("editor"),{lineNumbers:!0,fullScreen:!0,autofocus:!0,theme:"base16-light",mode:t}),e=function(t){return"getEditorContents"===t.data?parent.postMessage(window.codeEditor.getValue(),"*"):void 0},window.addEventListener("message",e,!1)},o="<html><head> <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.17.0/codemirror.min.css'> <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.17.0/theme/base16-light.min.css'> <script src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.17.0/codemirror.min.js'></script> <script src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.17.0/addon/display/fullscreen.min.js'></script> <script src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.17.0/mode/javascript/javascript.min.js'></script> </head> <body style='margin: 0px;'> <textarea id='editor'>"+(null!=(s=t.value)?s:"")+"</textarea> <script> ("+i+')("'+(null!=(l=t.language)?l:"javascript")+'") </script> </body></html>',r=null,e=tinymce.activeEditor.windowManager.open({title:null!=(u=t.title)?u:"Code editor",url:window.objectURLForBlob(window.makeBlob(o,"text/html;charset=utf-8")),width:null!=(a=t.width)?a:700,height:null!=(c=t.height)?c:500,buttons:[{type:"button",text:null!=(d=t.Cancel)?d:"Discard",subtype:"primary",onclick:function(n){return r=t.cancelCallback,e.getContentWindow().postMessage("getEditorContents","*")}},{type:"button",text:null!=(p=t.OK)?p:"Save",subtype:"primary",onclick:function(n){return r=t.okCallback,e.getContentWindow().postMessage("getEditorContents","*")}}]}),n=function(t){return e.close(),"function"==typeof r?r(t.data):void 0},window.addEventListener("message",n,!1),e.on("close",function(){return window.removeEventListener("message",n)})},e.waiting=function(t){var e,n,o,i;return e=tinymce.activeEditor.windowManager.open({title:null!=(n=t.title)?n:" ",url:L(t.message),width:null!=(o=t.width)?o:300,height:null!=(i=t.height)?i:100,buttons:[]}),t.onclick&&S(t.onclick),t.work(function(){return e.close()})},tinymce.PluginManager.add("dialogs",function(t,n){return t.Dialogs=e}),n=function(){function t(t){var e;this.editor=t,e=function(t){return function(e,n){var o,i;return o={icon:n.icon,shortcut:n.shortcut,onclick:n.onclick,tooltip:n.tooltip},i=null!=n.icon?"icon":"text",o[i]=n[i],t.editor.addButton(e,o),t.editor.addMenuItem(e,n)}}(this),e("download",{text:"Download",icon:"arrowdown2",context:"file",tooltip:"Download this document",onclick:function(t){return function(){return t.downloadDocument()}}(this)}),e("upload",{text:"Upload",icon:"arrowup2",context:"file",tooltip:"Upload new document",onclick:function(t){return function(){return t.uploadDocument()}}(this)})}return t.prototype.downloadDocument=function(){var t,e,n;return e=d(this.editor.getContent(),this.editor.Settings.document.metadata),t=new Blob([e],{type:"text/html"}),n=document.createElement("a"),n.setAttribute("href",URL.createObjectURL(t)),n.setAttribute("download",c.LoadSave.filename||"untitled.html"),n.click(),URL.revokeObjectURL(n.getAttribute("href"))},t.prototype.uploadDocument=function(){return c.LoadSave.documentDirty?this.editor.windowManager.open({title:"Save first?",buttons:[{text:"Save",onclick:function(t){return function(){return c.LoadSave.tryToSave(function(e){return e?t.letUserUpload():void 0}),t.editor.windowManager.close()}}(this)},{text:"Discard",onclick:function(t){return function(){return t.editor.windowManager.close(),t.letUserUpload()}}(this)},{text:"Cancel",onclick:function(t){return function(){return t.editor.windowManager.close()}}(this)}]}):this.letUserUpload()},t.prototype.letUserUpload=function(){return this.editor.Dialogs.promptForFile({title:"Choose file",message:"Choose an HTML file to upload into the editor.",okCallback:function(t){return function(e){var n,o,i,r;return o=atob(e.split(",")[1]),r=h(o),i=r.metadata,n=r.document,t.editor.setContent(n),null!=i&&(t.editor.Settings.document.metadata=i),t.editor.focus()}}(this)})},t}(),tinymce.PluginManager.add("downloadupload",function(t,e){return t.DownloadUpload=new n(t)}),o=function(){function t(t){this.editor=t,this.editor.on("init",function(t){return function(){}}(this))}return t.prototype.openHandler=function(){return window.Dropbox.choose({success:function(t){return function(e){return $.ajax({url:e[0].link,success:function(n){var o,i,r,s,l,u,a,c,d,p,f;if(c='<div id="EmbeddedLurchDocument">',p=n.indexOf(c),p>-1){for(p+=c.length,d=n.substring(p),r="",u=function(t){return r+=d.substring(0,t),d=d.substring(t)},a=/<\s*([\/]?)\s*div(>|\s+)/i,o=1;s=a.exec(d);){if(u(s.index),"/"===s[1]?o--:o++,0===o){d="";break}u(s[0].length)}u(d.length),n=r}return f=h(n),l=f.metadata,i=f.document,tinymce.activeEditor.setContent(i),null!=l&&t.loadMetaData(l),t.setFilename(e[0].name)},error:function(t,e,n){return c.Dialogs.alert({title:"File load error",message:"<h1>Error loading file</h1> <p>The file failed to load from the URL Dropbox provided, with an error of type "+e+".</p>"})}})}}(this),linkType:"direct",multiselect:!1})},t.prototype.saveHandler=function(){var t,e;return t=d(c.getContent(),this.saveMetaData()),t='<div id="EmbeddedLurchDocument">'+t+("</div> <script> window.location.href = '"+window.location.href.split("?")[0]+"' + '?document=' + encodeURIComponent( EmbeddedLurchDocument.innerHTML ); </script>"),e="data:text/html,"+encodeURIComponent(t),console.log(document,t,e),null==c.LoadSave.filename&&(this.setFilename(prompt("Choose a filename","My Lurch Document.html")),null==this.filename)?void c.Dialogs.alert({title:"Saving requires a filename",message:"You must specify a filename before you can save the file into your Dropbox."}):window.Dropbox.save(e,this.filename,{success:function(t){return function(){return c.Dialogs.alert({title:"File saved successfully.",message:"<h1>Saved successfully.</h1> <p>File saved to Dropbox:<br> "+t.filename+"</p>"}),t.setDocumentDirty(!1)}}(this),error:function(t){return function(e){return c.Dialogs.alert({title:"Error saving file",message:"<h1>File not saved!</h1> <p>File NOT saved to Dropbox:<br> "+t.filename+"</p> <p>Reason: "+e+"</p>"})}}(this)})},t.prototype.manageFilesHandler=function(){return window.location.href="https://www.dropbox.com"},t}(),tinymce.PluginManager.add("dropbox",function(t,e){return t.Dropbox=new o(t)}),C=function(t,e,n,o,i){return null==o&&(o=!0),o=o?" hide":"",null==i&&(i="images/red-bracket-"+e+".png"),"<img src='"+i+"' class='grouper "+t+o+"' id='"+e+n+"'>"},window.grouperHTML=C,k=function(t){var e,n,o;return(e=/^(open|close)([0-9]+)$/.exec(null!=t&&"function"==typeof t.getAttribute?t.getAttribute("id"):void 0))?(o={openOrClose:e[1],id:parseInt(e[2])},n=/^grouper ([^ ]+)/.exec(null!=t&&"function"==typeof t.getAttribute?t.getAttribute("class"):void 0),n&&(o.type=n[1]),o):null},window.grouperInfo=k,a=function(t){var e,n,o,i,r,s,l;null==t&&(t=window.defaultEditorStyles),i=[];for(e in t)if(U.call(t,e)){for(r=t[e],o="",s=0,l=e.length;l>s;s++)n=e[s],n.toUpperCase()===n&&(o+="-"),o+=n.toLowerCase();i.push(""+o+":"+r+";")}return i.join(" ")},x=function(t){return objectURLForBlob(svgBlobForHTML(t,a()))},u=function(t){var e;return e=t.ownerDocument.defaultView.getComputedStyle(t),"font-size:"+e.fontSize+"; font-family:"+e.fontFamily+";"},i=function(){function t(t,e,n){var o,i,r,s;if(this.open=t,this.close=e,this.plugin=n,this.getScreenBoundaries=B(this.getScreenBoundaries,this),this.connectionsIn=B(this.connectionsIn,this),this.connectionsOut=B(this.connectionsOut,this),this.disconnect=B(this.disconnect,this),this.connect=B(this.connect,this),this.toJSON=B(this.toJSON,this),this.contentsChanged=B(this.contentsChanged,this),this.nextSibling=B(this.nextSibling,this),this.previousSibling=B(this.previousSibling,this),this.indexInParent=B(this.indexInParent,this),this.groupAsHTML=B(this.groupAsHTML,this),this.stillInEditor=B(this.stillInEditor,this),this.remove=B(this.remove,this),this.rangeAfter=B(this.rangeAfter,this),this.rangeBefore=B(this.rangeBefore,this),this.outerRange=B(this.outerRange,this),this.innerRange=B(this.innerRange,this),this.setContentAsText=B(this.setContentAsText,this),this.contentNodes=B(this.contentNodes,this),this.contentAsHTML=B(this.contentAsHTML,this),this.contentAsFragment=B(this.contentAsFragment,this),this.contentAsText=B(this.contentAsText,this),this.updateGrouper=B(this.updateGrouper,this),this.clear=B(this.clear,this),this.keys=B(this.keys,this),this.get=B(this.get,this),this.set=B(this.set,this),this.type=B(this.type,this),this.typeName=B(this.typeName,this),this.id=B(this.id,this),null==this.plugin)for(s=tinymce.editors,i=0,r=s.length;r>i;i++)if(o=s[i],o.getDoc()===this.open.ownerDocument){this.plugin=o.Groups;break}this.contentsChanged(!0,!0)}return t.prototype.id=function(){var t,e;return null!=(t=null!=(e=k(this.open))?e.id:void 0)?t:null},t.prototype.typeName=function(){var t;return null!=(t=k(this.open))?t.type:void 0},t.prototype.type=function(){var t,e;return null!=(t=this.plugin)&&null!=(e=t.groupTypes)?e[this.typeName()]:void 0},t.prototype.set=function(t,e){var n,o,i,r,s,l,u;if(/^[a-zA-Z0-9-_]+$/.test(t)&&(i=JSON.stringify([e]),this.open.getAttribute("data-"+t)!==i&&(this.open.setAttribute("data-"+t,i),null!=this.plugin&&(this.plugin.editor.fire("change"),this.plugin.editor.isNotDirty=!1,this.contentsChanged()),("openDecoration"===t||"closeDecoration"===t)&&this.updateGrouper(t.slice(0,-10)),"openHoverText"===t||"closeHoverText"===t))){for(o=this[t.slice(0,-9)],l=["title","alt"],u=[],r=0,s=l.length;s>r;r++)n=l[r],u.push(o.setAttribute(n,""+e));return u}},t.prototype.get=function(t){var e;try{return JSON.parse(this.open.getAttribute("data-"+t))[0]}catch(n){return void(e=n)}},t.prototype.keys=function(){return Object.keys(this.open.dataset)},t.prototype.clear=function(t){var e,n,o,i,r,s;if(/^[a-zA-Z0-9-_]+$/.test(t)&&null!=this.open.getAttribute("data-"+t)&&(this.open.removeAttribute("data-"+t),null!=this.plugin&&(this.plugin.editor.fire("change"),this.plugin.editor.isNotDirty=!1,this.contentsChanged()),("openDecoration"===t||"closeDecoration"===t)&&this.updateGrouper(t.slice(0,-10)),"openHoverText"===t||"closeHoverText"===t)){for(n=this[t.slice(0,-9)],r=["title","alt"],s=[],o=0,i=r.length;i>o;o++)e=r[o],s.push(n.removeAttribute(e));return s}},t.prototype.updateGrouper=function(t){var e,n,o,i,r;return t===this.open&&(t="open"),t===this.close&&(t="close"),"open"===t||"close"===t?(i=$(n=this[t]),null!=(e=this.get(""+t+"Decoration"))?i.addClass("decorate"):(i.removeClass("decorate"),e=""),o=i.hasClass("hide")?"":null!=(r=this.type())?r[""+t+"ImageHTML"]:void 0,"open"===t?o=e+o:o+=e,window.base64URLForBlob(window.svgBlobForHTML(o,u(n)),function(t){return function(e){var o,i;return n.getAttribute("src")!==e?(n.setAttribute("src",e),null!=(o=t.plugin)&&null!=(i=o.editor.Overlay)?i.redrawContents():void 0):void 0}}(this))):void 0},t.prototype.contentAsText=function(){var t;return null!=(t=this.innerRange())?t.toString():void 0},t.prototype.contentAsFragment=function(){var t;return null!=(t=this.innerRange())?t.cloneContents():void 0},t.prototype.contentAsHTML=function(){var t,e;return(t=this.contentAsFragment())?(e=this.open.ownerDocument.createElement("div"),e.appendChild(t),e.innerHTML):null},t.prototype.contentNodes=function(){var t,e;for(t=[],e=this.open;null!=e;)if(strictNodeOrder(e,this.close))strictNodeOrder(this.open,e)&&t.push(e),e=null!=e.nextSibling?e.nextSibling:e.parentNode;else{if(strictNodeOrder(this.close,e)){console.log("Warning!! walked past @close...something is wrong with this loop");break}if(e===this.close)break;e=e.childNodes[0]}return t},t.prototype.setContentAsText=function(t){var e,n,o;if(e=this.innerRange())return null!=(n=this.plugin)&&n.editor.selection.setRng(e),null!=(o=this.plugin)?o.editor.selection.setContent(t):void 0},t.prototype.innerRange=function(){var t,e;e=this.open.ownerDocument.createRange();try{return e.setStartAfter(this.open),e.setEndBefore(this.close),e}catch(n){return t=n,null}},t.prototype.outerRange=function(){var t,e;e=this.open.ownerDocument.createRange();try{return e.setStartBefore(this.open),e.setEndAfter(this.close),e}catch(n){return t=n,null}},t.prototype.rangeBefore=function(){var t,e,n,o;o=(t=this.open.ownerDocument).createRange();try{return o.setEndBefore(this.open),(n=this.previousSibling())?o.setStartAfter(n.close):this.parent?o.setStartAfter(this.parent.open):o.setStartBefore(t.body.childNodes[0]),o}catch(i){return e=i,null}},t.prototype.rangeAfter=function(){var t,e,n,o;o=(t=this.open.ownerDocument).createRange();try{return o.setStartAfter(this.close),(n=this.nextSibling())?o.setEndBefore(n.open):this.parent?o.setEndBefore(this.parent.close):o.setEndAfter(t.body.childNodes[t.body.childNodes.length-1]),o}catch(i){return e=i,null}},t.prototype.remove=function(){var t,e,n,o,i,r,s;if(this.plugin){for(r=this.connectionsIn(),e=0,o=r.length;o>e;e++)t=r[e],this.disconnect(this.plugin[t[0]]);for(s=this.connectionsOut(),n=0,i=s.length;i>n;n++)t=s[n],this.disconnect(this.plugin[t[1]]);return this.plugin.editor.undoManager.transact(function(t){return function(){return $([t.open].concat(F.call(t.contentNodes()),[t.close])).remove()}}(this))}},t.prototype.stillInEditor=function(){var t;for(t=this.open;null!=this.plugin&&null!=t;){if(t===this.plugin.editor.getDoc())return!0;t=t.parentNode}return!1},t.prototype.groupAsHTML=function(t){var e,n,o;return null==t&&(t=!0),(e=null!=(o=this.outerRange())?o.cloneContents():void 0)?(n=this.open.ownerDocument.createElement("div"),n.appendChild(e),t||$(n).find(".grouper").removeAttr("src"),n.innerHTML):null},t.prototype.indexInParent=function(){var t,e,n,o;return null!=(t=null!=(e=null!=(n=this.parent)?n.children:void 0)?e:null!=(o=this.plugin)?o.topLevel:void 0)?t.indexOf(this):void 0},t.prototype.previousSibling=function(){var t,e,n,o;return null!=(t=null!=(e=null!=(n=this.parent)?n.children:void 0)?e:null!=(o=this.plugin)?o.topLevel:void 0)?t[this.indexInParent()-1]:void 0},t.prototype.nextSibling=function(){var t,e,n,o;return null!=(t=null!=(e=null!=(n=this.parent)?n.children:void 0)?e:null!=(o=this.plugin)?o.topLevel:void 0)?t[this.indexInParent()+1]:void 0},t.prototype.contentsChanged=function(t,e){var n,o;return null==t&&(t=!0),null==e&&(e=!1),null!=(n=this.type())&&"function"==typeof n.contentsChanged&&n.contentsChanged(this,e),t&&null!=(o=this.parent)?o.contentsChanged(!0):void 0},t.prototype.toJSON=function(){var t,e,n,o,i,r,s,l;for(n={},r=this.open.attributes,o=0,i=r.length;i>o;o++)if(t=r[o],"data-"===t.nodeName.slice(0,6)&&"data-mce-"!==t.nodeName.slice(0,10))try{n[t.nodeName]=JSON.parse(t.nodeValue)[0]}catch(u){}return{id:this.id(),typeName:this.typeName(),deleted:this.deleted,text:this.contentAsText(),html:this.contentAsHTML(),parent:null!=(s=null!=(l=this.parent)?l.id():void 0)?s:null,children:function(){var t,n,o,i,r,s;for(i=null!=(o=this.children)?o:[],s=[],t=0,n=i.length;n>t;t++)e=i[t],s.push(null!=(r=null!=e?e.id():void 0)?r:null);return s}.call(this),data:n}},t.prototype.connect=function(t,e){var n,o,i,r,s,l,u,a,c,d,p;for(null==e&&(e=""),n=[this.id(),t.id(),""+e],o=""+n,s=null!=(d=this.get("connections"))?d:[],i=!0,l=0,a=s.length;a>l;l++)if(r=s[l],""+r===o){i=!1;break}for(i&&this.set("connections",F.call(s).concat([n])),s=null!=(p=t.get("connections"))?p:[],i=!0,u=0,c=s.length;c>u;u++)if(r=s[u],""+r===o){i=!1;break}return i?t.set("connections",F.call(s).concat([n])):void 0},t.prototype.disconnect=function(t,e){var n,o;return null==e&&(e=""),o=function(n){return function(o){return o[0]===n.id()&&o[1]===t.id()&&(e===o[2]||("function"==typeof e.test?e.test(o[2]):void 0))}}(this),this.set("connections",function(){var t,e,i,r,s;for(r=null!=(i=this.get("connections"))?i:[],s=[],t=0,e=r.length;e>t;t++)n=r[t],o(n)||s.push(n);return s}.call(this)),t.set("connections",function(){var e,i,r,s,l;for(s=null!=(r=t.get("connections"))?r:[],l=[],e=0,i=s.length;i>e;e++)n=s[e],o(n)||l.push(n);return l}())},t.prototype.connectionsOut=function(){var t,e,n,o,i,r,s;for(e=this.id(),r=null!=(i=this.get("connections"))?i:[],s=[],n=0,o=r.length;o>n;n++)t=r[n],t[0]===e&&s.push(t);return s},t.prototype.connectionsIn=function(){var t,e,n,o,i,r,s;for(e=this.id(),r=null!=(i=this.get("connections"))?i:[],s=[],n=0,o=r.length;o>n;n++)t=r[n],t[1]===e&&s.push(t);return s},t.prototype.getScreenBoundaries=function(){var t,e,n,o,i,r,s,l,u,a;if(s=function(t){var e,n,o,i;if(null!=t){for(i=[],e=n=0,o=t.length;o>=0?o>n:n>o;e=o>=0?++n:--n)i.push(t[e]);return i}return[]},r=s(this.open.getClientRects()).concat(s(null!=(a=this.outerRange())?a.getClientRects():void 0)).concat(s(this.close.getClientRects())),0===r.length)return null;for(o=r[0],o={top:o.top,left:o.left,right:o.right,bottom:o.bottom},t=r[r.length-1],t={top:t.top,left:t.left,right:t.right,bottom:t.bottom},n=!0,e=l=0,u=r.length;u>l;e=++l)i=r[e],o.top=Math.min(o.top,i.top),t.bottom=Math.max(t.bottom,i.bottom),i.left<o.left&&(n=!1),i.top>o.bottom&&(n=!1);return n&&(t.top=o.top,o.bottom=t.bottom),o.top!==o.bottom&&t.top!==t.bottom&&o.left!==o.right&&t.left!==t.right||$(this.open).hasClass("hide")?{open:o,close:t}:null},t}(),window.Group=i,r=function(){function t(t){this.editor=t,this.drawGroups=B(this.drawGroups,this),this.grouperIndexOfRangeEndpoint=B(this.grouperIndexOfRangeEndpoint,this),this.groupsTouchingRange=B(this.groupsTouchingRange,this),this.rangeChanged=B(this.rangeChanged,this),this.groupAboveSelection=B(this.groupAboveSelection,this),this.groupAboveCursor=B(this.groupAboveCursor,this),this.groupAboveNode=B(this.groupAboveNode,this),this.grouperToGroup=B(this.grouperToGroup,this),this.ids=B(this.ids,this),this.registerGroup=B(this.registerGroup,this),this.scanDocument=B(this.scanDocument,this),this.enableScanning=B(this.enableScanning,this),this.disableScanning=B(this.disableScanning,this),this.hideOrShowGroupers=B(this.hideOrShowGroupers,this),this.allGroupers=B(this.allGroupers,this),this.groupCurrentSelection=B(this.groupCurrentSelection,this),this.updateConnectionsMode=B(this.updateConnectionsMode,this),this.updateButtonsAndMenuItems=B(this.updateButtonsAndMenuItems,this),this.addGroupType=B(this.addGroupType,this),this.setUsedID=B(this.setUsedID,this),this.isIdFree=B(this.isIdFree,this),this.addFreeId=B(this.addFreeId,this),this.nextFreeId=B(this.nextFreeId,this),this.groupTypes={},this.topLevel=[],this.freeIds=[0],this.editor.Overlay.addDrawHandler(this.drawGroups)}var e;return t.prototype.nextFreeId=function(){return this.freeIds.length>1?this.freeIds.shift():this.freeIds[0]++},t.prototype.addFreeId=function(t){return t<this.freeIds[this.freeIds.length-1]?(this.freeIds.push(t),this.freeIds.sort(function(t,e){return t-e})):void 0},t.prototype.isIdFree=function(t){return G.call(this.freeIds,t)>=0||t>this.freeIds[this.freeIds.length]},t.prototype.setUsedID=function(t){var e,n;for(n=this.freeIds[this.freeIds.length-1];t>n;)this.freeIds.push(++n);return e=this.freeIds.indexOf(t),this.freeIds.splice(e,1),e===this.freeIds.length?this.freeIds.push(t+1):void 0},t.prototype.addGroupType=function(t,e){var n,o,i,r,s,l,u;return null==e&&(e={}),t=function(){var e,n,o;for(o=[],e=0,n=t.length;n>e;e++)s=t[e],/[a-zA-Z_-]/.test(s)&&o.push(s);return o}().join(""),this.groupTypes[t]=e,e.hasOwnProperty("text")&&(l=this,null!=e.imageHTML&&(e.image=x(e.imageHTML)),null!=e.openImageHTML&&(n=svgBlobForHTML(e.openImageHTML,a()),e.openImage=objectURLForBlob(n),base64URLForBlob(n,function(t){return e.openImage=t})),null!=e.closeImageHTML&&(n=svgBlobForHTML(e.closeImageHTML,a()),e.closeImage=objectURLForBlob(n),base64URLForBlob(n,function(t){return e.closeImage=t})),r={text:e.text,context:null!=(u=e.context)?u:"Insert",onclick:function(e){return function(){return e.groupCurrentSelection(t)}}(this),onPostRender:function(){return l.groupTypes[t].menuItem=this,l.updateButtonsAndMenuItems()}},null!=e.shortcut&&(r.shortcut=e.shortcut),null!=e.icon&&(r.icon=e.icon),this.editor.addMenuItem(t,r),o={tooltip:e.tooltip,onclick:function(e){return function(){return e.groupCurrentSelection(t)}}(this),onPostRender:function(){return l.groupTypes[t].button=this,l.updateButtonsAndMenuItems()}},i=null!=e.image?"image":null!=e.icon?"icon":"text",o[i]=e[i],this.editor.addButton(t,o)),null!=e.connections?e.connections:e.connections=function(t){var e,n;return n=t.connectionsOut(),F.call(n).concat(F.call(function(){var t,o,i;for(i=[],t=0,o=n.length;o>t;t++)e=n[t],i.push(e[1]);return i}()))}},t.prototype.updateButtonsAndMenuItems=function(){var t,e,n,o,i,r,s,l,u,a,c;if(t=null!=(i=this.editor)&&null!=(r=i.selection)&&null!=(s=r.getRng())?s.cloneRange():void 0){n=t.cloneRange(),t.collapse(!0),n.collapse(!1),t=this.groupAboveCursor(t),n=this.groupAboveCursor(n),l=this.groupTypes;for(e in l)U.call(l,e)&&(o=l[e],null!=o&&null!=(u=o.button)&&u.disabled(t!==n),null!=o&&null!=(a=o.menuItem)&&a.disabled(t!==n));return null!=(c=this.connectionsButton)&&c.disabled(null==t||t!==n),this.updateConnectionsMode()}},t.prototype.updateConnectionsMode=function(){var t,e;return(null!=(t=this.connectionsButton)?t.disabled():void 0)&&null!=(e=this.connectionsButton)?e.active(!1):void 0},t.prototype.groupCurrentSelection=function(t){var e,n,o,i,r,s,l,u,a,c,d,p,h,f,g,m,y,v;if(this.groupTypes.hasOwnProperty(t))return i=$(null!=(f=this.allGroupers())?f[0]:void 0).hasClass("hide"),r=this.nextFreeId(),a=C(t,"open",r,i,this.groupTypes[t].openImage),e=C(t,"close",r,i,this.groupTypes[t].closeImage),h=this.editor.selection,h.getStart()===h.getEnd()?(n=this.editor.selection.getContent(),this.editor.insertContent(a+n+"{$caret}"+e),o=this.editor.selection.getRng(),e=null!=(g=o.endContainer.childNodes[o.endOffset])?g:o.endContainer.nextSibling,"P"===e.tagName&&(e=e.childNodes[0]),u=this.grouperToGroup(e),null!=(m=u.parent)&&m.contentsChanged()):(c=h.getRng(),s=c.startContainer,l=c.startOffset,d=c.endContainer,p=c.endOffset,c.collapse(!1),h.setRng(c),this.disableScanning(),this.editor.insertContent("{$caret}"+e),c=h.getRng(),e=null!=(y=c.endContainer.childNodes[c.endOffset])?y:c.endContainer.nextSibling,c.setStart(s,l),c.setEnd(s,l),h.setRng(c),this.editor.insertContent(a),this.enableScanning(),this.editor.selection.select(e),this.editor.selection.collapse(!0),u=this.grouperToGroup(e),null!=(v=u.parent)&&v.contentsChanged()),u},t.prototype.allGroupers=function(){return this.editor.getDoc().getElementsByClassName("grouper")},t.prototype.hideOrShowGroupers=function(){var t,e;return t=$(this.allGroupers()),$(null!=t?t[0]:void 0).hasClass("hide")?t.removeClass("hide"):t.addClass("hide"),t.filter(".decorate").each(function(t){return function(e,n){return t.grouperToGroup(n).updateGrouper(n)}}(this)),null!=(e=this.editor.Overlay)&&e.redrawContents(),this.editor.focus()},t.prototype.disableScanning=function(){return this.scanLocks=(null!=this.scanLocks?this.scanLocks:this.scanLocks=0)+1},t.prototype.enableScanning=function(){var t;return this.scanLocks=Math.max((null!=(t=this.scanLocks)?t:0)-1,0),0===this.scanLocks?this.scanDocument():void 0},e=!1,t.prototype.scanDocument=function(){var t,n,o,i,r,s,l,u,a,c,d,p,h,f,g,m,y,v,w,b,C,x,I,S,M,T,A,N,D,O,L,E,R,B,F,H,P,j,W,_,K,J;if(!(this.scanLocks>0)){if(e)return setTimeout(function(t){return function(){return t.scanDocument}}(this),0);for(e=!0,H=this.ids(),x=0,T=H.length;T>x;x++)f=H[x],null!=this[f]&&(this[f].old=!0);for(h=Array.prototype.slice.apply(this.allGroupers()),a=[],C=[],this.topLevel=[],this.idConversionMap={},i=this.freeIds.slice(0),g=function(t){var e,n,o,i;for(n=o=0,i=a.length;i>o;n=++o)if(e=a[n],e.id===t)return n;return-1},I=0,A=h.length;A>I;I++)if(p=h[I],null==(m=k(p)))$(p).remove();else if("open"===m.openOrClose)a.unshift({id:m.id,grouper:p,children:[]});else if(-1===g(m.id))$(p).remove();else{for(;a[0].id!==m.id;)$(a.shift().grouper).remove();for(d=a.shift(),f=this.registerGroup(d.grouper,p),C.push(f),y=this[f],y.children=d.children,P=y.children,S=0,N=P.length;N>S;S++)r=P[S],r.parent=y;a.length>0?a[0].children.push(y):(this.topLevel.push(y),y.parent=null);
}for(;a.length>0;)$(a.shift().grouper).remove();for(C.sort(function(t,e){return t-e}),l=0,this.freeIds=[];C.length>0;){if(l===C[0])for(;l===C[0];)C.shift();else this.freeIds.push(l);l++}for(this.freeIds.push(l),n=this.freeIds.slice(0);i[i.length-1]<n[n.length-1];)i.push(i[i.length-1]+1);for(;n[n.length-1]<i[i.length-1];)n.push(n[n.length-1]+1);for(o=function(){var e,o,r;for(r=[],e=0,o=n.length;o>e;e++)t=n[e],G.call(i,t)<0&&r.push(t);return r}(),u=[],M=0,D=o.length;D>M;M++)f=o[M],u.push(this[f]),null!=(j=this[f])&&(j.deleted=!0),delete this[f];for(R=0,O=u.length;O>R;R++)c=u[R],null!=c&&null!=(W=c.type())&&"function"==typeof W.deleted&&W.deleted(c);b=function(t){return function(e,n){var o,i,r,s;if(null==n&&(n="both"),i=e.get("connections")){for(f=e.id(),s=0,r=i.length;r>s;s++)o=i[s],("both"===n||o[0]===f&&"out"===n)&&t.idConversionMap.hasOwnProperty(o[1])&&(o[1]=t.idConversionMap[o[1]]),("both"===n||o[1]===f&&"in"===n)&&t.idConversionMap.hasOwnProperty(o[0])&&(o[0]=t.idConversionMap[o[0]]);return e.set("connections",i)}}}(this),_=this.idConversionMap;for(w in _)if(U.call(_,w)){for(v=_[w],b(this[v]),K=y.connectionsOut(),B=0,L=K.length;L>B;B++)s=K[B],b(this[s[1]],"in");for(J=y.connectionsIn(),F=0,E=J.length;E>F;F++)s=J[F],b(this[s[0]],"out")}return delete this.idsCache,setTimeout(function(t){return function(){var e;return null!=(e=t.editor.Overlay)&&e.redrawContents(),t.updateButtonsAndMenuItems()}}(this),0),e=!1}},t.prototype.registerGroup=function(t,e){var n,o,r,s;if(n=this[r=k(t).id],(null!=n?n.open:void 0)!==t||(null!=n?n.close:void 0)!==e){if(null!=this[r]&&!this[r].old){for(s=0,o=this.editor.getDoc();o.getElementById("open"+s||o.getElementById("close"+s));)s++;t.setAttribute("id","open"+s),e.setAttribute("id","close"+s),this.idConversionMap[r]=s,r=s}this[r]=new i(t,e,this)}else delete this[r].old;return(void 0===t.naturalWidth||0===t.naturalWidth)&&this[r].updateGrouper("open"),(void 0===e.naturalWidth||0===e.naturalWidth)&&this[r].updateGrouper("close"),r},t.prototype.ids=function(){var t,e,n,o,i;if(null==this.idsCache)for(this.idsCache=[],e=function(t){return function(n){var o,i,r,s,l;for(t.idsCache.push(n.id()),s=n.children,l=[],i=0,r=s.length;r>i;i++)o=s[i],l.push(e(o));return l}}(this),i=this.topLevel,n=0,o=i.length;o>n;n++)t=i[n],e(t);return this.idsCache},t.prototype.grouperToGroup=function(t){var e,n;return null!=(e=null!=(n=k(t))?n.id:void 0)?this[e]:null},t.prototype.groupAboveNode=function(t){var e,n,o,i,r;if(0===(e=this.allGroupers()).length)return null;if(o={index:0,grouper:e[0],leftOfNode:!0},o.grouper===t)return this.grouperToGroup(o.grouper);if(!strictNodeOrder(o.grouper,t))return null;if(r={index:e.length-1,grouper:e[e.length-1]},r.grouper===t)return this.grouperToGroup(r.grouper);if(strictNodeOrder(r.grouper,t))return null;for(;;){if(o.grouper===t)return this.grouperToGroup(o.grouper);if(r.grouper===t)return this.grouperToGroup(r.grouper);if(o.index+1===r.index)return(n=this.grouperToGroup(o.grouper))?o.grouper===n.open?n:n.parent:null;i=Math.floor((o.index+r.index)/2),strictNodeOrder(e[i],t)?o={index:i,grouper:e[i],leftOfNode:!0}:r={index:i,grouper:e[i],leftOfNode:!1}}},t.prototype.groupAboveCursor=function(t){var e,n,o,i;return 3===(null!=(i=t.startContainer)?i.nodeType:void 0)?this.groupAboveNode(t.startContainer):t.startContainer.childNodes.length>t.startOffset?(e=t.startContainer.childNodes[t.startOffset],o=this.groupAboveNode(e),(null!=o?o.open:void 0)===e?o.parent:o):t.startContainer.childNodes.length>0?(n=t.startContainer.childNodes[t.startOffset-1],o=this.groupAboveNode(n),(null!=o?o.close:void 0)===n?o.parent:o):this.groupAboveNode(t.startContainer)},t.prototype.groupAboveSelection=function(t){var e,n,o,i,r;for(e=t.cloneRange(),e.collapse(!0),e=this.groupAboveCursor(e),n=[];null!=e;)n.unshift(e),e=e.parent;for(i=t.cloneRange(),i.collapse(!1),i=this.groupAboveCursor(i),r=[];null!=i;)r.unshift(i),i=i.parent;for(o=null;n.length>0&&r.length>0&&n[0]===r[0];)o=n.shift(),r.shift();return o},t.prototype.rangeChanged=function(t){var e,n,o,i,r;for(i=this.groupsTouchingRange(t),r=[],n=0,o=i.length;o>n;n++)e=i[n],r.push(e.contentsChanged(!1));return r},t.prototype.groupsTouchingRange=function(t){var e,n,o,i,r,s,l,u,a,c,d;if(0===(e=this.allGroupers()).length)return[];if(n=1+this.grouperIndexOfRangeEndpoint(t,!0,e),r=this.grouperIndexOfRangeEndpoint(t,!1,e),n>r){for(l=t.startContainer,1===l.nodeType&&t.startOffset<l.childNodes.length&&(l=l.childNodes[t.startOffset]),o=this.groupAboveNode(l),u=o?o.open===l?o.parent?[o.parent]:[]:[o]:[];s=null!=(d=u[u.length-1])?d.parent:void 0;)u.push(s);return u}for(a=[],u=[],i=c=n;r>=n?r>=c:c>=r;i=r>=n?++c:--c)o=this.grouperToGroup(e[i]),e[i]===o.open?a.push(o):(u.push(o),a.pop());for(;a.length>0;)u.push(a.pop());for(;s=u[u.length-1].parent;)u.push(s);return u},t.prototype.grouperIndexOfRangeEndpoint=function(t,e,n){var o,i,r,s;if(0===(null!=n?n:n=this.allGroupers()).length)return-1;if(o=e?Range.END_TO_START:Range.END_TO_END,i=function(e){return function(n){var i;return i=e.editor.getDoc().createRange(),i.selectNode(n),t.compareBoundaryPoints(o,i)>-1}}(this),e=0,!i(n[e]))return-1;if(s=n.length-1,i(n[s]))return s;for(;;){if(e+1===s)return e;r=Math.floor((e+s)/2),i(n[r])?e=r:s=r}},t.prototype.drawGroups=function(t,e){var n,o,i,r,s,l,a,c,d,p,h,f,g,m,y,v,w,b,C,k,x,I,S,M,T,A,N,D,O,L,E,R,U,B,G,H,P,j,W,$,_,K,J,q,z,Y,X,V,Z,Q,tt,et,nt,ot,it,rt,st,lt,ut;if(this.bubbleTags=[],!(this.scanLocks>0)){for(f=this.groupAboveSelection(this.editor.selection.getRng()),n=getComputedStyle(this.editor.getBody()),w=parseInt(n["margin-left"]),M=parseInt(n["margin-right"]),x=3,I=2,S=4,N=[],a=function(t){return function(n,o,i,r){var s,l,a,c,d,p,h,f,g,m,y;return p=n.type(),a=null!=(y=null!=p?p.color:void 0)?y:"#444444",(s=n.getScreenBoundaries())?(c=s.open,l=s.close,h=c.left-x/3,g=c.top-x,f=l.right+x/3,m=l.bottom+x,r&&(d=null!=p&&"function"==typeof p.tagContents?p.tagContents(n):void 0)&&N.push({content:d,corner:{x:h,y:g},color:a,style:u(n.open),group:n}),e.fillStyle=e.strokeStyle=a,c.top===l.top&&c.bottom===l.bottom?e.roundedRect(h,g,f,m,S):e.roundedZone(h,g,f,m,c.bottom,l.top,w,M,S),o&&(e.save(),e.globalAlpha=1,e.lineWidth=1.5,null!=p&&"function"==typeof p.setOutlineStyle&&p.setOutlineStyle(n,e),e.stroke(),e.restore()),i&&(e.save(),e.globalAlpha=.3,null!=p&&"function"==typeof p.setFillStyle&&p.setFillStyle(n,e),e.fill(),e.restore()),!0):(setTimeout(function(){var e;return null!=(e=t.editor.Overlay)?e.redrawContents():void 0},100),null)}}(this),y=!0,E=f;E;){if(!a(E,!0,y,!0))return;E=E.parent,x+=I,y=!1}for(tt=null!=(Q="function"==typeof this.visibleGroups?this.visibleGroups():void 0)?Q:[],$=0,q=tt.length;q>$;$++)c=tt[$],a(c,!0,!1,!0);for(D=[];N.length>0;){if(A=N.shift(),e.font=A.font,!(T=e.measureHTML(A.content,A.style)))return void setTimeout(function(t){return function(){var e;return null!=(e=t.editor.Overlay)?e.redrawContents():void 0}}(this),10);for(R=A.corner.x-I,B=A.corner.y-T.height-2*I,U=R+2*I+T.width,G=A.corner.y,_=0,z=D.length;z>_;_++)k=D[_],rectanglesCollide(R,B,U,G,k.x1,k.y1,k.x2,k.y2)&&(b=k.y1-G,B+=b,G+=b);G=A.corner.y,et=[R,B,U,G],A.x1=et[0],A.y1=et[1],A.x2=et[2],A.y2=et[3],D.unshift(A)}for(K=0,Y=D.length;Y>K;K++){if(A=D[K],e.roundedRect(A.x1,A.y1,A.x2,A.y2,S),e.globalAlpha=1,e.save(),e.fillStyle="#ffffff",null!=(nt=A.group)&&"function"==typeof nt.type&&"function"==typeof(H=nt.type()).setFillStyle&&H.setFillStyle(A.group,e),e.fill(),e.restore(),e.save(),e.lineWidth=1.5,e.strokeStyle=A.color,null!=(ot=A.group)&&"function"==typeof ot.type&&"function"==typeof(P=ot.type()).setOutlineStyle&&P.setOutlineStyle(A.group,e),e.stroke(),e.restore(),e.save(),e.globalAlpha=.7,e.fillStyle=A.color,null!=(it=A.group)&&"function"==typeof it.type&&"function"==typeof(j=it.type()).setFillStyle&&j.setFillStyle(A.group,e),e.fill(),e.restore(),e.fillStyle="#000000",e.globalAlpha=1,!e.drawHTML(A.content,A.x1+I,A.y1,A.style))return void setTimeout(function(t){return function(){var e;return null!=(e=t.editor.Overlay)?e.redrawContents():void 0}}(this),10);this.bubbleTags.unshift(A)}if(x=3,!this.groupUnderMouse||a(this.groupUnderMouse,!1,!0,!1)){for(L=function(e){return function(e,n){return{left:{x:e.left,y:e.top},right:{x:e.top===n.top&&e.bottom===n.bottom?n.right:t.width-M,y:e.top}}}}(this),o=function(t){return function(t,e){return{left:{x:t.top===e.top&&t.bottom===e.bottom?t.left:w,y:e.bottom},right:{x:e.right,y:e.bottom}}}}(this),h=20,g=function(t){return function(t,e){return t.close.bottom+h<e.open.top?{from:o(t.open,t.close),to:L(e.open,e.close),startDir:1,endDir:1}:e.close.bottom+h<t.open.top?{from:L(t.open,t.close),to:o(e.open,e.close),startDir:-1,endDir:-1}:{from:L(t.open,t.close),to:L(e.open,e.close),startDir:-1,endDir:1}}}(this),v=function(t){return function(t,e,n,o){var i;return i=(n+1)/(o+1),e=Math.min(e,t+40*o),(1-i)*t+i*e}}(this),l=function(t){return function(n,o,i,r,s,l){var a,c,d,p,f,m,y,w,b,C,k,M,A;if(e.save(),e.strokeStyle=(null!=(k=i.type())?k.color:void 0)||"#444444",e.globalAlpha=1,e.lineWidth=2,"function"==typeof l&&l(e),f=i.getScreenBoundaries(),C=r.getScreenBoundaries(),f&&C){if(f.open.top-=x,f.close.top-=x,f.open.bottom+=x,f.close.bottom+=x,C.open.top-=x,C.close.top-=x,C.open.bottom+=x,C.close.bottom+=x,m=g(f,C),y=v(m.from.left.x,m.from.right.x,n,o),w=m.from.left.y,d=v(m.to.left.x,m.to.right.x,n,o),p=m.to.left.y,e.bezierArrow(y,w,y,w+m.startDir*h,d,p-m.endDir*h,d,p),e.stroke(),""!==s){if(a=e.applyBezier(y,y,d,d,.5),c=e.applyBezier(w,w+m.startDir*h,p-m.endDir*h,p,.5),b=u(i.open),!(T=e.measureHTML(s,b)))return void setTimeout(function(){var e;return null!=(e=t.editor.Overlay)?e.redrawContents():void 0},10);e.roundedRect(a-T.width/2-I,c-T.height/2-I,a+T.width/2+I,c+T.width/2,S),e.globalAlpha=1,e.fillStyle="#ffffff",e.fill(),e.lineWidth=1.5,e.strokeStyle=null!=(M=null!=(A=i.type())?A.color:void 0)?M:"#444444",e.stroke(),e.fillStyle="#000000",e.globalAlpha=1,e.drawHTML(s,a-T.width/2+I,c-T.height/2,b)}return e.restore()}}}(this),st=[f].concat(F.call(null!=(rt="function"==typeof this.visibleGroups?this.visibleGroups():void 0)?rt:[])),ut=[],J=0,X=st.length;X>J;J++)if(p=st[J]){for(s="function"==typeof(W=p.type()).connections?W.connections(p):void 0,C=function(){var t,e,n;for(n=[],e=0,t=s.length;t>e;e++)i=s[e],i instanceof Array&&n.push(i);return n}().length,lt=null!=s?s:[],Z=0,V=lt.length;V>Z;Z++)r=lt[Z],r instanceof Array||("number"==typeof r&&(r=this[r]),a(r,!0,!1,!1));ut.push(function(){var t,e,n,o;for(n=null!=s?s:[],o=[],m=e=0,t=n.length;t>e;m=++e)r=n[m],r instanceof Array?(d="number"==typeof r[0]?this[r[0]]:r[0],O="number"==typeof r[1]?this[r[1]]:r[1],o.push(l.apply(null,[m,C,d,O].concat(F.call(r.slice(2)))))):o.push(void 0);return o}.call(this))}else ut.push(void 0);return ut}}},t}(),tinymce.PluginManager.add("groups",function(t,e){var n,o,i,s;for(t.Groups=new r(t),t.on("init",function(e){return t.dom.loadCSS("groupsplugin.css")}),s=t.settings.groupTypes,o=0,i=s.length;i>o;o++)n=s[o],t.Groups.addGroupType(n.name,n);return t.addMenuItem("hideshowgroups",{text:"Hide/show groups",context:"View",onclick:function(){return t.Groups.hideOrShowGroupers()}}),window.useGroupConnectionsUI&&t.addButton("connect",{image:x("&#x2197;"),tooltip:"Connect groups",onclick:function(){return this.active(!this.active()),t.Groups.updateConnectionsMode()},onPostRender:function(){return t.Groups.connectionsButton=this,t.Groups.updateButtonsAndMenuItems()}}),t.on("change SetContent",function(e){var n,o,i;return t.Groups.scanDocument(),(null!=e&&null!=(i=e.level)?i.bookmark:void 0)?(n=t.selection.getBookmark(),t.selection.moveToBookmark(e.level.bookmark),o=t.selection.getRng(),t.selection.moveToBookmark(n),t.Groups.rangeChanged(o)):void 0}),t.on("KeyUp",function(e){var n,o,i,r;return o=[33,34,35,36,37,38,39,40],n=[16,17,18,91],i=e.keyCode,G.call(o,i)>=0||(r=e.keyCode,G.call(n,r)>=0)?void 0:(t.Groups.scanDocument(),t.Groups.rangeChanged(t.selection.getRng()))}),t.on("NodeChange",function(e){return t.Groups.updateButtonsAndMenuItems()}),t.on("contextMenu",function(e){var n,o,i,r,s,l,u,a,c,d,p,h,f,g,m;for(e.preventDefault(),d=e.clientX,p=e.clientY,(a=t.getDoc().nodeFromPoint(d,p))&&(o=t.Groups.groupAboveNode(a)),n=t.settings.contextmenu||"link image inserttable | cell row column deletetable",r=[],g=n.split(/[ ,]/),h=0,f=g.length;f>h;h++)l=g[h],i=t.menuItems[l],"|"===l&&(i={text:l}),i&&(i.shortcut="",r.push(i));return(u=null!=o&&null!=(m=o.type())?m.contextMenuItems(o):void 0)&&(r.push({text:"|"}),r=r.concat(u)),s=new tinymce.ui.Menu({items:r,context:"contextmenu",classes:"contextmenu"}).renderTo(),t.on("remove",function(){return s.remove(),s=null}),c=$(t.getContentAreaContainer()).position(),s.moveTo(d+c.left,p+c.top)}),t.on("mousedown",function(e){var n,o,i,r,s,l,u,a,c,d,p,h,f,g,m,y,v,w,b,C,x,I,S;if(p=e.clientX,h=e.clientY,null!=(m=t.Groups.connectionsButton)?m.active():0){if(r=t.groupUnderMouse(p,h)){if(l=null!=(y=t.selection)&&null!=(v=y.getRng())?v.cloneRange():void 0,!l)return;return l.collapse(!0),n=t.Groups.groupAboveCursor(l),null!=(w=n.type())&&"function"==typeof w.connectionRequest&&w.connectionRequest(n,r),e.preventDefault(),null!=(b=t.Groups.connectionsButton)&&b.active(!1),t.Groups.updateConnectionsMode(),!1}}else{if(o=t.getDoc(),i=o.elementFromPoint(p,h),i&&(s=k(i)))return r=t.Groups.grouperToGroup(i),null!=(C=r.type())&&"function"==typeof C.clicked&&C.clicked(r,"single",i===r.open?"open":"close"),!1;for(x=t.Groups.bubbleTags,f=0,g=x.length;g>f;f++)if(d=x[f],d.x1<p&&p<d.x2&&d.y1<h&&h<d.y2)return a=null!=(I=d.group)&&null!=(S=I.type())?S.tagMenuItems(d.group):void 0,null==a&&(a=[{text:"no actions available",disabled:!0}]),u=new tinymce.ui.Menu({items:a,context:"contextmenu",classes:"contextmenu"}).renderTo(),t.on("remove",function(){return u.remove(),u=null}),c=$(t.getContentAreaContainer()).position(),u.moveTo(p+c.left,h+c.top),e.preventDefault(),!1}}),t.on("dblclick",function(e){var n,o,i,r,s;return n=t.getDoc(),o=n.elementFromPoint(e.clientX,e.clientY),o&&(r=k(o))?(i=t.Groups.grouperToGroup(o),null!=(s=i.type())&&"function"==typeof s.clicked&&s.clicked(i,"double",o===i.open?"open":"close"),!1):void 0}),t.on("mousemove",function(e){var n;return t.Groups.groupUnderMouse=t.groupUnderMouse(e.clientX,e.clientY),null!=(n=t.Overlay)?n.redrawContents():void 0}),t.groupUnderMouse=function(e,n){var o,i,r,s,l,u,a,c,d,p,h;for(o=t.getDoc(),i=o.elementFromPoint(e,n),r=c=0,h=i.childNodes.length;h>=0?h>c:c>h;r=h>=0?++c:--c)if(s=i.childNodes[r],3===s.nodeType)for(l=o.createRange(),l.selectNode(s),a=l.getClientRects(),a=function(){var t,e,n;for(n=[],r=t=0,e=a.length;e>=0?e>t:t>e;r=e>=0?++t:--t)n.push(a[r]);return n}(),d=0,p=a.length;p>d;d++)if(u=a[d],e>u.left&&e<u.right&&n>u.top&&n<u.bottom)return t.Groups.groupAboveNode(s);return null},t.on("KeyUp",function(e){var n,o,i,r,s,l,u,a,c,d,p,h,f,g,m,y;if(l=[33,34,35,36,37,38,39,40],s=[16,17,18,91],h=e.keyCode,!(G.call(l,h)>=0||(f=e.keyCode,G.call(s,f)>=0))&&(a=t.selection.getRng(),a.startContainer===a.endContainer&&3===(null!=(g=a.startContainer)?g.nodeType:void 0))){if(i=a.startContainer.textContent,r=i[a.startOffset-1]," "!==r&&"\\"!==r&&r!==String.fromCharCode(160))return;o=i.substr(0,a.startOffset-1),n=i.substring(a.startOffset-1),m=t.Groups.groupTypes,y=[];for(p in m)if(d=m[p],c=d.LaTeXshortcut){if(o.slice(-c.length)===c){u=a.startOffset-c.length-1,"\\"!==r&&(n=n.substr(1)),o=o.slice(0,-c.length),a.startContainer.textContent=o+n,a.setStart(a.startContainer,u),"\\"===r?a.setEnd(a.startContainer,u+1):a.setEnd(a.startContainer,u),t.selection.setRng(a),t.Groups.groupCurrentSelection(p);break}y.push(void 0)}else y.push(void 0);return y}})}),M=function(t){var e,n,o;return o=[],e=function(t){var e,n,o,i;return i=t.toLowerCase().replace(/\s+/g,"").split("+"),n=2<=i.length?F.call(i,0,o=i.length-1):(o=0,[]),e=i[o++],{altKey:G.call(n,"alt")>=0,ctrlKey:G.call(n,"ctrl")>=0,metaKey:G.call(n,"meta")>=0,key:e}},n=function(n,i){var r;return null!=(null!=i?i.shortcut:void 0)&&"cut"!==n&&"copy"!==n&&"paste"!==n?o.push({keys:e(i.shortcut),action:null!=(r=i.onclick)?r:function(){return t.execCommand(n)}}):void 0},t.__addMenuItem=t.addMenuItem,t.addMenuItem=function(e,o){return n(e,o),t.__addMenuItem(e,o)},t.__addButton=t.addButton,t.addButton=function(e,o){return n(e,o),t.__addButton(e,o)},t.on("keydown",function(t){var e,n,i,r,s,l,u;for(s=0,l=o.length;l>s;s++){i=o[s],n=!0,u=i.keys;for(e in u)if(U.call(u,e)&&(r=u[e],t[e]!==r)){n=!1;break}if(n)return t.preventDefault(),void i.action()}})},s=function(){function t(e){var n;this.editor=e,this.manageFiles=B(this.manageFiles,this),this.handleOpen=B(this.handleOpen,this),this.tryToOpen=B(this.tryToOpen,this),this.load=B(this.load,this),this.tryToSave=B(this.tryToSave,this),this.save=B(this.save,this),this.tryToClear=B(this.tryToClear,this),this.clear=B(this.clear,this),this.setFileSystem=B(this.setFileSystem,this),this.setAppName=B(this.setAppName,this),this.setFilepath=B(this.setFilepath,this),this.setFilename=B(this.setFilename,this),this.setDocumentDirty=B(this.setDocumentDirty,this),this.recomputePageTitle=B(this.recomputePageTitle,this),this.setAppName(t.prototype.appName),this.setFileSystem(this.appName),this.setFilepath(FileSystem.prototype.pathSeparator),setTimeout(function(t){return function(){return t.clear()}}(this),0),this.saveMetaData=this.loadMetaData=null,this.editor.on("change",function(t){return function(e){return t.setDocumentDirty(!0)}}(this)),n=function(t){return function(e,n){var o,i;return o={icon:n.icon,shortcut:n.shortcut,onclick:n.onclick,tooltip:n.tooltip},i=null!=n.icon?"icon":"text",o[i]=n[i],t.editor.addButton(e,o),t.editor.addMenuItem(e,n)}}(this),n("newfile",{text:"New",icon:"newdocument",context:"file",shortcut:"meta+alt+N",tooltip:"New file",onclick:function(t){return function(){return t.tryToClear()}}(this)}),n("savefile",{text:"Save",icon:"save",context:"file",shortcut:"meta+S",tooltip:"Save file",onclick:function(t){return function(){return t.tryToSave()}}(this)}),this.editor.addMenuItem("saveas",{text:"Save as...",context:"file",shortcut:"meta+shift+S",onclick:function(t){return function(){return t.tryToSave(null,"")}}(this)}),n("openfile",{text:"Open...",icon:"browse",context:"file",shortcut:"meta+O",tooltip:"Open file...",onclick:function(t){return function(){return t.handleOpen()}}(this)}),this.editor.addMenuItem("managefiles",{text:"Manage files...",context:"file",onclick:function(t){return function(){return t.manageFiles()}}(this)}),t.prototype.instances.push(this)}return t.prototype.appName=null,t.setAppName=function(e){var n,o,i,r,s;for(null==e&&(e=null),t.prototype.appName=e,r=t.prototype.instances,s=[],o=0,i=r.length;i>o;o++)n=r[o],s.push(n.setAppName(e));return s},t.prototype.instances=[],t.prototype.recomputePageTitle=function(){return document.title=""+(this.appName?this.appName+": ":"")+" "+(this.filename||"(untitled)")+" "+(this.documentDirty?"*":"")},t.prototype.setDocumentDirty=function(t){return null==t&&(t=!0),this.documentDirty=t,this.recomputePageTitle()},t.prototype.setFilename=function(t){return null==t&&(t=null),this.filename=t,this.recomputePageTitle()},t.prototype.setFilepath=function(t){return null==t&&(t=null),this.filepath=t},t.prototype.setAppName=function(t){var e;return null==t&&(t=null),e=this.appName===this.fileSystem,this.appName=t,e&&(this.fileSystem=this.appName),this.recomputePageTitle()},t.prototype.setFileSystem=function(t){return null==t&&(t=this.appName),this.fileSystem=t},t.prototype.clear=function(){return this.editor.setContent(""),this.editor.undoManager.clear(),this.setDocumentDirty(!1),this.setFilename(null),"function"==typeof this.loadMetaData?this.loadMetaData({}):void 0},t.prototype.tryToClear=function(){return this.documentDirty?this.editor.windowManager.open({title:"Save first?",buttons:[{text:"Save",onclick:function(t){return function(){return t.tryToSave(function(e){return e?t.clear():void 0}),t.editor.windowManager.close()}}(this)},{text:"Discard",onclick:function(t){return function(){return t.clear(),t.editor.windowManager.close()}}(this)},{text:"Cancel",onclick:function(t){return function(){return t.editor.windowManager.close()}}(this)}]}):(this.clear(),void this.editor.focus())},t.prototype.save=function(){var t,e;if(null!==this.filename)return e=new FileSystem(this.fileSystem),e.cd(this.filepath),t=[this.editor.getContent(),"function"==typeof this.saveMetaData?this.saveMetaData():void 0],e.write(this.filename,t,!0)?this.setDocumentDirty(!1):void 0},t.prototype.tryToSave=function(t,e){var n,o,i,r;return null==e&&(e=this.filename),e?(this.setFilename(e),i=this.save(),this.editor.focus(),"function"==typeof t?t(i):void 0):(o=function(){var t,n,o,i,r,s;if(n=document.getElementsByClassName("mce-window")[0]){for(r=n.getElementsByTagName("button"),s=[],o=0,i=r.length;i>o;o++){if(t=r[o],"Save"===t.textContent){e?(t.removeAttribute("disabled"),t.parentNode.style.backgroundImage=null,t.parentNode.style.backgroundColor=null):(t.setAttribute("disabled",!0),t.parentNode.style.backgroundImage="none",t.parentNode.style.backgroundColor="#ccc");break}s.push(void 0)}return s}},e=null,this.saveFileNameChangedHandler=function(t){return e=t,o()},n=null,this.changedFolderHandler=function(t){return n=t},r=function(t){return function(e,n){var o;return o=new FileSystem(t.fileSystem),o.cd(e),null!==o.type(n)}}(this),this.buttonClickedHandler=function(o){return function(){var s,l;return l=arguments[0],s=2<=arguments.length?F.call(arguments,1):[],"Save"===l?r(n,e)&&!confirm("Are you sure you want to overwrite the file "+e+"?")?void o.tellDialog("setFileBrowserMode","save file"):(o.setFilepath(n),o.setFilename(e),o.editor.windowManager.close(),i=o.save(),"function"==typeof t?t(i):void 0):"Cancel"===l?(o.editor.windowManager.close(),"function"==typeof t?t(!1):void 0):void 0}}(this),this.editor.windowManager.open({title:"Save file...",url:"filedialog/filedialog.html",width:600,height:400,buttons:[{text:"Save",subtype:"primary",onclick:function(t){return function(){return t.buttonClickedHandler("Save")}}(this)},{text:"Cancel",onclick:function(t){return function(){return t.buttonClickedHandler("Cancel")}}(this)}]},{fsName:this.fileSystem,mode:"save file"}))},t.prototype.load=function(t,e){var n,o,i,r;if(null!==e)return null===t&&(t="."),i=new FileSystem(this.fileSystem),i.cd(t),r=i.read(e),n=r[0],o=r[1],this.editor.setContent(n),this.editor.undoManager.clear(),this.editor.focus(),this.setFilepath(t),this.setFilename(e),this.setDocumentDirty(!1),"function"==typeof this.loadMetaData?this.loadMetaData(null!=o?o:{}):void 0},t.prototype.tryToOpen=function(t){var e,n,o;return null==t&&(t=function(t){return function(e,n){return t.load(e,n)}}(this)),o=function(t){return function(){var t,n,o,i,r,s;if(n=document.getElementsByClassName("mce-window")[0]){for(r=n.getElementsByTagName("button"),s=[],o=0,i=r.length;i>o;o++){if(t=r[o],"Open"===t.textContent){e?(t.removeAttribute("disabled"),t.parentNode.style.backgroundImage=null,t.parentNode.style.backgroundColor=null):(t.setAttribute("disabled",!0),t.parentNode.style.backgroundImage="none",t.parentNode.style.backgroundColor="#ccc");break}s.push(void 0)}return s}}}(this),e=null,this.selectedFileHandler=function(t){return e=t,o()},n=null,this.changedFolderHandler=function(t){return n=t},this.buttonClickedHandler=function(o){return function(){var i,r;return r=arguments[0],i=2<=arguments.length?F.call(arguments,1):[],"Open"===r?(o.editor.windowManager.close(),"function"==typeof t?t(n,e):void 0):"Cancel"===r?(o.editor.windowManager.close(),"function"==typeof t?t(null,null):void 0):void 0}}(this),this.editor.windowManager.open({title:"Open file...",url:"filedialog/filedialog.html",width:600,height:400,buttons:[{text:"Open",subtype:"primary",onclick:function(t){return function(){return t.buttonClickedHandler("Open")}}(this)},{text:"Cancel",onclick:function(t){return function(){return t.buttonClickedHandler("Cancel")}}(this)}]},{fsName:this.fileSystem,mode:"open file"}),o()},t.prototype.handleOpen=function(t){return null==t&&(t=function(t){return function(){return t.tryToOpen()}}(this)),this.documentDirty?this.editor.windowManager.open({title:"Save first?",buttons:[{text:"Save",onclick:function(e){return function(){return e.editor.windowManager.close(),e.tryToSave(function(e){return e?t():void 0})}}(this)},{text:"Discard",onclick:function(e){return function(){return e.editor.windowManager.close(),t()}}(this)},{text:"Cancel",onclick:function(t){return function(){return t.editor.windowManager.close()}}(this)}]}):t()},t.prototype.tellDialog=function(){var t,e,n,o,i;for(t=1<=arguments.length?F.call(arguments,0):[],n=document.getElementsByTagName("iframe"),o=0,i=n.length;i>o;o++)if(e=n[o],"filedialog/filedialog.html"===e.getAttribute("src"))return e.contentWindow.postMessage(t,"*")},t.prototype.manageFiles=function(){return this.editor.windowManager.open({title:"Manage files",url:"filedialog/filedialog.html",width:700,height:500,buttons:[{text:"New folder",onclick:function(t){return function(){return t.tellDialog("buttonClicked","New folder")}}(this)},{text:"Done",onclick:function(t){return function(){return t.editor.windowManager.close()}}(this)}]},{fsName:this.fileSystem,mode:"manage files"})},t.prototype.installOpenHandler=function(t){return this.replaceInternalHandler("tryToOpen",t)},t.prototype.installSaveHandler=function(t){return this.replaceInternalHandler("tryToSave",t)},t.prototype.installManageFilesHandler=function(t){return this.replaceInternalHandler("manageFiles",t)},t.prototype.replaceInternalHandler=function(t,e){var n,o;return null!=e?(null==(n=null!=this.handlerBackups?this.handlerBackups:this.handlerBackups={})[t]&&(n[t]=this[t]),this[t]=e):null!=(null!=(o=this.handlerBackups)?o[t]:void 0)?this[t]=this.handlerBackups[t]:void 0},t}(),tinymce.PluginManager.add("loadsave",function(t,e){return t.LoadSave=new s(t)}),window.onmessage=function(t){var e,n,o,i,r;for(e=""+t.data[0]+"Handler",r=s.prototype.instances,o=0,i=r.length;i>o;o++)if(n=r[o],n.hasOwnProperty(e))return n[e].apply(null,t.data.slice(1))},window.setAppName=function(t){return null==t&&(t=null),s.prototype.appName=t},c=null,R=function(t){return c.indexURL=t},m=function(){return c.indexURL},E=function(t){return c.APIURL=t},g=function(){return c.APIURL},window.embedMetadata=d=function(t,e){var n;return null==e&&(e={}),n=encodeURIComponent(JSON.stringify(e)),"<span id='metadata' style='display: none;' >"+n+"</span>"+t},window.extractMetadata=h=function(t){var e,n;return n=/^<span[^>]+id=.metadata.[^>]*>([^<]*)<\/span>/,(e=n.exec(t))?{metadata:JSON.parse(decodeURIComponent(e[1])),document:t.slice(e[0].length)}:{metadata:null,document:t}},v=function(t,e,n){var o;return o=new XMLHttpRequest,o.addEventListener("load",function(){var t,o,i,r;i=this.responseText;try{r=JSON.parse(i)}catch(s){return o=s,void n(null,"Invalid response format.\nShould be JSON:\n"+i)}try{t=r.query.pages[0].revisions[0][e]}catch(s){return o=s,void n(null,"No such page on wiki.\nRaw reply:\n"+i)}return n(t,null)}),o.open("GET",c.MediaWiki.getAPIPage()+"?action=query&titles="+encodeURIComponent(t)+"&prop=revisions&rvprop="+e+"&rvparse&format=json&formatversion=2"),o.setRequestHeader("Api-User-Agent","webLurch application"),o.send()},y=function(t,e){return v(t,"content",e)},b=function(t,e){return v(t,"timestamp",e)},I=function(t,e){return c.MediaWiki.getPageContent(t,function(t,n){var o,i,r;return n&&(c.Dialogs.alert({title:"Wiki Error",message:"<p>Error loading content from wiki:</p> <p>"+n.split("\n")[0]+"</p>"}),console.log(n),"function"==typeof e&&e(!1)),r=h(t),i=r.metadata,o=r.document,null==i&&(c.Dialogs.alert({title:"Not a Lurch document",message:"<p><b>The wiki page that you attempted to import is not a Lurch document.</b></p> <p>Although it is possible to import any wiki page into Lurch, it does not work well to edit and re-post such pages to the wiki.</p> <p>To edit a non-Lurch wiki page, visit the page on the wiki and edit it there.</p>"}),"function"==typeof e&&e(!1)),c.setContent(o),"function"==typeof e?e(o,i):void 0})},w=function(t,e){return c.MediaWiki.getPageContent(t,function(t,n){return"function"==typeof e?e(n?null:h(t).metadata):void 0})},T=function(t,e,n,o){var i,r;return r=new XMLHttpRequest,r.addEventListener("load",function(){var o,i,r,s,l,u;i=this.responseText;try{r=JSON.parse(i)}catch(a){return o=a,void n(null,"Invalid JSON response: "+i)}return"Success"===(null!=r&&null!=(s=r.login)?s.result:void 0)?n(!0,null):"NeedToken"===(null!=r&&null!=(l=r.login)?l.result:void 0)?c.MediaWiki.login(t,e,n,r.login.token):n(null,"Login error of type "+(null!=r&&null!=(u=r.login)?u.result:void 0))}),i=c.MediaWiki.getAPIPage()+"?action=login&lgname="+encodeURIComponent(t)+"&lgpassword="+encodeURIComponent(e)+"&format=json&formatversion=2",o&&(i+="&lgtoken="+o),r.open("POST",i),r.setRequestHeader("Api-User-Agent","webLurch application"),r.send()},p=function(t,e,n){var o;return o=new XMLHttpRequest,o.addEventListener("load",function(){var o,i,r,s,l,u,a;i=this.responseText;try{r=JSON.parse(i)}catch(d){return o=d,void n(null,"Invalid JSON response: "+i)}return(null!=r&&null!=(u=r.query)&&null!=(a=u.tokens)?a.csrftoken:void 0)?(l=new XMLHttpRequest,l.addEventListener("load",function(){var t;i=this.responseText;try{r=JSON.parse(i)}catch(e){return o=e,void n(null,"Invalid JSON response: "+i)}return"Success"!==(null!=r&&null!=(t=r.edit)?t.result:void 0)?void n(null,"Edit failed: "+i):n("Success",null)}),e=f(e),l.open("POST",c.MediaWiki.getAPIPage()+"?action=edit&title="+encodeURIComponent(t)+"&text="+encodeURIComponent(e)+"&summary="+encodeURIComponent("posted from Lurch")+"&contentformat="+encodeURIComponent("text/x-wiki")+"&contentmodel="+encodeURIComponent("wikitext")+"&format=json&formatversion=2",!0),s="token="+encodeURIComponent(r.query.tokens.csrftoken),l.setRequestHeader("Content-type","application/x-www-form-urlencoded"),l.setRequestHeader("Api-User-Agent","webLurch application"),l.send(s)):void n(null,"No token provided: "+i)}),o.open("GET",c.MediaWiki.getAPIPage()+"?action=query&meta=tokens&format=json&formatversion=2"),o.setRequestHeader("Api-User-Agent","webLurch application"),o.send()},f=function(t){var e,n,o,i,r,s,l,u,a;for(l="",i=0,s=/^<([^ >]+)\s*([^>]+)?>/i,n=/^<\/([^ >]+)\s*>/i,e=/^&([a-z0-9]+|#[0-9]+);/i,a=["img","span","var","sup"],o=document.createElement("div");t.length>0;)(r=n.exec(t))?(u=r[1].toLowerCase(),G.call(a,u)>=0?(i--,l+="</htmltag"+i+">"):l+=r[0],t=t.slice(r[0].length)):(r=s.exec(t))?(u=r[1].toLowerCase(),G.call(a,u)>=0?(l+="<htmltag"+i+" tagname='"+u+"' "+r[2]+">",/\/\s*$/.test(r[2])||i++):l+=r[0],t=t.slice(r[0].length)):(r=e.exec(t))?(o.innerHTML=r[0],l+=o.textContent,t=t.slice(r[0].length)):(l+=t[0],t=t.slice(1));return l},tinymce.PluginManager.add("mediawiki",function(t,e){return(c=t).MediaWiki={setIndexPage:R,getIndexPage:m,setAPIPage:E,getAPIPage:g,login:T,getPageContent:y,getPageTimestamp:b,importPage:I,exportPage:p,embedMetadata:d,extractMetadata:h,getPageMetadata:w}}),l=function(){function t(t){this.editor=t,this.redrawContents=B(this.redrawContents,this),this.editor.on("init",function(t){return function(){return t.container=t.editor.getContentAreaContainer(),t.canvas=document.createElement("canvas"),$(t.container).after(t.canvas),t.canvas.style.position="absolute",t.canvas.style["background-color"]="rgba(0,0,0,0)",t.canvas.style["pointer-events"]="none",t.canvas.style["z-index"]="10"}}(this)),this.drawHandlers=[],this.editor.on("NodeChange",this.redrawContents),$(this.editor.getContentAreaContainer()).resize(this.redrawContent)}return t.prototype.redrawContents=function(t){var e,n,o,i,r,s,l,u;if(this.positionCanvas(),e=null!=(s=this.canvas)?s.getContext("2d"):void 0){for(this.clearCanvas(e),e.translate(0,$(this.container).position().top),l=this.drawHandlers,u=[],i=0,r=l.length;r>i;i++){n=l[i];try{u.push(n(this.canvas,e))}catch(a){o=a,u.push(console.log("Error in overlay draw function: "+o.stack))}}return u}},t.prototype.addDrawHandler=function(t){return this.drawHandlers.push(t)},t.prototype.getEditorFrame=function(){var t,e,n,o;for(o=window.frames,
e=0,n=o.length;n>e;e++)if(t=o[e],t.document===this.editor.getDoc())return t;return null},t.prototype.positionCanvas=function(){var t,e;return e=$(this.container),t=$(this.canvas),null!=e.position()?(t.css("top",0),t.css("left",e.position().left),t.width(e.width()),t.height(e.position().top+e.height()),this.canvas.width=t.width(),this.canvas.height=t.height()):void 0},t.prototype.clearCanvas=function(t){return t.clearRect(0,0,this.canvas.width,this.canvas.height)},t}(),tinymce.PluginManager.add("overlay",function(t,e){return t.Overlay=new l(t),t.on("init",function(e){return $(t.getWin()).scroll(function(){return t.Overlay.redrawContents()})})}),O={},O.addCategory=function(t){return O[t]={get:function(t){return window.localStorage.getItem(t)},set:function(t,e){return window.localStorage.setItem(t,e)},setup:function(t){return null},teardown:function(t){return null},showUI:function(){return O.showUI(t)}}},O.showUI=function(t){var e,n,o,i;return o=null,e=[{type:"button",text:"Cancel",onclick:function(t){return tinymce.activeEditor.windowManager.close()}},{type:"button",text:"Save",subtype:"primary",onclick:function(e){return O[t].teardown(o),tinymce.activeEditor.windowManager.close()}}],n=t[0].toUpperCase()+t.slice(1).toLowerCase()+" Settings",tinymce.activeEditor.windowManager.open({title:n,url:"about:blank",width:500,height:400,buttons:e}),i=tinymce.activeEditor.windowManager.windows,o=i[i.length-1].getEl().getElementsByClassName("mce-container-body")[0],o.innerHTML="",O[t].setup(o)},O.UI={},O.UI.info=function(t,e){return O.UI.tr("<td style='width: 100%; text-align: center; white-space: normal;' >"+t+"</td>",e)},O.UI.heading=function(t,e){return O.UI.info("<hr style='border: 1px solid black;'> <span style='font-size: 20px;'>"+t+"</span> <hr style='border: 1px solid black;'>",e)},O.UI.readOnly=function(t,e,n){return O.UI.tpair(t,e,n)},O.UI.text=function(t,e,n){return O.UI.tpair(t,"<input type='text' id='"+e+"' value='"+n+"' style='border-width: 2px; border-style: inset;'/>")},O.UI.password=function(t,e,n){return O.UI.tpair(t,"<input type='password' id='"+e+"' value='"+n+"' style='border-width: 2px; border-style: inset;'/>")},O.UI.checkbox=function(t,e,n,o){var i;return null==e&&(e=!1),e=e?" checked":"",i=O.UI.generalPair("<input type='checkbox' id='"+n+"' "+e+"/>","<b>"+t+"</b>",null,10),o&&(i+=O.UI.generalPair("","<p>"+o+"</p>",null,10)),i},O.UI.radioButton=function(t,e,n,o,i){var r;return null==n&&(n=!1),n=n?" checked":"",r=O.UI.generalPair("<input type='radio' name='"+e+"' id='"+o+"' "+n+"/>","<b>"+t+"</b>",null,10),i&&(r+=O.UI.generalPair("","<p>"+i+"</p>",null,10)),r},O.UI.button=function(t,e){return"<input type='button' "+(null!=e?" id='"+e+"'":"")+" value='"+t+"' style='border: 1px solid #999999; background: #dddddd; padding: 2px; margin: 2px;' onmouseover='this.style.background=\"#eeeeee\";' onmouseout='this.style.background=\"#dddddd\";'/>"},O.UI.tr=function(t,e){return"<table border=0 cellpadding=0 cellspacing=10 style='width: 100%;' "+(null!=e?" id='"+e+"'":"")+"> <tr style='width: 100%; vertical-align: middle;'>"+t+"</tr></table>"},O.UI.tpair=function(t,e,n){return O.UI.tr("<td style='width: 50%; text-align: right; vertical-align: middle;'><b>"+t+":</b></td> <td style='width: 50%; text-align: left; vertical-align: middle;'>"+e+"</td>",n)},O.UI.generalPair=function(t,e,n,o,i){return null==i&&(i="left"),O.UI.tr("<td style='width: "+o+"%; text-align: "+i+"; vertical-align: middle;'>"+t+"</td> <td style='width: "+(100-o)+"%; text-align: left; vertical-align: middle;'>"+e+"</td>",n)},tinymce.PluginManager.add("settings",function(t,e){return t.Settings=O}),setAppName("Untitled"),null==window.groupTypes&&(window.groupTypes=[{name:"example",text:"Example group",imageHTML:"[",openImageHTML:"]",closeImageHTML:"[]",tooltip:"Wrap text in a group",color:"#666666"}]),null==window.groupToolbarButtons&&(window.groupToolbarButtons={}),null==window.groupMenuItems&&(window.groupMenuItems={}),null==window.pluginsToLoad&&(window.pluginsToLoad=[]),window.fullScreenEditor=!0,window.editorContainer=null,null==window.menuBarIcon&&(window.menuBarIcon={}),null==window.defaultEditorStyles&&(window.defaultEditorStyles={fontSize:"16px",fontFamily:"Verdana, Arial, Helvetica, sans-serif"}),null==window.helpAboutText&&(window.helpAboutText="webLurch\n\nalpha\n\nnot yet intended for non-developer use"),$(function(){var t,e,n;return c=document.createElement("textarea"),c.setAttribute("id","editor"),null==window.editorContainer&&(window.editorContainer=document.body),"function"==typeof window.editorContainer&&(window.editorContainer=window.editorContainer()),window.editorContainer.appendChild(c),A(),t=function(){var t,e,o;for(o=[],t=0,e=groupTypes.length;e>t;t++)n=groupTypes[t],o.push(n.name);return o}(),tinymce.init({selector:"#editor",auto_focus:"editor",branding:!1,browser_spellcheck:!0,gecko_spellcheck:!0,statusbar:!1,paste_data_images:!0,plugins:"advlist table charmap colorpicker image link paste print searchreplace textcolor -loadsave -overlay -groups -equationeditor -dependencies -dialogs -downloadupload "+function(){var t,n,o,i;for(o=window.pluginsToLoad,i=[],t=0,n=o.length;n>t;t++)e=o[t],i.push("-"+e);return i}().join(" ")+(window.fullScreenEditor?" fullscreen":""),object_resizing:":not(img.grouper)",toolbar:["newfile openfile savefile managefiles | print | undo redo | cut copy paste | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent blockquote | table","fontselect fontsizeselect styleselect | bold italic underline textcolor subscript superscript removeformat | link unlink | charmap image | spellchecker searchreplace | equationeditor | "+t.join(" ")+" connect"+D()],fontsize_formats:"8pt 10pt 12pt 14pt 18pt 24pt 36pt",style_formats_merge:!0,style_formats:[{title:"Grading",items:[{title:"Red highlighter",inline:"span",styles:{"border-radius":"5px",padding:"2px 5px",margin:"0 2px",color:"#770000","background-color":"#ffaaaa"}},{title:"Yellow highlighter",inline:"span",styles:{"border-radius":"5px",padding:"2px 5px",margin:"0 2px",color:"#777700","background-color":"#ffffaa"}},{title:"Green highlighter",inline:"span",styles:{"border-radius":"5px",padding:"2px 5px",margin:"0 2px",color:"#007700","background-color":"#aaffaa"}},{title:"No highlighting",inline:"span",exact:!0}]}],menu:{file:{title:"File",items:"newfile openfile | savefile saveas download upload | managefiles | print"+N("file")},edit:{title:"Edit",items:"undo redo | cut copy paste pastetext | selectall"+N("edit")},insert:{title:"Insert",items:"link media | template hr | me"+N("insert")},view:{title:"View",items:"visualaid hideshowgroups"+N("view")},format:{title:"Format",items:"bold italic underline strikethrough superscript subscript | formats | removeformat"+N("format")},table:{title:"Table",items:"inserttable tableprops deletetable | cell row column"+N("table")},help:{title:"Help",items:"about tour website"+N("help")}},contextmenu:"link image inserttable | cell row column deletetable"+N("contextmenu"),groupTypes:groupTypes,setup:function(t){var e,n,o,i;M(t),t.addMenuItem("about",{text:"About...",context:"help",onclick:function(){return t.Dialogs.alert({title:"webLurch",message:"undefined"!=typeof helpAboutText&&null!==helpAboutText?helpAboutText:""})}}),t.addMenuItem("tour",{text:"Take a tour",context:"help",onclick:function(){var t,e,n;return t=function(t){var e,n,o,i,r;for(o=function(t,e){return t.trim().toLowerCase()===e.trim().toLowerCase()},n=document.getElementsByClassName("mce-menubtn"),i=0,r=n.length;r>i;i++)if(e=n[i],o(e.textContent,t))return e;return null},e=function(t){return document.getElementsByClassName("mce-i-"+t)[0]},n=new Tour({storage:!1,steps:[{element:t("edit"),title:"Edit menu",content:"This tour is just an example for now.  Obviously you already knew where the edit menu was."},{element:e("table"),title:"Table maker",content:"Yes, you can make tables, too! Okay, that's enough of a fake tour. We'll add a real tour to the application later."}]}),n.init(),n.start()}}),t.addMenuItem("website",{text:"Documentation",context:"help",onclick:function(){return window.open("http://nathancarter.github.io/weblurch","_blank")}}),o=window.groupMenuItems;for(n in o)U.call(o,n)&&(e=o[n],t.addMenuItem(n,e));i=window.groupToolbarButtons;for(n in i)U.call(i,n)&&(e=i[n],t.addButton(n,e));return t.on("init",function(){var e,n,o,i,r,s;installDOMUtilitiesIn(t.getWin()),r=window.defaultEditorStyles;for(o in r)U.call(r,o)&&(i=r[o],t.getBody().style[o]=i);return setTimeout(function(){return t.execCommand("mceFullScreen")},0),t.dom.loadCSS("./eqed/mathquill.css"),null!=(null!=(s=window.menuBarIcon)?s.src:void 0)&&(e=t.getContainer().getElementsByClassName("mce-menubtn")[0],n=document.createElement("img"),n.setAttribute("src",window.menuBarIcon.src),n.style.width=window.menuBarIcon.width,n.style.height=window.menuBarIcon.height,n.style.padding=window.menuBarIcon.padding,e.insertBefore(n,e.childNodes[0])),t.getBody().addEventListener("focus",function(){return 0!==t.windowManager.getWindows().length?t.windowManager.close():void 0}),t.on("KeyDown",function(e){return 9===e.keyCode?(e.preventDefault(),t.insertContent("&emsp;")):void 0}),window.addEventListener("beforeunload",function(e){return t.LoadSave.documentDirty?(e.returnValue="You have unsaved changes.",e.returnValue):void 0}),"function"==typeof window.afterEditorReady?window.afterEditorReady(t):void 0})}})}),N=function(t){var e,n;return n=window.groupMenuItems.hasOwnProperty(""+t+"_order")?window.groupMenuItems[""+t+"_order"]:function(){var n,o,i,r;for(i=Object.keys(window.groupMenuItems),r=[],n=0,o=i.length;o>n;n++)e=i[n],window.groupMenuItems[e].context===t&&r.push(e);return r}().join(" "),n.length&&"| "!==n.slice(0,2)?"| "+n:""},D=function(){var t,e;return t=(null!=(e=window.groupToolbarButtons.order)?e:Object.keys(window.groupToolbarButtons)).join(" "),window.useGroupConnectionsUI&&(t="connect "+t),t.length&&"| "!==t.slice(0,2)?"| "+t:""},window.addHelpMenuSourceCodeLink=function(t){var e;return null==window.groupMenuItems&&(window.groupMenuItems={}),window.groupMenuItems.sourcecode={text:"View documented source code",context:"help",onclick:function(){return window.location.href="http://github.com/nathancarter/weblurch/blob/master/"+t}},window.groupMenuItems.tutorial={text:"View developer tutorial",context:"help",onclick:function(){return window.location.href="http://github.com/nathancarter/weblurch/blob/master/doc/tutorial.md"}},e=function(t,n,o){return t--<=0?void 0:o.fadeOut(n).fadeIn(n,function(){return e(t,n,o)})},setTimeout(function(){return e(3,500,$(".mce-menubtn").filter(function(t,e){return"Help"===e.textContent.trim()}))},1e3)},window.showUndoStack=function(){var t,e,n,o,i,r,s,l,u;for(i=tinymce.activeEditor.undoManager,console.log("entry 0: document initial state"),u=[],n=s=1,l=i.data.length;l>=1?l>s:s>l;n=l>=1?++s:--s)if(r=i.data[n-1].content,t=i.data[n].content,r!==t){for(o=e=0;r.slice(0,+o+1||9e9)===t.slice(0,+o+1||9e9);)o++;for(;r.slice(r.length-e)===t.slice(t.length-e);)e++;u.push(console.log("entry "+n+": at "+o+": \n	orig: "+r.slice(o,+(r.length-e)+1||9e9)+" \n	now:  "+t.slice(o,+(t.length-e)+1||9e9)))}else console.log("entry "+n+": same as "+(n-1));return u},A=function(){var t,e,n;return"?test"===location.search?(n=open("./testrecorder.html","recording","status=no, location=no, toolbar=no, menubar=no, left="+(window.screenX+$(window).width())+", top="+window.screenY+", width=400, height=600"),n||alert("You have asked to run webLurch in test-recording mode, which requires a popup window.  Your browser has blocked the popup window.  Change its settings or allow this popup to use test-recording mode."),e=[],(t=function(){var o,i,r,s,l,u,a,c,d,p,h,f;s=function(t){return alert("You "+t+", which the test recorder does not yet support.  The current test has therefore become corrupted, and you should reload this page and start your test again.  You will need to limit yourself to using only supported keys, menu items, and mouse operations.")};try{if(G.call(e,"keypress")<0&&(tinymce.activeEditor.on("keypress",function(t){var e;return e=String.fromCharCode(t.keyCode),/[A-Za-z0-9 ]/.test(e)?n.editorKeyPress(t.keyCode,t.shiftKey,t.ctrlKey,t.altKey):s("pressed the key with code "+t.keyCode)}),e.push("keypress")),G.call(e,"keyup")<0&&(tinymce.activeEditor.on("keyup",function(t){var e,o,i,r;return i=String.fromCharCode(t.keyCode),/[A-Za-z0-9 ]/.test(i)||(o=[16,17,18,91],r=t.keyCode,G.call(o,r)>=0)?void 0:(e={8:"backspace",13:"enter",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",46:"delete"},e.hasOwnProperty(t.keyCode)?n.editorKeyPress(e[t.keyCode],t.shiftKey,t.ctrlKey,t.altKey):s("pressed the key with code "+t.keyCode))}),e.push("keyup")),G.call(e,"click")<0&&(tinymce.activeEditor.on("click",function(t){return t.shiftKey?s("shift-clicked"):t.ctrlKey?s("ctrl-clicked"):t.altKey?s("alt-clicked"):n.editorMouseClick(t.clientX,t.clientY)}),e.push("click")),r=function(t){return Array.prototype.slice.apply(tinymce.activeEditor.theme.panel.find(t))},G.call(e,"buttons")<0){for(h=r("button"),u=function(t){return t.on("click",function(){return n.buttonClicked(t.settings.icon)})},a=0,d=h.length;d>a;a++)o=h[a],u(o);e.push("buttons")}for(f=F.call(r("splitbutton")).concat(F.call(r("listbox")),F.call(r("menubutton"))),c=0,p=f.length;p>c;c++)l=f[c],l.disabled(!0);return n.enterReadyState()}catch(g){return i=g,setTimeout(t,100)}})()):void 0}}).call(this);
//# sourceMappingURL=app.min.js.map